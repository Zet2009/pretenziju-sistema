<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fail≈≥ Katalogas - Rubineta</title>
    <style>
        :root {
            --primary: #4e5152;
            --primary-light: #4A4A4A;
            --secondary: #FFCC00;
            --light: #F5F5F5;
            --white: #FFFFFF;
            --dark: #234d77;
            --gray: #75757d;
            --font: 'Roboto', sans-serif;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: var(--font);
            background: var(--light);
            color: var(--dark);
            line-height: 1.3;
            font-size: 12px;
        }
        
        header {
            background: var(--white);
            padding: 10px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo { 
            height: 50px; 
            cursor: pointer; 
        }
        
        nav a {
            margin: 0 15px;
            text-decoration: none;
            color: var(--dark);
            font-weight: 200;
            font-size: 14px;
        }
        
        main {
            max-width: 1800px;
            margin: 10px auto;
            padding: 10px;
        }
        
        h1 { 
            color: var(--primary); 
            margin-bottom: 15px; 
            font-size: 16px; 
            text-align: center; 
        }
        
        .upload-section {
            background: var(--white);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .btn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .file-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: var(--white);
        }
        
        .file-preview {
            width: 100%;
            height: 150px;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .file-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .file-name {
            font-weight: bold;
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .file-meta {
            font-size: 0.8em;
            color: var(--gray);
            margin-bottom: 10px;
        }
        
        .file-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .file-actions .btn {
            padding: 5px 10px;
            font-size: 11px;
            flex: 1;
        }
        
        .message {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<header>
    <img src="logo.jpg" alt="Rubineta Logo" class="logo" onclick="location.href='index.html'">
    <nav>
        <a href="index.html">Pagrindinis</a>
        <a href="admin.html">Admin</a>
        <a href="catalog-table.html" style="font-weight: bold;">Fail≈≥ Katalogas</a>
    </nav>
</header>

<main>
    <h1>üìÅ Fail≈≥ Katalogas - Cloudinary</h1>
    
    <div class="upload-section">
        <h2>üì§ ƒÆkelti failus ƒØ Cloudinary</h2>
        
        <div id="upload-message"></div>
        
        <form id="upload-form">
            <div class="form-group">
                <label for="file-input">Pasirinkite failƒÖ:</label>
                <input type="file" id="file-input" required>
            </div>
            
            <div class="form-group">
                <label for="claim-id">Pretenzijos ID (neprivaloma):</label>
                <input type="text" id="claim-id" placeholder="PVZ., PR-25-001">
            </div>
            
            <div class="form-group">
                <label for="file-description">Apra≈°ymas (neprivaloma):</label>
                <input type="text" id="file-description" placeholder="Trumpas failo apra≈°ymas...">
            </div>
            
            <button type="submit" class="btn" id="upload-btn">
                üöÄ ƒÆkelti failƒÖ
            </button>
        </form>
    </div>

    <div id="upload-results"></div>
    
    <h2>üìÇ Visi ƒØkelti failai</h2>
    
    <div class="form-group">
        <input type="text" id="search-files" placeholder="üîç Ie≈°koti fail≈≥..." style="width: 100%;">
    </div>
    
    <div id="files-grid" class="files-grid">
        <!-- Failai bus ƒØkelti ƒçia -->
    </div>
</main>

<script>
// =================== KONFIG≈™RACIJA ===================
const CLOUDINARY_CONFIG = {
    cloudName: 'dtiiwo2bp',      // J≈´s≈≥ Cloudinary cloud name
    uploadPreset: 'r6wao0fr'     // J≈´s≈≥ upload preset
};

// =================== GLOBAL≈™S KINTAMIEJIAI ===================
let cloudinaryFiles = JSON.parse(localStorage.getItem('cloudinaryFiles')) || [];

// =================== FAIL≈≤ ƒÆKƒñLIMAS ===================
document.getElementById('upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('file-input');
    const claimId = document.getElementById('claim-id').value.trim();
    const description = document.getElementById('file-description').value.trim();
    const uploadBtn = document.getElementById('upload-btn');
    const messageDiv = document.getElementById('upload-message');
    
    if (!fileInput.files[0]) {
        showMessage('‚ùå Pasirinkite failƒÖ!', 'error', messageDiv);
        return;
    }
    
    const file = fileInput.files[0];
    
    // Patikrinti failo dydƒØ (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
        showMessage('‚ùå Failas per didelis. Maksimalus dydis: 10MB', 'error', messageDiv);
        return;
    }
    
    // Rodyti ƒØkƒólimo b≈´senƒÖ
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<div class="loading"></div> ƒÆkeliama...';
    
    try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_CONFIG.uploadPreset);
        
        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CONFIG.cloudName}/upload`, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP klaida! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        // Sukurti failo objektƒÖ
        const fileData = {
            id: result.public_id,
            url: result.secure_url,
            originalName: file.name,
            format: result.format,
            size: result.bytes,
            width: result.width,
            height: result.height,
            uploadedAt: new Date().toISOString(),
            resourceType: result.resource_type,
            claimId: claimId,
            description: description
        };
        
        // ƒÆra≈°yti ƒØ localStorage
        cloudinaryFiles.unshift(fileData);
        localStorage.setItem('cloudinaryFiles', JSON.stringify(cloudinaryFiles));
        
        // Rodyti sƒókmƒós prane≈°imƒÖ
        showMessage('‚úÖ Failas sƒókmingai ƒØkeltas!', 'success', messageDiv);
        showUploadResult(fileData);
        
        // I≈°valyti formƒÖ
        document.getElementById('upload-form').reset();
        
        // Atnaujinti fail≈≥ sƒÖra≈°ƒÖ
        loadAllFiles();
        
    } catch (error) {
        console.error('ƒÆkƒólimo klaida:', error);
        showMessage(`‚ùå ƒÆkƒólimo klaida: ${error.message}`, 'error', messageDiv);
    } finally {
        // Atstatyti mygtukƒÖ
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'üöÄ ƒÆkelti failƒÖ';
    }
});

// =================== FAIL≈≤ RODYMAS ===================
function loadAllFiles() {
    const filesContainer = document.getElementById('files-grid');
    const searchTerm = document.getElementById('search-files').value.toLowerCase();
    
    let filteredFiles = cloudinaryFiles;
    
    // Filtruoti pagal paie≈°kos terminƒÖ
    if (searchTerm) {
        filteredFiles = cloudinaryFiles.filter(file => 
            file.originalName.toLowerCase().includes(searchTerm) ||
            (file.claimId && file.claimId.toLowerCase().includes(searchTerm)) ||
            (file.description && file.description.toLowerCase().includes(searchTerm))
        );
    }
    
    if (filteredFiles.length === 0) {
        filesContainer.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                ${searchTerm ? 'Nerasta fail≈≥ pagal paie≈°kƒÖ' : 'Dar nƒóra ƒØkelt≈≥ fail≈≥'}
            </div>
        `;
        return;
    }
    
    filesContainer.innerHTML = filteredFiles.map(file => `
        <div class="file-card">
            <div class="file-preview">
                ${file.resourceType === 'image' ? 
                    `<img src="${file.url}" alt="${file.originalName}" loading="lazy">` : 
                    `<div style="font-size: 2em;">${getFileIcon(file.resourceType, file.format)}</div>`
                }
            </div>
            <div class="file-name">${escapeHtml(file.originalName)}</div>
            <div class="file-meta">
                ${formatFileSize(file.size)} ‚Ä¢ ${file.format.toUpperCase()}<br>
                ${new Date(file.uploadedAt).toLocaleDateString('lt-LT')}<br>
                ${file.claimId ? `<strong>Pretenzija:</strong> ${file.claimId}<br>` : ''}
                ${file.description ? `<em>${escapeHtml(file.description)}</em>` : ''}
            </div>
            <div class="file-actions">
                <button class="btn" onclick="copyLink('${file.id}')">üìã Nuoroda</button>
                <button class="btn" onclick="viewFile('${file.id}')">üëÄ Per≈æi≈´rƒóti</button>
                <button class="btn" onclick="deleteFile('${file.id}')" style="background: #dc3545;">üóëÔ∏è Trinti</button>
            </div>
        </div>
    `).join('');
}

// =================== PAGALBINƒñS FUNKCIJOS ===================
function showUploadResult(fileData) {
    const resultsContainer = document.getElementById('upload-results');
    const fileElement = document.createElement('div');
    fileElement.className = 'file-card';
    fileElement.innerHTML = `
        <div class="file-preview">
            ${fileData.resourceType === 'image' ? 
                `<img src="${fileData.url}" alt="${fileData.originalName}">` : 
                `<div style="font-size: 2em;">${getFileIcon(fileData.resourceType, fileData.format)}</div>`
            }
        </div>
        <div class="file-name">${escapeHtml(fileData.originalName)}</div>
        <div class="file-meta">
            ${formatFileSize(fileData.size)} ‚Ä¢ ${fileData.format.toUpperCase()}
            ${fileData.claimId ? `<br><strong>Pretenzija:</strong> ${fileData.claimId}` : ''}
        </div>
        <div class="file-actions">
            <button class="btn" onclick="copyLink('${fileData.id}')">üìã Nuoroda</button>
            <button class="btn" onclick="viewFile('${fileData.id}')">üëÄ Per≈æi≈´rƒóti</button>
        </div>
    `;
    
    resultsContainer.appendChild(fileElement);
}

function getFileIcon(resourceType, format) {
    if (resourceType === 'image') return 'üñºÔ∏è';
    if (resourceType === 'video') return 'üé¨';
    if (format === 'pdf') return 'üìï';
    if (['doc', 'docx'].includes(format)) return 'üìù';
    if (['xls', 'xlsx'].includes(format)) return 'üìä';
    if (['zip', 'rar'].includes(format)) return 'üì¶';
    return 'üìÑ';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function copyLink(fileId) {
    const file = cloudinaryFiles.find(f => f.id === fileId);
    if (file) {
        navigator.clipboard.writeText(file.url).then(() => {
            showMessage('‚úÖ Nuoroda nukopijuota!', 'success', 'upload-message');
        }).catch(err => {
            // Atsarginis b≈´das
            const textArea = document.createElement('textarea');
            textArea.value = file.url;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showMessage('‚úÖ Nuoroda nukopijuota!', 'success', 'upload-message');
        });
    }
}

function viewFile(fileId) {
    const file = cloudinaryFiles.find(f => f.id === fileId);
    if (file) {
        window.open(file.url, '_blank');
    }
}

function deleteFile(fileId) {
    if (!confirm('Ar tikrai norite i≈°trinti ≈°ƒØ failƒÖ?')) return;
    
    cloudinaryFiles = cloudinaryFiles.filter(f => f.id !== fileId);
    localStorage.setItem('cloudinaryFiles', JSON.stringify(cloudinaryFiles));
    loadAllFiles();
    showMessage('‚úÖ Failas i≈°trintas!', 'success', 'upload-message');
}

function showMessage(text, type, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = `<div class="message ${type}">${text}</div>`;
    setTimeout(() => container.innerHTML = '', 5000);
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// =================== INICIALIZACIJA ===================
document.addEventListener('DOMContentLoaded', function() {
    loadAllFiles();
    
    // Paie≈°kos funkcionalumas
    document.getElementById('search-files').addEventListener('input', loadAllFiles);
    
    // Pridƒóti testini≈≥ fail≈≥, jei nƒóra
    if (cloudinaryFiles.length === 0) {
        console.log('Nƒóra ƒØkelt≈≥ fail≈≥. Sistema pasiruo≈°usi.');
    }
});
</script>
</body>
</html>
