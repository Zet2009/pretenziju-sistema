<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administratoriaus zona ‚Äì Rubineta</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4e5152;
            --primary-light: #4A4A4A;
            --secondary: #FFCC00;
            --light: #F5F5F5;
            --white: #FFFFFF;
            --dark: #234d77;
            --gray: #75757d;
            --font: 'Roboto', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font);
            background: var(--light);
            color: var(--dark);
            line-height: 1.3;
            font-size: 12px;
        }
        header {
            background: var(--white);
            padding: 10px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { height: 50px; cursor: pointer; }
        nav a {
            margin: 0 15px;
            text-decoration: none;
            color: var(--dark);
            font-weight: 200;
            font-size: 14px;
        }
        main {
            max-width: 1800px;
            margin: 10px auto;
            padding: 10px;
        }
        h1 { color: var(--primary); margin-bottom: 15px; font-size: 16px; text-align: center; }

        /* Skirtukai */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .tab {
            padding: 8px 16px;
            background: #e9ecef;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
        }
        .tab:hover { background: #dee2e6; }
        .tab.active {
            background: var(--primary);
            color: var(--white);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .inline-filter {
            width: 100%;
            padding: 3px;
            margin-top: 4px;
            font-size: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        /* Statistika */
        .stats-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 11px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.08);
        }
        .stat-item { display: flex; flex-direction: column; align-items: center; min-width: 120px; text-align: center; }
        .stat-item .label { color: var(--gray); font-weight: 500; font-size: 10px; white-space: nowrap; }
        .stat-item .value { color: var(--primary); font-weight: bold; font-size: 13px; }

        /* Filtrai */
        .filters {
            background: var(--white);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 11px;
        }

        table { width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); table-layout: fixed; font-size: 11px; }
        th, td { padding: 6px 8px; text-align: left; border-bottom: 1px solid #dee2e6; word-wrap: break-word; }
        th { background: var(--primary); color: var(--white); font-weight: 500; font-size: 10px; }
        tr:hover { background: #f8f9fa; }

        /* Spalvotas b≈´senos dropdown'as */
        .status-dropdown { width: 100%; padding: 4px; font-size: 11px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .status-dropdown.status-new { background: #f8d7da; color: #721c24; border-color: #f1b0b7; }
        .status-dropdown.status-pending { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .status-dropdown.status-approved { background: #d4edff; color: #004085; border-color: #b8daff; }
        .status-dropdown.status-sent { background: #17a2b8; color: white; border-color: #138496; }
        .status-dropdown.status-resolved { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-dropdown.status-rejected { background: #e9ecef; color: #495057; border-color: #ced4da; }

        /* Modaliniai langai */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: var(--white); padding: 20px; border-radius: 10px; width: 90%; max-width: 700px; box-shadow: 0 4px 30px rgba(0,0,0,0.3); font-size: 11px; position: relative; }
        .close { color: var(--gray); float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: var(--dark); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); font-size: 12px; }
        .form-group textarea, .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 11px; }
        .comment-box button { margin-top: 10px; padding: 10px 16px; background: var(--primary-light); color: var(--white); border: none; border-radius: 6px; cursor: pointer; }

        footer { text-align: center; margin-top: 40px; color: var(--gray); font-size: 12px; border-top: 1px solid #dee2e6; padding-top: 20px; background: var(--secondary); }

        /* Puslapiavimas */
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 10px; background: var(--white); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .pagination-info { font-size: 12px; color: var(--gray); }
        .pagination-buttons { display: flex; gap: 10px; }
        .pagination-btn { padding: 6px 12px; background: var(--primary-light); color: var(--white); border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .pagination-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Redaguojami laukai */
        .repair-cost-input { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; }
        .product-id-input { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; }
        .product-edit-input { width: 100%; padding: 2px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; line-height: 1.2; }

        @media (max-width: 600px) {
            .filters { flex-direction: column; }
            .stats-bar { flex-direction: column; gap: 6px; }
            th, td { padding: 4px 6px; font-size: 10px; }
            .pagination { flex-direction: column; gap: 10px; }
        }
    </style>
<style>
.comm-head {
    width: 36px;
    text-align: center;
}
.comm-cell {
    text-align: center;
    padding: 4px !important;
}
.comm-icon {
    display: inline-block;
    position: relative;
    font-size: 18px;
    line-height: 1;
    cursor: pointer;
}
.comm-badge {
    position: absolute;
    top: -8px;
    right: -10px;
    background: #ef4444;
    color: #fff;
    border-radius: 9999px;
    padding: 0 6px;
    font-size: 11px;
    line-height: 18px;
    min-width: 18px;
    border: 2px solid #fff;
}
.comm-muted {
    opacity: .35;
}
.comm-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 18px;
}
</style>
    <style>
        .comm-head{width:36px;text-align:center}
        .comm-cell{text-align:center}
        .comm-icon{display:inline-block;position:relative;font-size:18px;line-height:1}
        .comm-badge{position:absolute;top:-6px;right:-10px;background:#ef4444;color:#fff;border-radius:9999px;
          padding:0 6px;font-size:11px;line-height:18px;min-width:18px;border:2px solid #fff}
        .comm-muted{opacity:.35}
        .comm-btn{background:transparent;border:none;cursor:pointer;font-size:18px}
        
        /* Mygtuk≈≥ stiliai */
        .btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-export {
            background-color: #28a745;
            color: white;
        }
        .btn-small {
            padding: 4px 8px;
            font-size: 10px;
        }
    </style>
</head>
<body>
<header>
    <img src="logo.jpg" alt="Rubineta Logo" class="logo" onclick="location.href='index.html'">
    <nav>
        <a href="index.html">Pagrindinis</a>
        <a href="duku.html">DUK</a>
        <a href="login.html">Prisijungti</a>
    </nav>
</header>

<main>
    <h1>Administratoriaus zona</h1>

    <!-- Skirtukai -->
    <div class="tabs">
        <div class="tab active" onclick="openTab('claims')">Pretenzijos</div>
        <div class="tab" onclick="openTab('feedback')">Atsiliepimai</div>
        <div class="tab" onclick="openTab('users')">Vartotojai</div>
        <div class="tab" onclick="openTab('partners')">Serviso partneriai</div>
    </div>

    <!-- Skirtukas: Pretenzijos -->
    <div id="claims" class="tab-content active">
        <!-- Statistika -->
        <div class="stats-bar">
            <div class="stat-item"><span class="label">Pretenzij≈≥ sk.</span><span class="value" id="total-claims">0</span></div>
            <div class="stat-item"><span class="label">Vid. atsakymo laikas</span><span class="value" id="avg-response">24 val.</span></div>
            <div class="stat-item"><span class="label">Da≈æniausi brokai</span><span class="value" id="top-issue">U≈æsikim≈°ƒôs aeratorius</span></div>
            <div class="stat-item"><span class="label">Pop. produktai</span><span class="value" id="top-product">ECOSENS</span></div>
        </div>

        <!-- Veiksmai -->
        <div class="filters">
            <button onclick="exportToCSV(false)" class="btn btn-export">Eksportuoti visus (pagal filtrƒÖ)</button>
            <button onclick="exportToCSV(true)" class="btn btn-export">Eksportuoti tik ≈°ƒØ puslapƒØ</button>
        </div>

        <!-- Pretenzij≈≥ lentelƒó -->
        <table id="claims-table">
            <thead>
            <tr>
                <th class="comm-head" title="Naujos ≈æinutƒós">‚úâÔ∏è</th>
                <th style="width: 6%;">ID<br><input type="text" id="filter-id" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 6%;">Data<br>
                    <input type="date" id="filter-date-from-header" class="inline-filter" onchange="applyInlineFilters()">‚Äì<br>
                    <input type="date" id="filter-date-to-header" class="inline-filter" onchange="applyInlineFilters()">
                </th>
                <th style="width: 8%;">Vartotojas<br><input type="text" id="filter-user" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 6%;">Miestas<br><input type="text" id="filter-city" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 8%;">Produktas<br><input type="text" id="filter-product" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 6%;">Produkto ID<br><input type="text" id="filter-product-id" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 10%;">Problema<br><input type="text" id="filter-problem" class="inline-filter" placeholder="Raktiniai ≈æod≈æiai" oninput="applyInlineFilters()"></th>
                <th style="width: 8%;">Gedimo r≈´≈°is<br>
                    <select id="filter-issue-type" class="inline-filter" onchange="applyInlineFilters()">
                        <option value="">Visi</option>
                        <option value="Nutekƒójimai (Leaking Issues)">Nutekƒójimai</option>
                        <option value="Liejimo defektai (Casting Defects)">Liejimo defektai</option>
                        <option value="Snapo problemos (Spout Problems)">Snapo problemos</option>
                        <option value="Mygtuk≈≥ ar vo≈ætuv≈≥ gedimai (Button or Valve Issues)">Mygtuk≈≥ gedimai</option>
                        <option value="Sukimosi ir judƒójimo problemos (Rotation and Movement Issues)">Judƒójimo klaidos</option>
                        <option value="Pavir≈°iaus ir dangos problemos (Surface and Coating Problems)">Dangos defektai</option>
                        <option value="Tr≈´kstamos dalys (Missing Parts)">Tr≈´kstamos dalys</option>
                        <option value="Montavimo problemos (Installation Issues)">Montavimo klaidos</option>
                        <option value="Kitos kokybƒós problemos (Other Quality Issues)">Kitos</option>
                    </select>
                </th>
                <th style="width: 6%;">Remonto kaina<br><input type="number" step="0.01" id="filter-repair-cost" class="inline-filter" placeholder="‚â• suma" oninput="applyInlineFilters()"></th>
                <th style="width: 8%;">Meistras<br><input type="text" id="filter-master" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 8%;">Atsakingas<br><input type="text" id="filter-responsible" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 8%;">Koment<br><input type="text" id="filter-comment" class="inline-filter" placeholder="Raktiniai ≈æod≈æiai" oninput="applyInlineFilters()"></th>
                <th style="width: 6%;">B≈´sena<br>
                    <select id="filter-status" class="inline-filter" onchange="applyInlineFilters()">
                        <option value="">Visi</option>
                        <option value="Nauja">Nauja</option>
                        <option value="Laukia patvirtinimo">Laukia</option>
                        <option value="Patvirtinta">Patvirtinta</option>
                        <option value="Perduota servisui">Perduota</option>
                        <option value="I≈°sprƒôsta">I≈°sprƒôsta</option>
                        <option value="Atmesta">Atmesta</option>
                    </select>
                </th>
            </tr>
            </thead>
            <tbody id="claims-body">
            <tr><td colspan="15" style="text-align: center;">Kraunama...</td></tr>
            </tbody>
        </table>

        <!-- Puslapiavimas -->
        <div class="pagination">
            <div class="pagination-info" id="pagination-info">Rodoma 0-0 i≈° 0</div>
            <div class="pagination-buttons">
                <button class="pagination-btn" id="prev-page" onclick="changePage(-1)">Ankstesnis</button>
                <button class="pagination-btn" id="next-page" onclick="changePage(1)">Kitas</button>
            </div>
        </div>
    </div>

    <!-- Skirtukas: Atsiliepimai -->
    <div id="feedback" class="tab-content">
        <h2>Klient≈≥ atsiliepimai</h2>
        <table>
            <thead>
                <tr>
                    <th>Pretenzijos ID</th>
                    <th>Data</th>
                    <th>Greitis</th>
                    <th>Kokybƒó</th>
                    <th>Mandagumas</th>
                    <th>NPS</th>
                    <th>Komentaras</th>
                </tr>
            </thead>
            <tbody id="feedback-body">
                <tr><td colspan="7" style="text-align: center;">Kraunama...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Skirtukas: Vartotojai -->
    <div id="users" class="tab-content">
        <h2>Vartotoj≈≥ sƒÖra≈°as</h2>
        <table>
            <thead>
            <tr>
                <th>Vardas</th>
                <th>Pavardƒó</th>
                <th>Rolƒó</th>
                <th>B≈´sena</th>
                <th>El. pa≈°tas</th>
                <th>Telefonas</th>
                <th>Miestas</th>
                <th>Veiksmai</th>
            </tr>
            </thead>
            <tbody id="users-body">
            <tr><td colspan="8" style="text-align: center;">Kraunama...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Skirtukas: Serviso partneriai -->
    <div id="partners" class="tab-content">
        <h2>Serviso partneriai</h2>
        <div class="filters">
            <input type="text" id="filter-partner-name" placeholder="Ie≈°koti pagal pavadinimƒÖ">
            <input type="text" id="filter-partner-city" placeholder="Ie≈°koti pagal miestƒÖ">
            <button onclick="filterPartners()" class="btn btn-primary">Filtruoti</button>
            <button onclick="openAddPartnerModal()" class="btn btn-primary">+ Pridƒóti partnerƒØ</button>
        </div>

        <table id="partners-table">
            <thead>
            <tr>
                <th>Pavadinimas</th>
                <th>Kontaktinis asmuo</th>
                <th>Kontaktai</th>
                <th>Veiklos zona</th>
                <th>Veiksmai</th>
            </tr>
            </thead>
            <tbody id="partners-body">
            <tr><td colspan="5" style="text-align: center;">Kraunama...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<!-- Pretenzijos modalas -->
<div id="claimModal" class="modal">
    <div class="modal-content">
        <div id="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 id="modal-title">Pretenzijos per≈æi≈´ra</h2>
            <div id="modal-actions">
                <button onclick="openClaimViewPage()" class="btn btn-export" style="padding: 5px 10px; font-size: 11px; margin-right: 10px;">Per≈æi≈´rƒóti atskirai</button>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<!-- Partnerio modalas -->
<div id="partnerModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closePartnerModal()">&times;</span>
        <h2 id="partnerModalTitle">Pridƒóti partnerƒØ</h2>
        <form id="partner-form">
            <input type="hidden" id="edit-partner-id">
            <div class="form-group">
                <label for="partner-name">Pavadinimas *</label>
                <input type="text" id="partner-name" required>
            </div>
            <div class="form-group">
                <label for="partner-contact">Kontaktinis asmuo *</label>
                <input type="text" id="partner-contact" required>
            </div>
            <div class="form-group">
                <label for="partner-phone">Telefonas *</label>
                <input type="tel" id="partner-phone" required>
            </div>
            <div class="form-group">
                <label for="partner-email">El. pa≈°tas *</label>
                <input type="email" id="partner-email" required>
            </div>
            <div class="form-group">
                <label for="partner-cities">Veiklos zonos (miestai)</label>
                <input type="text" id="partner-cities" placeholder="pvz., Vilnius, Kaunas">
            </div>
            <button type="button" onclick="savePartner()" class="btn btn-primary">I≈°saugoti</button>
        </form>
    </div>
</div>

<footer>¬© 2025 Rubineta. Visos teisƒós saugomos. | info@rubineta.lt</footer>

<script>
/* =================== BENDRI KINTAMIEJI =================== */
let currentPage = 1;
const itemsPerPage = 20;
let totalClaims = 0;
let filteredClaims = [];
let currentFilters = null;
let sortKey = null;
let sortDir = 'asc';

/* =================== PRIEIGOS KONTROLƒñ =================== */
const currentUser = JSON.parse(localStorage.getItem('currentUser'));
if (!currentUser || !['admin', 'quality'].includes(currentUser.role)) {
    alert('Prieiga draud≈æiama. Reikalingos administratoriaus teisƒós.');
    location.href = 'index.html';
}

/* =================== PADƒñTINƒñS FUNKCIJOS =================== */
function setModalHeader(title, showViewSeparately = false) {
    document.getElementById('modal-title').textContent = title;
    const viewBtn = document.querySelector('#modal-actions .btn-export');
    if (viewBtn) viewBtn.style.display = showViewSeparately ? 'inline-block' : 'none';
}
function getStatusClass(status) {
    switch (status) {
        case 'Nauja': return 'new';
        case 'Laukia patvirtinimo': return 'pending';
        case 'Patvirtinta': return 'approved';
        case 'Perduota servisui': return 'sent';
        case 'I≈°sprƒôsta': return 'resolved';
        case 'Atmesta': return 'rejected';
        default: return 'new';
    }
}
function safeLower(v){ return (v ?? '').toString().toLowerCase(); }

/* =================== SKIRTUKAI =================== */
function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`.tab[onclick="openTab('${tabName}')"]`).classList.add('active');

    if (tabName === 'claims') loadClaims();
    else if (tabName === 'feedback') loadFeedback();
    else if (tabName === 'users') loadUsers();
    else if (tabName === 'partners') loadPartners();
}

/* =================== PRETENZIJOS: NUSKAITYMAS/PIE≈†IMAS =================== */
function loadClaims(filteredData = null) {
    const claims = filteredData || JSON.parse(localStorage.getItem('claims') || '[]');
    filteredClaims = claims;
    totalClaims = claims.length;
    applySort();
    renderClaims();
}

function applySort(){
    if(!sortKey) return;
    const dir = sortDir === 'asc' ? 1 : -1;
    filteredClaims.sort((a,b)=>{
        let va, vb;
        if (sortKey === 'date'){ va = new Date(a.date||0).getTime(); vb = new Date(b.date||0).getTime(); }
        else if (sortKey === 'id'){ va = (a.id||'').toString(); vb = (b.id||'').toString(); }
        else if (sortKey === 'repairCost'){ va = parseFloat(a.repairCost||0); vb = parseFloat(b.repairCost||0); }
        else { return 0; }
        if (va < vb) return -1*dir;
        if (va > vb) return 1*dir;
        return 0;
    });
}

function toggleSort(key){
    if (sortKey === key) sortDir = (sortDir === 'asc' ? 'desc' : 'asc');
    else { sortKey = key; sortDir = 'asc'; }
    applySort();
    currentPage = 1;
    renderClaims();
}

function renderClaims() {
    const tbody = document.getElementById('claims-body');
    tbody.innerHTML = '';

    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, totalClaims);
    const pageClaims = filteredClaims.slice(startIndex, endIndex);

    if (pageClaims.length === 0) {
        tbody.innerHTML = '<tr><td colspan="15" style="text-align: center;">Nerasta pretenzij≈≥</td></tr>';
    } else {
        pageClaims.forEach(claim => {
            const masterCell = claim.assignedPartner
                ? `<span>${claim.assignedPartner}</span>`
                : `<button class="btn btn-primary" onclick="showAssignModal('${claim.id}')">Priskirti meistrui</button>`;

            const responsibleCell = claim.responsible
                ? `<a href="#" onclick="event.preventDefault(); showResponsibleModal('${claim.id}');">${claim.responsible}</a>`
                : `<a href="#" onclick="event.preventDefault(); showResponsibleModal('${claim.id}');">Paskirti atsakingƒÖ</a>`;

            const commentCell = claim.qualityComment || '-------';
            const repairCost = claim.repairCost || '';
            const productId = claim.productId || '';
            const issueType = claim.issueType || 'Kitos kokybƒós problemos (Other Quality Issues)';

            const productInput = `<input type="text" class="product-edit-input" value="${claim.product || ''}"
                                  data-id="${claim.id}" onchange="updateProduct('${claim.id}', this.value)">`;

            const issueTypes = [
                "Nutekƒójimai (Leaking Issues)",
                "Liejimo defektai (Casting Defects)",
                "Snapo problemos (Spout Problems)",
                "Mygtuk≈≥ ar vo≈ætuv≈≥ gedimai (Button or Valve Issues)",
                "Sukimosi ir judƒójimo problemos (Rotation and Movement Issues)",
                "Pavir≈°iaus ir dangos problemos (Surface and Coating Problems)",
                "Tr≈´kstamos dalys (Missing Parts)",
                "Montavimo problemos (Installation Issues)",
                "Kitos kokybƒós problemos (Other Quality Issues)"
            ];
            const issueSelect = `
                <select class="inline-issue-select" onchange="updateIssueType('${claim.id}', this.value)" style="width:100%; padding:4px;">
                    ${issueTypes.map(t => `<option value="${t}" ${t===issueType?'selected':''}>${t}</option>`).join('')}
                </select>
            `;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="comm-cell" data-claim="${claim.id}"></td>
                <td><a href="#" onclick="event.preventDefault(); viewClaimDetails('${claim.id}');">${claim.id}</a></td>
                <td>${claim.date ? new Date(claim.date).toLocaleDateString('lt-LT') : ''}</td>
                <td>${safeLower((claim.contact?.name||'')) ? `${claim.contact.name} ${claim.contact?.surname||''}` : ''}</td>
                <td>${claim.contact?.city || ''}</td>
                <td>${productInput}</td>
                <td><input type="text" class="product-id-input" value="${productId}" placeholder="pvz., SKU-123"
                           onchange="updateProductId('${claim.id}', this.value)"></td>
                <td>${(claim.description||'').substring(0, 30)}${(claim.description||'').length>30?'...':''}</td>
                <td>${issueSelect}</td>
                <td><input type="number" step="0.01" class="repair-cost-input" value="${repairCost}" placeholder="‚Ç¨"
                           onchange="updateRepairCost('${claim.id}', this.value)"></td>
                <td>${masterCell}</td>
                <td>${responsibleCell}</td>
                <td>${commentCell}</td>
                <td>
                    <select class="status-dropdown status-${getStatusClass(claim.status)}"
                            onchange="updateStatusDirectly('${claim.id}', this.value)">
                        <option value="Nauja" ${claim.status === 'Nauja' ? 'selected' : ''}>Nauja</option>
                        <option value="Laukia patvirtinimo" ${claim.status === 'Laukia patvirtinimo' ? 'selected' : ''}>Laukia patvirtinimo</option>
                        <option value="Patvirtinta" ${claim.status === 'Patvirtinta' ? 'selected' : ''}>Patvirtinta</option>
                        <option value="Perduota servisui" ${claim.status === 'Perduota servisui' ? 'selected' : ''}>Perduota servisui</option>
                        <option value="I≈°sprƒôsta" ${claim.status === 'I≈°sprƒôsta' ? 'selected' : ''}>I≈°sprƒôsta</option>
                        <option value="Atmesta" ${claim.status === 'Atmesta' ? 'selected' : ''}>Atmesta</option>
                    </select>
                </td>
            `;
            
            tr.setAttribute('data-claim-id', claim.id);
            tbody.appendChild(tr);
        });
    }

    updateCommBadges();

    document.getElementById('pagination-info').textContent = `Rodoma ${totalClaims ? (startIndex + 1) : 0}-${endIndex} i≈° ${totalClaims}`;

    document.getElementById('prev-page').disabled = currentPage === 1;
    document.getElementById('next-page').disabled = endIndex >= totalClaims;

    document.getElementById('total-claims').textContent = totalClaims;
}

/* =================== REDAGAVIMO FUNKCIJOS =================== */
function updateProduct(id, newProduct) {
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim && newProduct.trim() !== '') {
        claim.product = newProduct.trim();
        localStorage.setItem('claims', JSON.stringify(claims));
        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) filteredClaim.product = newProduct.trim();
    }
}
function updateProductId(id, newId) {
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        claim.productId = (newId || '').trim();
        localStorage.setItem('claims', JSON.stringify(claims));
        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) filteredClaim.productId = (newId || '').trim();
    }
}
function updateIssueType(id, newType) {
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        claim.issueType = (newType || '').trim();
        localStorage.setItem('claims', JSON.stringify(claims));
        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) filteredClaim.issueType = (newType || '').trim();
    }
}
function updateRepairCost(id, newCost) {
    const val = (newCost ?? '').toString().replace(',', '.');
    if (val !== '' && isNaN(parseFloat(val))) {
        alert('Neteisinga suma. Naudokite skaiƒçi≈≥ (pvz., 85.50)');
        renderClaims();
        return;
    }
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        claim.repairCost = val;
        localStorage.setItem('claims', JSON.stringify(claims));
        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) filteredClaim.repairCost = val;
    }
}
function updateStatusDirectly(id, newStatus) {
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        claim.status = newStatus;
        localStorage.setItem('claims', JSON.stringify(claims));
        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) filteredClaim.status = newStatus;
        renderClaims();
    }
}

/* =================== FILTRAVIMAS =================== */
function applyInlineFilters() {
    const idFilter = document.getElementById('filter-id').value.toLowerCase();
    const userFilter = document.getElementById('filter-user').value.toLowerCase();
    const cityFilter = document.getElementById('filter-city').value.toLowerCase();
    const productFilter = document.getElementById('filter-product').value.toLowerCase();
    const productIdFilter = document.getElementById('filter-product-id').value.toLowerCase();
    const problemFilter = document.getElementById('filter-problem').value.toLowerCase();
    const issueTypeFilter = document.getElementById('filter-issue-type').value;
    const repairCostFilter = document.getElementById('filter-repair-cost').value;
    const masterFilter = document.getElementById('filter-master').value.toLowerCase();
    const responsibleFilter = document.getElementById('filter-responsible').value.toLowerCase();
    const commentFilter = document.getElementById('filter-comment').value.toLowerCase();
    const statusFilter = document.getElementById('filter-status').value;

    const dateFrom = document.getElementById('filter-date-from-header').value;
    const dateTo = document.getElementById('filter-date-to-header').value;

    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    filteredClaims = claims.filter(claim => {
        const claimDate = claim.date ? new Date(claim.date).toISOString().split('T')[0] : '';
        const matchesId = !idFilter || safeLower(claim.id).includes(idFilter);
        const matchesUser = !userFilter || safeLower(`${claim.contact?.name || ''} ${claim.contact?.surname || ''}`).includes(userFilter);
        const matchesCity = !cityFilter || safeLower(claim.contact?.city).includes(cityFilter);
        const matchesProduct = !productFilter || safeLower(claim.product).includes(productFilter);
        const matchesProductId = !productIdFilter || safeLower(claim.productId).includes(productIdFilter);
        const matchesProblem = !problemFilter || safeLower(claim.description).includes(problemFilter);
        const matchesIssueType = !issueTypeFilter || (claim.issueType === issueTypeFilter);
        const matchesRepairCost = !repairCostFilter || (parseFloat(claim.repairCost || 0) >= parseFloat(repairCostFilter));
        const matchesMaster = !masterFilter || safeLower(claim.assignedPartner).includes(masterFilter);
        const matchesResponsible = !responsibleFilter || safeLower(claim.responsible).includes(responsibleFilter);
        const matchesComment = !commentFilter || safeLower(claim.qualityComment).includes(commentFilter);
        const matchesStatus = !statusFilter || (claim.status === statusFilter);
        const matchesDateFrom = !dateFrom || (claimDate && claimDate >= dateFrom);
        const matchesDateTo = !dateTo || (claimDate && claimDate <= dateTo);

        return matchesId && matchesUser && matchesCity && matchesProduct && matchesProductId && matchesProblem &&
            matchesIssueType && matchesRepairCost && matchesMaster && matchesResponsible && matchesComment &&
            matchesStatus && matchesDateFrom && matchesDateTo;
    });

    currentPage = 1;
    loadClaims(filteredClaims);
}

/* =================== PUSLAPIAVIMAS =================== */
function changePage(delta) {
    const newPage = currentPage + delta;
    const maxPage = Math.ceil(totalClaims / itemsPerPage);
    if (newPage >= 1 && newPage <= maxPage) {
        currentPage = newPage;
        renderClaims();
         updateCommBadges(); // ‚úÖ Atnaujiname indikatorius po filtro
    }
}

/* =================== EKSPORTAVIMAS =================== */
function exportToCSV(currentPageOnly) {
    const dataToExport = currentPageOnly
        ? filteredClaims.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage)
        : filteredClaims;

    if (dataToExport.length === 0) {
        alert('Nƒóra duomen≈≥ eksportavimui.');
        return;
    }

    const headers = ['ID', 'Data', 'Vartotojas', 'Miestas', 'Produktas', 'Produkto ID', 'Problema', 'Gedimo r≈´≈°is', 'Remonto kaina', 'Meistras', 'Atsakingas', 'Komentaras', 'B≈´sena'];
    const csvRows = [headers.join(',')];

    dataToExport.forEach(claim => {
        const row = [
            claim.id,
            claim.date ? new Date(claim.date).toLocaleDateString('lt-LT') : '',
            `${claim.contact?.name || ''} ${claim.contact?.surname || ''}`,
            claim.contact?.city || '',
            claim.product || '',
            claim.productId || '',
            `"${(claim.description || '').replace(/"/g, '""')}"`,
            claim.issueType || '',
            claim.repairCost || '',
            claim.assignedPartner || '',
            claim.responsible || '',
            `"${(claim.qualityComment || '').replace(/"/g, '""')}"`,
            claim.status || ''
        ];
        csvRows.push(row.join(','));
    });

    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `pretenzijos_${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

/* =================== MODAL≈≤ VALDYMAS =================== */
let currentClaimId = null; // Pridƒótas globalus kintamasis pretenzijos ID saugojimui

function viewClaimDetails(id) {
    currentClaimId = id; // I≈°saugome pasirinktos pretenzijos ID
    
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (!claim) {
        alert('Pretenzija nerasta.');
        return;
    }

    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Vartotojas</label>
                <div>${claim.contact?.name || ''} ${claim.contact?.surname || ''}</div>
            </div>
            <div class="form-group">
                <label>Miestas</label>
                <div>${claim.contact?.city || ''}</div>
            </div>
            <div class="form-group">
                <label>Produktas</label>
                <div>${claim.product || ''}</div>
            </div>
            <div class="form-group">
                <label>Produkto ID</label>
                <div>${claim.productId || ''}</div>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label>Problema</label>
                <div>${claim.description || ''}</div>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label>Gedimo r≈´≈°is</label>
                <div>${claim.issueType || ''}</div>
            </div>
            <div class="form-group">
                <label>Remonto kaina</label>
                <div>${claim.repairCost ? `${claim.repairCost} ‚Ç¨` : ''}</div>
            </div>
            <div class="form-group">
                <label>Meistras</label>
                <div>${claim.assignedPartner || 'Nepriskirtas'}</div>
            </div>
            <div class="form-group">
                <label>Atsakingas</label>
                <div>${claim.responsible || 'Nepaskirtas'}</div>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label>Komentaras</label>
                <textarea id="quality-comment" rows="3">${claim.qualityComment || ''}</textarea>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label>B≈´sena</label>
                <select id="status-select" class="status-dropdown status-${getStatusClass(claim.status)}">
                    <option value="Nauja" ${claim.status === 'Nauja' ? 'selected' : ''}>Nauja</option>
                    <option value="Laukia patvirtinimo" ${claim.status === 'Laukia patvirtinimo' ? 'selected' : ''}>Laukia patvirtinimo</option>
                    <option value="Patvirtinta" ${claim.status === 'Patvirtinta' ? 'selected' : ''}>Patvirtinta</option>
                    <option value="Perduota servisui" ${claim.status === 'Perduota servisui' ? 'selected' : ''}>Perduota servisui</option>
                    <option value="I≈°sprƒôsta" ${claim.status === 'I≈°sprƒôsta' ? 'selected' : ''}>I≈°sprƒôsta</option>
                    <option value="Atmesta" ${claim.status === 'Atmesta' ? 'selected' : ''}>Atmesta</option>
                </select>
            </div>
        </div>
        <div style="margin-top: 20px; text-align: right;">
            <button class="btn btn-primary" onclick="saveClaimChanges('${id}')">I≈°saugoti</button>
        </div>
    `;

    document.getElementById('claimModal').style.display = 'flex';

    // ‚úÖ Svarbus pakeitimai ƒçia:
    try {
        localStorage.setItem(`chatSeen_admin_${id}`, String(Date.now()));
    } catch(e) {
        console.warn('Nepavyko i≈°saugoti perskaitymo laiko', e);
    }

    // Pa≈æymime ≈æinutes kaip perskaitytas ir atnaujiname indikatori≈≥
    markMessagesAsRead(id);

    setModalHeader(`Pretenzija #${id}`, true);
}

function saveClaimChanges(id) {
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        claim.qualityComment = document.getElementById('quality-comment').value;
        claim.status = document.getElementById('status-select').value;
        localStorage.setItem('claims', JSON.stringify(claims));
        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) {
            filteredClaim.qualityComment = claim.qualityComment;
            filteredClaim.status = claim.status;
        }
        closeModal();
        renderClaims();
    }
}

function closeModal() {
    document.getElementById('claimModal').style.display = 'none';
}

function openClaimViewPage() {
    if (currentClaimId) {
        window.open(`claim-view.html?id=${currentClaimId}`, '_blank');
    } else {
        alert('Nepavyko gauti pretenzijos ID.');
    }
}

/* =================== ATSAKINGO ASMENS PRISKYRIMAS =================== */
function showResponsibleModal(id) {
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        setModalHeader('Paskirti atsakingƒÖ', false);

        const adminUsers = JSON.parse(localStorage.getItem('adminUsers') || '[]');
        let userOptions = '<option value="">Pasirinkite atsakingƒÖ...</option>';
        adminUsers.forEach(user => {
            const full = `${user.name} ${user.surname}`;
            userOptions += `<option value="${full}" ${claim.responsible === full ? 'selected' : ''}>${full} (${user.role})</option>`;
        });

        const modalBody = `
            <div class="modal-section">
                <h3>Paskirti atsakingƒÖ kokybƒós skyriaus darbuotojƒÖ</h3>
                <p><strong>Pretenzijos ID:</strong> ${claim.id}</p>
                <p><strong>Produktas:</strong> ${claim.product||''}</p>
                <p><strong>Apra≈°ymas:</strong> ${claim.description||''}</p>
                <select id="responsible-select">${userOptions}</select>
                <button class="btn-small btn-primary" onclick="assignResponsible('${claim.id}')">Paskirti</button>
            </div>
        `;
        
        document.getElementById('modal-body').innerHTML = modalBody;
        document.getElementById('claimModal').style.display = 'flex';
    }
}

function assignResponsible(id) {
    const selectedResponsible = document.getElementById('responsible-select').value;
    if (!selectedResponsible) { 
        alert('Pasirinkite atsakingƒÖ.'); 
        return; 
    }
    
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        claim.responsible = selectedResponsible;
        localStorage.setItem('claims', JSON.stringify(claims));
        
        // Atnaujiname filtruotƒÖ sƒÖra≈°ƒÖ
        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) {
            filteredClaim.responsible = selectedResponsible;
        }
        
        alert(`Atsakingas paskirtas: ${selectedResponsible}`);
        closeModal();
        renderClaims();
    }
}

/* =================== KOMENTAR≈≤ VALDYMAS =================== */
function updateCommBadges() {
    const commCells = document.querySelectorAll('.comm-cell');
    commCells.forEach(cell => {
        const claimId = cell.getAttribute('data-claim');
        if (!claimId) return;
        
        const claim = filteredClaims.find(c => c.id === claimId);
        if (!claim) return;
        
        // Tikriname ar yra ≈æinutƒós
        const messages = claim.messages || [];
        const unreadCount = messages.filter(msg => {
            // Tikriname ar ≈æinutƒó yra i≈° vartotojo ar meistro ir dar neperskaityta
            return (msg.from === 'user' || msg.from === 'master') && !msg.read;
        }).length;
        
        cell.innerHTML = unreadCount > 0 
            ? `<span class="comm-icon">‚úâÔ∏è<span class="comm-badge">${unreadCount}</span></span>` 
            : `<span class="comm-icon comm-muted">‚úâÔ∏è</span>`;
    });
}

// ≈Ωinutƒós perskaitymo funkcija
function markMessagesAsRead(claimId) {
  const claims = JSON.parse(localStorage.getItem('claims') || '[]');
  const claim = claims.find(c => c.id === claimId);
  if (claim && claim.messages) {
    claim.messages.forEach(msg => {
      if (msg.from === 'user' || msg.from === 'master') {
        msg.read = true;
      }
    });
    localStorage.setItem('claims', JSON.stringify(claims));

    // Atnaujiname filtruotƒÖ sƒÖra≈°ƒÖ
    const filteredClaim = filteredClaims.find(c => c.id === claimId);
    if (filteredClaim && filteredClaim.messages) {
      filteredClaim.messages.forEach(msg => {
        if (msg.from === 'user' || msg.from === 'master') {
          msg.read = true;
        }
      });
    }

    updateCommBadges(); // ‚úÖ Svarbu: atnaujinti indikatorius nedelsiant!
  }
}

/* =================== ATSILIEPIM≈≤ VALDYMAS =================== */
function loadFeedback() {
    const feedbacks = JSON.parse(localStorage.getItem('feedbacks') || '[]');
    const tbody = document.getElementById('feedback-body');
    tbody.innerHTML = '';

    if (feedbacks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nerasta atsiliepim≈≥</td></tr>';
    } else {
        feedbacks.forEach(feedback => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${feedback.claimId || ''}</td>
                <td>${feedback.date ? new Date(feedback.date).toLocaleDateString('lt-LT') : ''}</td>
                <td>${feedback.ratings?.speed || ''}</td>
                <td>${feedback.ratings?.quality || ''}</td>
                <td>${feedback.ratings?.politeness || ''}</td>
                <td>${feedback.ratings?.nps || ''}</td>
                <td>${feedback.comments || ''}</td>
            `;
            tbody.appendChild(tr);
        });
    }
}

/* =================== VARTOTOJ≈≤ VALDYMAS =================== */
function loadUsers() {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const tbody = document.getElementById('users-body');
    tbody.innerHTML = '';

    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nerasta vartotoj≈≥</td></tr>';
    } else {
        users.forEach(user => {
            const statusCell = user.status === 'pending' && user.role === 'installer'
                ? `<a href="#" onclick="event.preventDefault(); viewInstallerDocs('${user.id}');">Dokumentai</a>`
                : user.status || 'Aktyvus';

            const actions = user.status === 'pending' && user.role === 'installer'
                ? `
                    <button class="btn btn-primary btn-small" onclick="approveInstaller('${user.id}')">Patvirtinti</button>
                    <button class="btn btn-danger btn-small" onclick="openRejectionModal('${user.id}')">Atmesti</button>
                `
                : `<button class="btn btn-primary btn-small" onclick="viewUserHistory('${user.id}')">Per≈æi≈´rƒóti istorijƒÖ</button>`;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${user.name || ''}</td>
                <td>${user.surname || ''}</td>
                <td>${user.role || 'user'}</td>
                <td>${statusCell}</td>
                <td>${user.email || ''}</td>
                <td>${user.phone || ''}</td>
                <td>${user.city || ''}</td>
                <td>${actions}</td>
            `;
            tbody.appendChild(tr);
        });
    }
}

function viewInstallerDocs(id) {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const user = users.find(u => u.id === id);
    if (!user) {
        alert('Vartotojas nerastas.');
        return;
    }

    let docsHtml = '<div class="file-list">';
    if (user.documents && user.documents.length > 0) {
        user.documents.forEach(doc => {
            docsHtml += `<div class="file-item">
                <a href="${doc.url}" target="_blank" style="text-decoration: none;">
                    üìé ${doc.name}
                </a>
            </div>`;
        });
    } else {
        docsHtml += '<div class="file-item">Nƒóra ƒØkelt≈≥ dokument≈≥</div>';
    }
    docsHtml += '</div>';

    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div class="modal-section">
            <h3>Dokumentai ‚Äì ${user.name} ${user.surname}</h3>
            ${docsHtml}
            <p><strong>Patvirtinimo data:</strong> ${user.submissionDate || 'Nenurodyta'}</p>
        </div>
    `;

    document.getElementById('claimModal').style.display = 'flex';
    setModalHeader('Dokument≈≥ per≈æi≈´ra', false);
}

function approveInstaller(id) {
    if (!confirm('Ar tikrai norite patvirtinti ≈°ƒØ meistrƒÖ?')) return;

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const user = users.find(u => u.id === id);
    if (user) {
        user.status = 'approved';
        localStorage.setItem('users', JSON.stringify(users));
        alert(`Meistras ${user.name} ${user.surname} patvirtintas!`);
        loadUsers();
    }
}

function openRejectionModal(id) {
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div class="modal-section">
            <h3>Atmesti meistrƒÖ</h3>
            <p>Kodƒól atmetate ≈°ƒØ meistrƒÖ?</p>
            <textarea id="rejection-reason" placeholder="ƒÆra≈°ykite prie≈æastƒØ..." style="width:100%; padding:8px; margin:10px 0;"></textarea>
            <button class="btn btn-danger" onclick="rejectInstaller('${id}')">Atmesti</button>
        </div>
    `;

    document.getElementById('claimModal').style.display = 'flex';
    setModalHeader('Atmesti meistrƒÖ', false);
}

function rejectInstaller(id) {
    const reason = document.getElementById('rejection-reason').value.trim();
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const user = users.find(u => u.id === id);
    if (user) {
        user.status = 'rejected';
        user.rejectionReason = reason;
        localStorage.setItem('users', JSON.stringify(users));
        alert(`Meistras ${user.name} ${user.surname} atmestas.`);
        closeModal();
        loadUsers();
    }
}

function viewUserHistory(userId) {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const user = users.find(u => u.id === userId);
    if (!user) {
        alert('Vartotojas nerastas.');
        return;
    }

    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const userClaims = claims.filter(c => c.userId === userId);
    
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <h3>Vartotojo ${user.name} ${user.surname} istorija</h3>
        <p>El. pa≈°tas: ${user.email}</p>
        <p>Telefonas: ${user.phone}</p>
        <p>Miestas: ${user.city}</p>
        
        <h4 style="margin-top: 20px;">Pretenzij≈≥ istorija (${userClaims.length})</h4>
        <table style="width: 100%; margin-top: 10px; font-size: 11px;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Data</th>
                    <th>Produktas</th>
                    <th>Problema</th>
                    <th>B≈´sena</th>
                </tr>
            </thead>
            <tbody>
                ${userClaims.length > 0 ? userClaims.map(claim => `
                    <tr>
                        <td>${claim.id}</td>
                        <td>${claim.date ? new Date(claim.date).toLocaleDateString('lt-LT') : ''}</td>
                        <td>${claim.product || ''}</td>
                        <td>${claim.description ? claim.description.substring(0, 30) + (claim.description.length > 30 ? '...' : '') : ''}</td>
                        <td>${claim.status || ''}</td>
                    </tr>
                `).join('') : '<tr><td colspan="5" style="text-align: center;">Nƒóra pretenzij≈≥</td></tr>'}
            </tbody>
        </table>
    `;

    document.getElementById('claimModal').style.display = 'flex';
    setModalHeader(`Vartotojo ${user.name} ${user.surname} istorija`, false);
}

/* =================== SERVISO PARTNERI≈≤ VALDYMAS =================== */
function loadPartners() {
    const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    const tbody = document.getElementById('partners-body');
    tbody.innerHTML = '';

    if (partners.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nerasta serviso partneri≈≥</td></tr>';
    } else {
        partners.forEach(partner => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${partner.name}</td>
                <td>${partner.contactPerson}</td>
                <td>${partner.phone}<br>${partner.email}</td>
                <td>${partner.cities || 'Visi miestai'}</td>
                <td>
                    <button class="btn btn-primary btn-small" onclick="editPartner('${partner.id}')">Redaguoti</button>
                    <button class="btn btn-danger btn-small" onclick="deletePartner('${partner.id}')">I≈°trinti</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }
}

function filterPartners() {
    const nameFilter = document.getElementById('filter-partner-name').value.toLowerCase();
    const cityFilter = document.getElementById('filter-partner-city').value.toLowerCase();
    
    const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    const filteredPartners = partners.filter(partner => {
        const matchesName = !nameFilter || safeLower(partner.name).includes(nameFilter);
        const matchesCity = !cityFilter || safeLower(partner.cities).includes(cityFilter);
        return matchesName && matchesCity;
    });
    
    const tbody = document.getElementById('partners-body');
    tbody.innerHTML = '';
    
    if (filteredPartners.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nerasta serviso partneri≈≥</td></tr>';
    } else {
        filteredPartners.forEach(partner => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${partner.name}</td>
                <td>${partner.contactPerson}</td>
                <td>${partner.phone}<br>${partner.email}</td>
                <td>${partner.cities || 'Visi miestai'}</td>
                <td>
                    <button class="btn btn-primary btn-small" onclick="editPartner('${partner.id}')">Redaguoti</button>
                    <button class="btn btn-danger btn-small" onclick="deletePartner('${partner.id}')">I≈°trinti</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }
}

function openAddPartnerModal() {
    document.getElementById('partnerModalTitle').textContent = 'Pridƒóti partnerƒØ';
    document.getElementById('edit-partner-id').value = '';
    document.getElementById('partner-name').value = '';
    document.getElementById('partner-contact').value = '';
    document.getElementById('partner-phone').value = '';
    document.getElementById('partner-email').value = '';
    document.getElementById('partner-cities').value = '';
    document.getElementById('partnerModal').style.display = 'flex';
}

function editPartner(id) {
    const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    const partner = partners.find(p => p.id === id);
    if (!partner) {
        alert('Partneris nerastas.');
        return;
    }

    document.getElementById('partnerModalTitle').textContent = 'Redaguoti partnerƒØ';
    document.getElementById('edit-partner-id').value = partner.id;
    document.getElementById('partner-name').value = partner.name;
    document.getElementById('partner-contact').value = partner.contactPerson;
    document.getElementById('partner-phone').value = partner.phone;
    document.getElementById('partner-email').value = partner.email;
    document.getElementById('partner-cities').value = partner.cities || '';
    document.getElementById('partnerModal').style.display = 'flex';
}

function savePartner() {
    const id = document.getElementById('edit-partner-id').value;
    const name = document.getElementById('partner-name').value.trim();
    const contactPerson = document.getElementById('partner-contact').value.trim();
    const phone = document.getElementById('partner-phone').value.trim();
    const email = document.getElementById('partner-email').value.trim();
    const cities = document.getElementById('partner-cities').value.trim();

    if (!name || !contactPerson || !phone || !email) {
        alert('U≈æpildykite visus privalomus laukus (pa≈æymƒóti *).');
        return;
    }

    const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    
    if (id) {
        // Redaguojamas esamas partneris
        const index = partners.findIndex(p => p.id === id);
        if (index !== -1) {
            partners[index] = { 
                ...partners[index], 
                name, 
                contactPerson, 
                phone, 
                email, 
                cities: cities || partners[index].cities 
            };
        }
    } else {
        // Pridedamas naujas partneris
        const newPartner = {
            id: 'partner_' + Date.now(),
            name,
            contactPerson,
            phone,
            email,
            cities: cities || ''
        };
        partners.push(newPartner);
    }

    localStorage.setItem('servicePartners', JSON.stringify(claims));
    closePartnerModal();
    loadPartners();
}

function deletePartner(id) {
    if (!confirm('Ar tikrai norite i≈°trinti ≈°ƒØ serviso partnerƒØ?')) return;
    
    const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    const updatedPartners = partners.filter(p => p.id !== id);
    localStorage.setItem('servicePartners', JSON.stringify(updatedPartners));
    loadPartners();
}

function closePartnerModal() {
    document.getElementById('partnerModal').style.display = 'none';
}

/* =================== PAGRINDINIS KODAS =================== */
document.addEventListener('DOMContentLoaded', function() {
    loadClaims();
    loadFeedback();
    loadUsers();
    loadPartners();
    
    // Priskiriame event listener'ius filtravimui
    document.getElementById('filter-partner-name').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') filterPartners();
    });
    document.getElementById('filter-partner-city').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') filterPartners();
    });
    
    // Periodi≈°kai atnaujiname ≈æinuƒçi≈≥ skaitiklius
    setInterval(updateCommBadges, 5000);
});

// U≈ædaryti modalƒÖ paspaudus u≈æ jo rib≈≥
window.onclick = function(event) {
    const claimModal = document.getElementById('claimModal');
    const partnerModal = document.getElementById('partnerModal');
    if (event.target === claimModal) closeModal();
    if (event.target === partnerModal) closePartnerModal();
};
</script>
</body>
</html>

