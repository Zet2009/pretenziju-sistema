<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administratoriaus zona ‚Äì Rubineta</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4e5152;
            --primary-light: #4A4A4A;
            --secondary: #FFCC00;
            --light: #F5F5F5;
            --white: #FFFFFF;
            --dark: #234d77;
            --gray: #75757d;
            --font: 'Roboto', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font);
            background: var(--light);
            color: var(--dark);
            line-height: 1.3;
            font-size: 12px;
        }
        header {
            background: var(--white);
            padding: 10px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { height: 50px; cursor: pointer; }
        nav a {
            margin: 0 15px;
            text-decoration: none;
            color: var(--dark);
            font-weight: 200;
            font-size: 14px;
        }
        main {
            max-width: 1800px;
            margin: 10px auto;
            padding: 10px;
        }
        h1 { color: var(--primary); margin-bottom: 15px; font-size: 16px; text-align: center; }

        /* Skirtukai */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .tab {
            padding: 8px 16px;
            background: #e9ecef;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
        }
        .tab:hover { background: #dee2e6; }
        .tab.active {
            background: var(--primary);
            color: var(--white);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .inline-filter {
            width: 100%;
            padding: 3px;
            margin-top: 4px;
            font-size: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        /* Statistika */
        .stats-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 11px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.08);
        }
        .stat-item { display: flex; flex-direction: column; align-items: center; min-width: 120px; text-align: center; }
        .stat-item .label { color: var(--gray); font-weight: 500; font-size: 10px; white-space: nowrap; }
        .stat-item .value { color: var(--primary); font-weight: bold; font-size: 13px; }

        /* Filtrai */
        .filters {
            background: var(--white);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 11px;
        }

        table { width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); table-layout: fixed; font-size: 11px; }
        th, td { padding: 6px 8px; text-align: left; border-bottom: 1px solid #dee2e6; word-wrap: break-word; }
        th { background: var(--primary); color: var(--white); font-weight: 500; font-size: 10px; }
        tr:hover { background: #f8f9fa; }

        /* Spalvotas b≈´senos dropdown'as */
        .status-dropdown { width: 100%; padding: 4px; font-size: 11px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .status-dropdown.status-new { background: #f8d7da; color: #721c24; border-color: #f1b0b7; }
        .status-dropdown.status-pending { background: #fff3cd; color: #856404; border-color: #ffeaa7; }
        .status-dropdown.status-approved { background: #d4edff; color: #004085; border-color: #b8daff; }
        .status-dropdown.status-sent { background: #17a2b8; color: white; border-color: #138496; }
        .status-dropdown.status-resolved { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-dropdown.status-rejected { background: #e9ecef; color: #495057; border-color: #ced4da; }

        /* Modaliniai langai */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: var(--white); padding: 20px; border-radius: 10px; width: 90%; max-width: 700px; box-shadow: 0 4px 30px rgba(0,0,0,0.3); font-size: 11px; position: relative; }
        .close { color: var(--gray); float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: var(--dark); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); font-size: 12px; }
        .form-group textarea, .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-size: 11px; }
        .comment-box button { margin-top: 10px; padding: 10px 16px; background: var(--primary-light); color: var(--white); border: none; border-radius: 6px; cursor: pointer; }

        footer { text-align: center; margin-top: 40px; color: var(--gray); font-size: 12px; border-top: 1px solid #dee2e6; padding-top: 20px; background: var(--secondary); }

        /* Puslapiavimas */
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 10px; background: var(--white); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .pagination-info { font-size: 12px; color: var(--gray); }
        .pagination-buttons { display: flex; gap: 10px; }
        .pagination-btn { padding: 6px 12px; background: var(--primary-light); color: var(--white); border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .pagination-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Redaguojami laukai */
        .repair-cost-input { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; }
        .product-id-input { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; } /* NEW: atskira klasƒó */
        .product-edit-input { width: 100%; padding: 2px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px; line-height: 1.2; }

        @media (max-width: 600px) {
            .filters { flex-direction: column; }
            .stats-bar { flex-direction: column; gap: 6px; }
            th, td { padding: 4px 6px; font-size: 10px; }
            .pagination { flex-direction: column; gap: 10px; }
        }
    </style>

<style>
.comm-head{width:36px;text-align:center}
.comm-cell{text-align:center}
.comm-icon{display:inline-block;position:relative;font-size:18px;line-height:1}
.comm-badge{position:absolute;top:-6px;right:-10px;background:#ef4444;color:#fff;border-radius:999px;
  padding:0 6px;font-size:11px;line-height:18px;min-width:18px;border:2px solid #fff}
.comm-muted{opacity:.35}
.comm-btn{background:transparent;border:none;cursor:pointer;font-size:18px}
</style>

</head>
<body>
<header>
    <img src="logo.jpg" alt="Rubineta Logo" class="logo" onclick="location.href='index.html'">
    <nav>
        <a href="index.html">Pagrindinis</a>
        <a href="duku.html">DUK</a>
        <a href="login.html">Prisijungti</a>
        <a href="catalog-table.html">Produkt≈≥ katalogas</a>
    </nav>
</header>

<main>
    <h1>Administratoriaus zona</h1>

    <!-- Skirtukai -->
    <div class="tabs">
        <div class="tab active" onclick="openTab('claims')">Pretenzijos</div>
        <div class="tab" onclick="openTab('feedback')">Atsiliepimai</div>
        <div class="tab" onclick="openTab('users')">Vartotojai</div>
        <div class="tab" onclick="openTab('partners')">Serviso partneriai</div>
    </div>

    <!-- Skirtukas: Pretenzijos -->
    <div id="claims" class="tab-content active">
        <!-- Statistika -->
        <div class="stats-bar">
            <div class="stat-item"><span class="label">Pretenzij≈≥ sk.</span><span class="value" id="total-claims">0</span></div>
            <div class="stat-item"><span class="label">Vid. atsakymo laikas</span><span class="value" id="avg-response">24 val.</span></div>
            <div class="stat-item"><span class="label">Da≈æniausi brokai</span><span class="value" id="top-issue">U≈æsikim≈°ƒôs aeratorius</span></div>
            <div class="stat-item"><span class="label">Pop. produktai</span><span class="value" id="top-product">ECOSENS</span></div>
        </div>

        <!-- Veiksmai -->
        <div class="filters">
            <button onclick="exportToCSV(false)" class="btn btn-export">Eksportuoti visus (pagal filtrƒÖ)</button> <!-- NEW -->
            <button onclick="exportToCSV(true)" class="btn btn-export">Eksportuoti tik ≈°ƒØ puslapƒØ</button> <!-- NEW -->
        </div>

        <!-- Pretenzij≈≥ lentelƒó -->
        <table id="claims-table">
            <thead>
            <tr>
                <th class="comm-head" title="Naujos ≈æinutƒós">‚úâÔ∏è</th>
                <th style="width: 6%;">ID<br><input type="text" id="filter-id" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 6%;">Data<br>
                    <input type="date" id="filter-date-from-header" class="inline-filter" onchange="applyInlineFilters()">‚Äì<br>
                    <input type="date" id="filter-date-to-header" class="inline-filter" onchange="applyInlineFilters()">
                </th>
                <th style="width: 8%;">Vartotojas<br><input type="text" id="filter-user" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 6%;">Miestas<br><input type="text" id="filter-city" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 8%;">Produktas<br><input type="text" id="filter-product" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 6%;">Produkto ID<br><input type="text" id="filter-product-id" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 10%;">Problema<br><input type="text" id="filter-problem" class="inline-filter" placeholder="Raktiniai ≈æod≈æiai" oninput="applyInlineFilters()"></th>
                <th style="width: 8%;">Gedimo r≈´≈°is<br>
                    <select id="filter-issue-type" class="inline-filter" onchange="applyInlineFilters()">
                        <option value="">Visi</option>
                        <option value="Nutekƒójimai (Leaking Issues)">Nutekƒójimai</option>
                        <option value="Liejimo defektai (Casting Defects)">Liejimo defektai</option>
                        <option value="Snapo problemos (Spout Problems)">Snapo problemos</option>
                        <option value="Mygtuk≈≥ ar vo≈ætuv≈≥ gedimai (Button or Valve Issues)">Mygtuk≈≥ gedimai</option>
                        <option value="Sukimosi ir judƒójimo problemos (Rotation and Movement Issues)">Judƒójimo klaidos</option>
                        <option value="Pavir≈°iaus ir dangos problemos (Surface and Coating Problems)">Dangos defektai</option>
                        <option value="Tr≈´kstamos dalys (Missing Parts)">Tr≈´kstamos dalys</option>
                        <option value="Montavimo problemos (Installation Issues)">Montavimo klaidos</option>
                        <option value="Kitos kokybƒós problemos (Other Quality Issues)">Kitos</option>
                    </select>
                </th>
                <th style="width: 6%;">Remonto kaina<br><input type="number" step="0.01" id="filter-repair-cost" class="inline-filter" placeholder="‚â• suma" oninput="applyInlineFilters()"></th>
                <th style="width: 8%;">Meistras<br><input type="text" id="filter-master" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 8%;">Atsakingas<br><input type="text" id="filter-responsible" class="inline-filter" placeholder="Ie≈°koti..." oninput="applyInlineFilters()"></th>
                <th style="width: 8%;">Koment<br><input type="text" id="filter-comment" class="inline-filter" placeholder="Raktiniai ≈æod≈æiai" oninput="applyInlineFilters()"></th>
                <th style="width: 6%;">B≈´sena<br>
                    <select id="filter-status" class="inline-filter" onchange="applyInlineFilters()">
                        <option value="">Visi</option>
                        <option value="Nauja">Nauja</option>
                        <option value="Laukia patvirtinimo">Laukia</option>
                        <option value="Patvirtinta">Patvirtinta</option>
                        <option value="Perduota servisui">Perduota</option>
                        <option value="I≈°sprƒôsta">I≈°sprƒôsta</option>
                        <option value="Atmesta">Atmesta</option>
                    </select>
                </th>
            </tr>
            </thead>
            <tbody id="claims-body">
            <tr><td colspan="13" style="text-align: center;">Kraunama...</td></tr>
            </tbody>
        </table>

        <!-- Puslapiavimas -->
        <div class="pagination">
            <div class="pagination-info" id="pagination-info">Rodoma 0-0 i≈° 0</div>
            <div class="pagination-buttons">
                <button class="pagination-btn" id="prev-page" onclick="changePage(-1)">Ankstesnis</button>
                <button class="pagination-btn" id="next-page" onclick="changePage(1)">Kitas</button>
            </div>
        </div>
    </div>

    <!-- Skirtukas: Vartotojai -->
    <div id="users" class="tab-content">
        <h2>Vartotoj≈≥ sƒÖra≈°as</h2>
        <table>
            <thead>
            <tr>
                <th>Vardas</th>
                <th>Pavardƒó</th>
                <th>Rolƒó</th>
                <th>B≈´sena</th>
                <th>El. pa≈°tas</th>
                <th>Telefonas</th>
                <th>Miestas</th>
                <th>Veiksmai</th>
            </tr>
            </thead>
            <tbody id="users-body">
            <tr><td colspan="8" style="text-align: center;">Kraunama...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Skirtukas: Atsiliepimai -->
    <div id="feedback" class="tab-content"></div>

    <!-- Skirtukas: Serviso partneriai -->
    <div id="partners" class="tab-content">
        <h2>Serviso partneriai</h2>
        <div class="filters">
            <input type="text" id="filter-partner-name" placeholder="Ie≈°koti pagal pavadinimƒÖ">
            <input type="text" id="filter-partner-city" placeholder="Ie≈°koti pagal miestƒÖ">
            <button onclick="filterPartners()" class="btn btn-primary">Filtruoti</button>
            <button onclick="openAddPartnerModal()" class="btn btn-primary">+ Pridƒóti partnerƒØ</button>
        </div>

        <table id="partners-table">
            <thead>
            <tr>
                <th>Pavadinimas</th>
                <th>Kontaktinis asmuo</th>
                <th>Kontaktai</th>
                <th>Veiklos zona</th>
                <th>Veiksmai</th>
            </tr>
            </thead>
            <tbody id="partners-body">
            <tr><td colspan="5" style="text-align: center;">Kraunama...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<!-- Pretenzijos modalas -->
<div id="claimModal" class="modal">
    <div class="modal-content">
        <div id="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 id="modal-title">Pretenzijos per≈æi≈´ra</h2>
            <div id="modal-actions">
                <button onclick="openClaimViewPage()" class="btn btn-export" style="padding: 5px 10px; font-size: 11px; margin-right: 10px;">Per≈æi≈´rƒóti atskirai</button>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<!-- Partnerio modalas -->
<div id="partnerModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closePartnerModal()">&times;</span>
        <h2 id="partnerModalTitle">Pridƒóti partnerƒØ</h2>
        <form id="partner-form">
            <input type="hidden" id="edit-partner-id">
            <div class="form-group">
                <label for="partner-name">Pavadinimas *</label>
                <input type="text" id="partner-name" required>
            </div>
            <div class="form-group">
                <label for="partner-contact">Kontaktinis asmuo *</label>
                <input type="text" id="partner-contact" required>
            </div>
            <div class="form-group">
                <label for="partner-phone">Telefonas *</label>
                <input type="tel" id="partner-phone" required>
            </div>
            <div class="form-group">
                <label for="partner-email">El. pa≈°tas *</label>
                <input type="email" id="partner-email" required>
            </div>
            <div class="form-group">
                <label for="partner-cities">Veiklos zonos (miestai)</label>
                <input type="text" id="partner-cities" placeholder="pvz., Vilnius, Kaunas">
            </div>
            <button type="button" onclick="savePartner()" class="btn btn-primary">I≈°saugoti</button>
        </form>
    </div>
</div>

<footer>¬© 2025 Rubineta. Visos teisƒós saugomos. | info@rubineta.lt</footer>

<script>
/* =================== BENDRI KINTAMIEJI =================== */
let currentPage = 1;
const itemsPerPage = 20;
let totalClaims = 0;
let filteredClaims = [];
let currentFilters = null;
let sortKey = null;     // NEW: paprastas rikiavimas
let sortDir = 'asc';    // 'asc' | 'desc'

/* =================== PRIEIGOS KONTROLƒñ =================== */
const currentUser = JSON.parse(localStorage.getItem('currentUser'));
if (!currentUser || !['admin', 'quality'].includes(currentUser.role)) {
    alert('Prieiga draud≈æiama. Reikalingos administratoriaus teisƒós.');
    location.href = 'index.html';
}

/* =================== PADƒñTINƒñS FUNKCIJOS =================== */
function setModalHeader(title, showViewSeparately = false) {
    document.getElementById('modal-title').textContent = title;
    const viewBtn = document.querySelector('#modal-actions .btn-export');
    if (viewBtn) viewBtn.style.display = showViewSeparately ? 'inline-block' : 'none';
}
function getStatusClass(status) {
    switch (status) {
        case 'Nauja': return 'new';
        case 'Laukia patvirtinimo': return 'pending';
        case 'Patvirtinta': return 'approved';
        case 'Perduota servisui': return 'sent';
        case 'I≈°sprƒôsta': return 'resolved';
        case 'Atmesta': return 'rejected';
        default: return 'new';
    }
}
function safeLower(v){ return (v ?? '').toString().toLowerCase(); } // NEW: null-safe

/* =================== SKIRTUKAI =================== */
function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`.tab[onclick="openTab('${tabName}')"]`).classList.add('active');

    if (tabName === 'claims') loadClaims();
    else if (tabName === 'feedback') loadFeedback();
    else if (tabName === 'users') loadUsers();
    else if (tabName === 'partners') loadPartners();
}

/* =================== PRETENZIJOS: NUSKAITYMAS/PIE≈†IMAS =================== */
function loadClaims(filteredData = null) {
    const claims = filteredData || JSON.parse(localStorage.getItem('claims') || '[]');
    filteredClaims = claims;
    totalClaims = claims.length;
    applySort(); // NEW: pritaikome rikiavimƒÖ jei yra
    renderClaims();
}

function applySort(){ // NEW: paprasta rikiavimo logika 3 laukams
    if(!sortKey) return;
    const dir = sortDir === 'asc' ? 1 : -1;
    filteredClaims.sort((a,b)=>{
        let va, vb;
        if (sortKey === 'date'){ va = new Date(a.date||0).getTime(); vb = new Date(b.date||0).getTime(); }
        else if (sortKey === 'id'){ va = (a.id||'').toString(); vb = (b.id||'').toString(); }
        else if (sortKey === 'repairCost'){ va = parseFloat(a.repairCost||0); vb = parseFloat(b.repairCost||0); }
        else { return 0; }
        if (va < vb) return -1*dir;
        if (va > vb) return 1*dir;
        return 0;
    });
}

function toggleSort(key){ // NEW: kvieƒçiama ant TH (pridƒóta event listener DOMContentLoaded)
    if (sortKey === key) sortDir = (sortDir === 'asc' ? 'desc' : 'asc');
    else { sortKey = key; sortDir = 'asc'; }
    applySort();
    currentPage = 1;
    renderClaims();
}

function renderClaims() {
    const tbody = document.getElementById('claims-body');
    tbody.innerHTML = '';

    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, totalClaims);
    const pageClaims = filteredClaims.slice(startIndex, endIndex);

    if (pageClaims.length === 0) {
        tbody.innerHTML = '<tr><td colspan="13" style="text-align: center;">Nerasta pretenzij≈≥</td></tr>'; // FIX: colspan
    } else {
        pageClaims.forEach(claim => {
            const masterCell = claim.assignedPartner
                ? `<span>${claim.assignedPartner}</span>`
                : `<button class="btn btn-primary" onclick="showAssignModal('${claim.id}')">Priskirti meistrui</button>`;

            const responsibleCell = claim.responsible
                ? `<a href="#" onclick="event.preventDefault(); showResponsibleModal('${claim.id}');">${claim.responsible}</a>`
                : `<a href="#" onclick="event.preventDefault(); showResponsibleModal('${claim.id}');">Paskirti atsakingƒÖ</a>`;

            const commentCell = claim.qualityComment || '-------';
            const repairCost = claim.repairCost || '';
            const productId = claim.productId || '';
            const issueType = claim.issueType || 'Kitos kokybƒós problemos (Other Quality Issues)';

            // Redaguojamas produkto pavadinimas
            const productInput = `<input type="text" class="product-edit-input" value="${claim.product || ''}"
                                  data-id="${claim.id}" onchange="updateProduct('${claim.id}', this.value)">`;

            // NEW: inline gedimo r≈´≈°ies dropdown
            const issueTypes = [
                "Nutekƒójimai (Leaking Issues)",
                "Liejimo defektai (Casting Defects)",
                "Snapo problemos (Spout Problems)",
                "Mygtuk≈≥ ar vo≈ætuv≈≥ gedimai (Button or Valve Issues)",
                "Sukimosi ir judƒójimo problemos (Rotation and Movement Issues)",
                "Pavir≈°iaus ir dangos problemos (Surface and Coating Problems)",
                "Tr≈´kstamos dalys (Missing Parts)",
                "Montavimo problemos (Installation Issues)",
                "Kitos kokybƒós problemos (Other Quality Issues)"
            ];
            const issueSelect = `
                <select class="inline-issue-select" onchange="updateIssueType('${claim.id}', this.value)" style="width:100%; padding:4px;">
                    ${issueTypes.map(t => `<option value="${t}" ${t===issueType?'selected':''}>${t}</option>`).join('')}
                </select>
            `;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class=\"comm-cell\" data-claim=\"${claim.id}\"></td>
<td><a href="#" onclick="event.preventDefault(); viewClaimDetails('${claim.id}');">${claim.id}</a></td>
                <td>${claim.date ? new Date(claim.date).toLocaleDateString('lt-LT') : ''}</td>
                <td>${safeLower((claim.contact?.name||'')) ? `${claim.contact.name} ${claim.contact?.surname||''}` : ''}</td>
                <td>${claim.contact?.city || ''}</td>
                <td>${productInput}</td>
                <td><input type="text" class="product-id-input" value="${productId}" placeholder="pvz., SKU-123"
                           onchange="updateProductId('${claim.id}', this.value)"></td>
                <td>${(claim.description||'').substring(0, 30)}${(claim.description||'').length>30?'...':''}</td>
                <td>${issueSelect}</td>
                <td><input type="number" step="0.01" class="repair-cost-input" value="${repairCost}" placeholder="‚Ç¨"
                           onchange="updateRepairCost('${claim.id}', this.value)"></td>
                <td>${masterCell}</td>
                <td>${responsibleCell}</td>
                <td>${commentCell}</td>
                <td>
                    <select class="status-dropdown status-${getStatusClass(claim.status)}"
                            onchange="updateStatusDirectly('${claim.id}', this.value)">
                        <option value="Nauja" ${claim.status === 'Nauja' ? 'selected' : ''}>Nauja</option>
                        <option value="Laukia patvirtinimo" ${claim.status === 'Laukia patvirtinimo' ? 'selected' : ''}>Laukia patvirtinimo</option>
                        <option value="Patvirtinta" ${claim.status === 'Patvirtinta' ? 'selected' : ''}>Patvirtinta</option>
                        <option value="Perduota servisui" ${claim.status === 'Perduota servisui' ? 'selected' : ''}>Perduota servisui</option>
                        <option value="I≈°sprƒôsta" ${claim.status === 'I≈°sprƒôsta' ? 'selected' : ''}>I≈°sprƒôsta</option>
                        <option value="Atmesta" ${claim.status === 'Atmesta' ? 'selected' : ''}>Atmesta</option>
                    </select>
                </td>
            `;
            
            tr.setAttribute('data-claim-id', claim.id);
tbody.appendChild(tr);
        });
    }

    updateCommBadges();

    // Puslapiavimo info
    document.getElementById('pagination-info').textContent = `Rodoma ${totalClaims ? (startIndex + 1) : 0}-${endIndex} i≈° ${totalClaims}`;

    // Mygtukai
    document.getElementById('prev-page').disabled = currentPage === 1;
    document.getElementById('next-page').disabled = endIndex >= totalClaims;

    // Statistika
    document.getElementById('total-claims').textContent = totalClaims;
}

/* =================== REDAGAVIMO FUNKCIJOS =================== */
function updateProduct(id, newProduct) {
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim && newProduct.trim() !== '') {
        claim.product = newProduct.trim();
        localStorage.setItem('claims', JSON.stringify(claims));
        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) filteredClaim.product = newProduct.trim();
    }
}
function updateProductId(id, newId) {
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        claim.productId = (newId || '').trim();
        localStorage.setItem('claims', JSON.stringify(claims));
        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) filteredClaim.productId = (newId || '').trim();
    }
}
function updateIssueType(id, newType) {
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        claim.issueType = (newType || '').trim();
        localStorage.setItem('claims', JSON.stringify(claims));
        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) filteredClaim.issueType = (newType || '').trim();
    }
}
function updateRepairCost(id, newCost) {
    const val = (newCost ?? '').toString().replace(',', '.');
    if (val !== '' && isNaN(parseFloat(val))) {
        alert('Neteisinga suma. Naudokite skaiƒçi≈≥ (pvz., 85.50)');
        renderClaims();
        return;
    }
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        claim.repairCost = val;
        localStorage.setItem('claims', JSON.stringify(claims));
        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) filteredClaim.repairCost = val;
    }
}
function updateIssueTypeInModal(id, newType) { // naud. modalui
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const idx = claims.findIndex(c => c.id === id);
    if (idx !== -1) {
        claims[idx].issueType = newType;
        localStorage.setItem('claims', JSON.stringify(claims));
        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) filteredClaim.issueType = newType;
        renderClaims();
    }
}

/* =================== B≈™SENA =================== */
function updateStatusDirectly(id, newStatus) {
    if (!confirm(`Ar tikrai norite pakeisti b≈´senƒÖ ƒØ "${newStatus}"?`)) { loadClaims(); return; }
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        claim.status = newStatus;
        if (['Nauja', 'Laukia patvirtinimo'].includes(newStatus)) claim.assignedPartner = null;
        localStorage.setItem('claims', JSON.stringify(claims));

        const filteredClaim = filteredClaims.find(c => c.id === id);
        if (filteredClaim) {
            filteredClaim.status = newStatus;
            if (['Nauja', 'Laukia patvirtinimo'].includes(newStatus)) filteredClaim.assignedPartner = null;
        }
        currentFilters ? applyInlineFilters() : loadClaims();
    }
}

/* =================== PRISKYRIMAS / MODALAI =================== */
let tempAttachments = []; // laikini prisegimai priskyrimo modalui
function showAssignModal(id) {
    tempAttachments = [];
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (!claim) return;

    const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    let partnerSelect = `<select id="assign-partner-select" style="width:100%; padding:5px; margin-bottom:10px;">`;
    partnerSelect += `<option value="">Pasirinkite meistrƒÖ...</option>`;
    partners.forEach(p => {
        partnerSelect += `<option value="${p.name} ‚Äì ${p.cities}">${p.name} ‚Äì ${p.cities}</option>`;
    });
    partnerSelect += `</select>`;

    document.getElementById('modal-body').innerHTML = `
        <div class="modal-section">
            <h3>Priskirti pretenzijƒÖ meistrui</h3>
            <p><strong>ID:</strong> ${claim.id}</p>
            <p><strong>Produktas:</strong> ${claim.product||''}</p>
            <p><strong>Apra≈°ymas:</strong> ${claim.description||''}</p>
            ${partnerSelect}

            <div class="form-group">
                <label for="quality-note">Rekomendacija partneriui</label>
                <textarea id="quality-note" placeholder="ƒÆra≈°ykite pastabas, kƒÖ verta patikrinti...">${claim.qualityNote || ''}</textarea>
            </div>

            <div class="form-group">
                <label for="attachment-type">Prisegti dokumentƒÖ</label>
                <select id="attachment-type" onchange="updateAttachmentInput()">
                    <option value="file">Failas (PDF, nuotrauka)</option>
                    <option value="video">Video nuoroda (YouTube)</option>
                    <option value="link">Nuoroda ƒØ instrukcijƒÖ</option>
                </select>
                <input type="file" id="attachment-file" accept="image/*,video/*,.pdf,.doc,.docx" style="margin-top:5px;" />
                <input type="text" id="attachment-url" placeholder="ƒÆveskite nuorodƒÖ (pvz., YouTube URL)" style="margin-top:5px; display:none;" />
                <button type="button" onclick="addAttachment()" style="margin-top:5px; padding:5px 10px; font-size:11px;">+ Pridƒóti</button>
            </div>

            <div id="attachments-list" style="margin:10px 0; font-size:11px;"></div>

            <button class="btn-small btn-assign" onclick="assignToPartner('${claim.id}')">Patvirtinti ir i≈°si≈≥sti partneriui</button>
        </div>
    `;

    if (claim.qualityAttachments?.length) {
        tempAttachments = [...claim.qualityAttachments];
        updateAttachmentsList();
    }

    setModalHeader('Priskirti meistrui', false);
    document.getElementById('claimModal').style.display = 'flex';
}
function updateAttachmentInput(){
    const t = document.getElementById('attachment-type').value;
    document.getElementById('attachment-file').style.display = (t==='file')?'block':'none';
    document.getElementById('attachment-url').style.display = (t!=='file')?'block':'none';
}
function addAttachment(){
    const t = document.getElementById('attachment-type').value;
    if (t==='file'){
        const f = document.getElementById('attachment-file').files[0];
        if(!f){ alert('Pasirinkite failƒÖ.'); return; }
        tempAttachments.push({type:'file', name:f.name, url:f.name});
    } else {
        const url = (document.getElementById('attachment-url').value||'').trim();
        if(!url){ alert('ƒÆveskite nuorodƒÖ.'); return; }
        tempAttachments.push({type:t, name: t==='video'?'Video':'Nuoroda', url});
    }
    updateAttachmentsList();
    document.getElementById('attachment-url').value='';
    document.getElementById('attachment-file').value='';
}
function updateAttachmentsList(){
    const wrap = document.getElementById('attachments-list');
    wrap.innerHTML = tempAttachments.map((a,i)=>`<div>üìé ${a.type.toUpperCase()}: <a href="${a.url}" target="_blank">${a.name}</a> <button onclick="tempAttachments.splice(${i},1);updateAttachmentsList()">≈°alinti</button></div>`).join('') || '<div>Nƒóra prisegt≈≥</div>';
}
function assignToPartner(id){
    const select = document.getElementById('assign-partner-select');
    const partner = select.value;
    if(!partner){ alert('Pasirinkite meistrƒÖ.'); return; }
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const c = claims.find(x=>x.id===id);
    if (c){
        c.assignedPartner = partner;
        c.qualityNote = document.getElementById('quality-note').value||'';
        c.qualityAttachments = tempAttachments;
        c.status = 'Perduota servisui';
        localStorage.setItem('claims', JSON.stringify(claims));
        closeModal();
        loadClaims();
    }
}

function openModal(content) {
    document.getElementById('modal-body').innerHTML = content;
    document.getElementById('claimModal').style.display = 'flex';
}
function closeModal() { document.getElementById('claimModal').style.display = 'none'; }
function closePartnerModal(){ document.getElementById('partnerModal').style.display='none'; }

/* NEW: u≈ædaryti modalƒÖ spustelƒójus fonƒÖ */
document.getElementById('claimModal').addEventListener('click', (e)=>{ if(e.target.id==='claimModal') closeModal(); });
document.getElementById('partnerModal').addEventListener('click', (e)=>{ if(e.target.id==='partnerModal') closePartnerModal(); });

function openClaimViewPage() {
    const claimId = document.getElementById('claim-id')?.textContent;
    if (claimId) window.open(`claim-view.html?id=${claimId}`, '_blank');
    else alert('Nepavyko gauti pretenzijos ID.');
}

/* =================== FILTRAVIMAS =================== */
// VIENINTELƒñ versija (FIX): suvienodinta su thead input ID
function applyInlineFilters() {
    const allClaims = JSON.parse(localStorage.getItem('claims') || '[]');

    const id = safeLower(document.getElementById('filter-id').value.trim());
    const dateFrom = document.getElementById('filter-date-from-header').value;
    const dateTo = document.getElementById('filter-date-to-header').value;
    const user = safeLower(document.getElementById('filter-user').value.trim());
    const city = safeLower(document.getElementById('filter-city').value.trim());
    const product = safeLower(document.getElementById('filter-product').value.trim());
    const productId = safeLower(document.getElementById('filter-product-id').value.trim());
    const problem = safeLower(document.getElementById('filter-problem').value.trim());
    const issueType = document.getElementById('filter-issue-type').value;
    const repairCost = parseFloat((document.getElementById('filter-repair-cost').value||'').replace(',','.'));
    const master = safeLower(document.getElementById('filter-master').value.trim());
    const responsible = safeLower(document.getElementById('filter-responsible').value.trim());
    const status = document.getElementById('filter-status').value;
    const comment = safeLower(document.getElementById('filter-comment').value.trim());

    const filtered = allClaims.filter(c => {
        const cId = safeLower(c.id);
        const cDate = (c.date || '');
        const cUser = safeLower(`${c.contact?.name||''} ${c.contact?.surname||''}`);
        const cCity = safeLower(c.contact?.city||'');
        const cProduct = safeLower(c.product||'');
        const cProductId = safeLower(c.productId||'');
        const cDesc = safeLower(c.description||'');
        const cIssue = c.issueType || '';
        const cRepair = parseFloat(c.repairCost||'0');
        const cMaster = safeLower(c.assignedPartner||'');
        const cResp = safeLower(c.responsible||'');
        const cStatus = c.status || '';
        const cComment = safeLower(c.qualityComment||'');

        return (
            (id === '' || cId.includes(id)) &&
            (dateFrom === '' || cDate >= dateFrom + 'T00:00:00') &&
            (dateTo === '' || cDate <= dateTo + 'T23:59:59') &&
            (user === '' || cUser.includes(user)) &&
            (city === '' || cCity.includes(city)) &&
            (product === '' || cProduct.includes(product)) &&
            (productId === '' || cProductId.includes(productId)) &&
            (problem === '' || cDesc.includes(problem)) &&
            (issueType === '' || cIssue === issueType) &&
            (isNaN(repairCost) || cRepair >= repairCost) &&
            (master === '' || cMaster.includes(master)) &&
            (responsible === '' || cResp.includes(responsible)) &&
            (status === '' || cStatus === status) &&
            (comment === '' || cComment.includes(comment))
        );
    });

    filteredClaims = filtered;
    totalClaims = filtered.length;
    currentPage = 1;
    applySort(); // laikomƒós aktyvaus rikiavimo
    renderClaims();
}

/* =================== CSV EKSPORTAS =================== */
// NEW: parametras pageOnly ‚Äì eksportuoti tik ≈°ƒØ puslapƒØ
function exportToCSV(pageOnly = false) {
    const headers = ['ID','Data','Vardas','Pavardƒó','El. pa≈°tas','Telefonas','Produktas','Apra≈°ymas','B≈´sena','Miestas','Priskirtas meistras','Komentaras','Remonto kaina','Produkto ID','Gedimo r≈´≈°is'];

    let data = filteredClaims;
    if (pageOnly) {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, totalClaims);
        data = filteredClaims.slice(startIndex, endIndex);
    }

    const rows = data.map(c => [
        c.id || '',
        c.date ? new Date(c.date).toLocaleDateString('lt-LT') : '',
        c.contact?.name || '',
        c.contact?.surname || '',
        c.contact?.email || '',
        c.contact?.phone || '',
        c.product || '',
        (c.description || '').replace(/"/g, '""'),
        c.status || '',
        c.contact?.city || '',
        c.assignedPartner || '',
        (c.qualityComment || '').replace(/"/g, '""'),
        c.repairCost || '',
        c.productId || '',
        c.issueType || ''
    ]);

    const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `pretenzijos_${new Date().toISOString().split('T')[0]}${pageOnly?'_puslapis':''}.csv`;
    link.click();
    URL.revokeObjectURL(url);
}

/* =================== ATSILIEPIMAI / VARTOTOJAI / PARTNERIAI =================== */
function loadFeedback() {
    const feedbacks = JSON.parse(localStorage.getItem('feedbacks') || '[]');
    const content = `
        <h2>Klient≈≥ atsiliepimai</h2>
        <table>
            <thead>
                <tr>
                    <th>Pretenzijos ID</th>
                    <th>Data</th>
                    <th>Greitis</th>
                    <th>Kokybƒó</th>
                    <th>Mandagumas</th>
                    <th>NPS</th>
                    <th>Komentaras</th>
                </tr>
            </thead>
            <tbody>
                ${
                    feedbacks.length === 0
                    ? '<tr><td colspan="7" style="text-align:center;">Nƒóra atsiliepim≈≥.</td></tr>'
                    : feedbacks.map(f => `
                        <tr>
                            <td>${f.claimId}</td>
                            <td>${new Date(f.date).toLocaleDateString('lt-LT')}</td>
                            <td>${f.ratings?.speed ?? ''}</td>
                            <td>${f.ratings?.quality ?? ''}</td>
                            <td>${f.ratings?.politeness ?? ''}</td>
                            <td>${f.ratings?.nps ?? ''}</td>
                            <td>${f.comments ?? ''}</td>
                        </tr>
                    `).join('')
                }
            </tbody>
        </table>
    `;
    document.getElementById('feedback').innerHTML = content;
}

function loadUsers() {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const tbody = document.getElementById('users-body');
    tbody.innerHTML = '';

    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Nƒóra vartotoj≈≥.</td></tr>';
        return;
    }

    users.forEach(user => {
        const actions = getActionsForUser(user);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${user.name||''}</td>
            <td>${user.surname||''}</td>
            <td>${user.role||''}</td>
            <td>${user.role === 'installer' && user.status === 'pending'
                    ? `<a href="#" onclick="event.preventDefault(); viewInstallerDocs('${user.id}')">Dokumentai</a>`
                    : (user.status||'')}</td>
            <td>${user.email||''}</td>
            <td>${user.phone||''}</td>
            <td>${user.city||''}</td>
            <td>${actions}</td>
        `;
        tbody.appendChild(tr);
    });
}
function getActionsForUser(user) {
    if (user.role === 'installer' && user.status === 'pending') {
        return `
            <button class="btn btn-primary" onclick="approveInstaller('${user.id}')">Patvirtinti</button>
            <button class="btn btn-danger" onclick="openRejectionModal('${user.id}')">Atmesti</button>
        `;
    } else {
        return `<button class="btn btn-primary" onclick="viewUserHistory('${user.id}')">Per≈æi≈´rƒóti istorijƒÖ</button>`;
    }
}

function loadPartners() {
    const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    const tbody = document.getElementById('partners-body');
    tbody.innerHTML = '';

    if (partners.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nƒóra serviso partneri≈≥.</td></tr>';
        return;
    }

    partners.forEach(partner => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${partner.name||''}</td>
            <td>${partner.contactPerson||''}</td>
            <td><strong>Tel:</strong> ${partner.phone||''}<br><strong>El. pa≈°tas:</strong> ${partner.email||''}</td>
            <td>${partner.cities||''}</td>
            <td>
                <button class="btn btn-primary" onclick="openEditPartnerModal('${partner.id}')">Redaguoti</button>
                <button class="btn btn-danger" onclick="deletePartner('${partner.id}')">I≈°trinti</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* =================== MODALINƒñ PRETENZIJA =================== */
function showResponsibleModal(id) {
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        setModalHeader('Paskirti atsakingƒÖ', false);

        const adminUsers = JSON.parse(localStorage.getItem('adminUsers') || '[]');
        let userOptions = '<option value="">Pasirinkite atsakingƒÖ...</option>';
        adminUsers.forEach(user => {
            const full = `${user.name} ${user.surname}`;
            userOptions += `<option value="${full}" ${claim.responsible === full ? 'selected' : ''}>${full} (${user.role})</option>`;
        });

        const modalBody = `
            <div class="modal-section">
                <h3>Paskirti atsakingƒÖ kokybƒós skyriaus darbuotojƒÖ</h3>
                <p><strong>Pretenzijos ID:</strong> ${claim.id}</p>
                <p><strong>Produktas:</strong> ${claim.product||''}</p>
                <p><strong>Apra≈°ymas:</strong> ${claim.description||''}</p>
                <select id="responsible-select">${userOptions}</select>
                <button class="btn-small btn-primary" onclick="assignResponsible('${claim.id}')">Paskirti</button>
            </div>
        `;
        openModal(modalBody);
    }
}
function assignResponsible(id) {
    const selectedResponsible = document.getElementById('responsible-select').value;
    if (!selectedResponsible) { alert('Pasirinkite atsakingƒÖ.'); return; }
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (claim) {
        claim.responsible = selectedResponsible;
        localStorage.setItem('claims', JSON.stringify(claims));
        alert(`Atsakingas paskirtas: ${selectedResponsible}`);
        closeModal();
        currentFilters ? applyInlineFilters() : loadClaims();
    }
}

function viewClaimDetails(id) {
    
    try{ localStorage.setItem(`chatSeen_admin_${id}`, String(Date.now())); }catch(e){}
const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (!claim) return;

    if (!claim.issueType) claim.issueType = "Kitos kokybƒós problemos (Other Quality Issues)";

    const issueTypes = [
        "Nutekƒójimai (Leaking Issues)",
        "Liejimo defektai (Casting Defects)",
        "Snapo problemos (Spout Problems)",
        "Mygtuk≈≥ ar vo≈ætuv≈≥ gedimai (Button or Valve Issues)",
        "Sukimosi ir judƒójimo problemos (Rotation and Movement Issues)",
        "Pavir≈°iaus ir dangos problemos (Surface and Coating Problems)",
        "Tr≈´kstamos dalys (Missing Parts)",
        "Montavimo problemos (Installation Issues)",
        "Kitos kokybƒós problemos (Other Quality Issues)"
    ];
    const issueOptions = issueTypes.map(type => `<option value="${type}" ${claim.issueType === type ? 'selected' : ''}>${type}</option>`).join('');

    let fileListHtml = '<div class="file-list">';
    if (claim.files?.length) {
        claim.files.forEach(file => { fileListHtml += `<div class="file-item">üìé ${file}</div>`; });
    } else {
        fileListHtml += '<div class="file-item">Nƒóra ƒØkelt≈≥ fail≈≥</div>';
    }
    fileListHtml += '</div>';

    setModalHeader('Pretenzijos per≈æi≈´ra', true);
    document.getElementById('modal-body').innerHTML = `
        <div class="modal-section">
            <h3>Pagrindinƒó informacija</h3>
            <p><strong>ID:</strong> <span id="claim-id">${claim.id}</span></p>
            <p><strong>Data:</strong> ${claim.date ? new Date(claim.date).toLocaleString('lt-LT') : ''}</p>
            <p><strong>Tema:</strong> ${claim.topic||''}</p>
            <p><strong>Veiklos tipas:</strong> ${claim.role||''}</p>
            <p><strong>Produktas:</strong> ${claim.product||''}</p>
            <p><strong>Apra≈°ymas:</strong> ${claim.description||''}</p>
            <p><strong>Kliento reikalavimas:</strong> ${claim.request||''}</p>
            <p><strong>Gedimo r≈´≈°is:</strong>
                <select id="issue-type-select" onchange="updateIssueTypeInModal('${claim.id}', this.value)" style="width:100%;">
                    ${issueOptions}
                </select>
            </p>
        </div>
        <div class="modal-section">
            <h3>Kontaktiniai duomenys</h3>
            <p><strong>Vardas:</strong> ${claim.contact?.name||''} ${claim.contact?.surname||''}</p>
            <p><strong>El. pa≈°tas:</strong> ${claim.contact?.email||''}</p>
            <p><strong>Telefonas:</strong> ${claim.contact?.phone||''}</p>
            <p><strong>Adresas:</strong> ${claim.contact?.street||''}, ${claim.contact?.city||''}, ${claim.contact?.postal||''}</p>
            <p><strong>Pageidaujamas kontaktas:</strong> ${claim.contactMethod||''}</p>
            <p><strong>Patogus laikas:</strong> ${claim.preferredTime||''}</p>
        </div>
        <div class="modal-section">
            <h3>Failai</h3>
            ${fileListHtml}
        </div>
        <div class="modal-section">
            <h3>B≈´sena ir priskyrimas</h3>
            <p><strong>B≈´sena:</strong> <span class="status status-${getStatusClass(claim.status)}">${claim.status||''}</span></p>
            <p><strong>Priskirtas meistras:</strong> ${claim.assignedPartner || 'Nƒóra'}</p>
            <p><strong>Remonto kaina:</strong> ${claim.repairCost || 'Nenustatyta'}</p>
        </div>
        <div class="modal-section">
            <h3>Kokybƒós skyriaus komentaras</h3>
            <div class="comment-box">
                <textarea id="quality-comment-${claim.id}" placeholder="ƒÆra≈°ykite komentarƒÖ...">${claim.qualityComment || ''}</textarea>
                <button class="btn-small btn-primary" onclick="saveQualityComment('${claim.id}')">I≈°saugoti komentarƒÖ</button>
            </div>
        </div>
    `;
    document.getElementById('claimModal').style.display = 'flex';
}
function saveQualityComment(id) {
    const comment = document.getElementById(`quality-comment-${id}`).value.trim();
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const i = claims.findIndex(c => c.id === id);
    if (i !== -1) {
        claims[i].qualityComment = comment;
        claims[i].qualityCommentDate = new Date().toISOString();
        localStorage.setItem('claims', JSON.stringify(claims));
        alert('Komentaras i≈°saugotas!');
        currentFilters ? applyInlineFilters() : loadClaims();
    }
}

/* =================== PUSLAPIAVIMAS =================== */
function changePage(direction) {
    const newPage = currentPage + direction;
    const totalPages = Math.ceil(totalClaims / itemsPerPage);
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderClaims();
    }
}

/* =================== DEMO DUOMENYS (jei nƒóra) =================== */
document.addEventListener('DOMContentLoaded', () => {
    // NEW: paprastas rikiavimo aktyvavimas ant 3 stulpeli≈≥
    const ths = document.querySelectorAll('#claims-table thead th');
    // ID (0), Data (1), Remonto kaina (8)
    ths[0].style.cursor = ths[1].style.cursor = ths[8].style.cursor = 'pointer';
    ths[0].title = 'Spauskite rikiuoti pagal ID';
    ths[1].title = 'Spauskite rikiuoti pagal datƒÖ';
    ths[8].title = 'Spauskite rikiuoti pagal remonto kainƒÖ';
    ths[0].addEventListener('click', ()=>toggleSort('id'));
    ths[1].addEventListener('click', ()=>toggleSort('date'));
    ths[8].addEventListener('click', ()=>toggleSort('repairCost'));

    if (!localStorage.getItem('claims')) {
        const testClaims = [{
            id: 'PR-25-001',
            date: '2025-03-15T10:00:00',
            userId: 'USR-001',
            topic: 'Produkto problema',
            role: 'customer',
            product: 'ECOSENS',
            description: 'U≈æsikim≈°ƒôs aeratorius, vanduo teka per lƒótai.',
            request: 'send-part',
            files: ['foto1.jpg', 'video1.mp4'],
            assignedPartner: "Vilniaus servisas ‚Äì Vilnius",
            qualityNote: "Rekomenduojama patikrinti aeratoriaus tarpiklƒØ.",
            qualityAttachments: [
                { type: "file", name: "Schema.pdf", url: "https://..." },
                { type: "video", name: "Video apie gedimƒÖ", url: "https://youtube.com/..." },
                { type: "link", name: "Techninƒó instrukcija", url: "https://rubineta.com/instrukcija" }
            ],
            contact: {
                name: 'Jonas',
                surname: 'Jankauskas',
                email: 'jonas@email.lt',
                phone: '+37061234567',
                street: 'Gatvƒó 12',
                city: 'Vilnius',
                postal: '12345'
            },
            contactMethod: 'email',
            preferredTime: '9‚Äì11 val.',
            qualityComment: 'Neai≈°ku kur la≈°a',
            responsible: 'In≈æinierius Jonas T.',
            repairCost: '85.50',
            issueType: "Nutekƒójimai (Leaking Issues)"
        }];
        localStorage.setItem('claims', JSON.stringify(testClaims));
    }

    if (!localStorage.getItem('feedbacks')) {
        const feedbacks = [{
            id: 'FB-1',
            claimId: 'PR-25-001',
            date: '2025-03-16T10:00:00',
            ratings: { speed: 5, quality: 5, politeness: 5, nps: 10 },
            comments: 'Puikus aptarnavimas!'
        }];
        localStorage.setItem('feedbacks', JSON.stringify(feedbacks));
    }

    if (!localStorage.getItem('users')) {
        const users = [
            { id: 'USR-001', name: 'Jonas', surname: 'J.', role: 'customer', status: 'approved', email: 'jonas@email.lt', phone: '+37061234567', city: 'Vilnius', registrationDate: '2025-03-10' },
            { id: 'USR-002', name: 'Petras', surname: 'P.', role: 'installer', status: 'pending', email: 'petras@servisas.lt', phone: '+37061276543', city: 'Kaunas', registrationDate: '2025-03-14',
              documents: [{ name: 'Sertifikatas.pdf', url: 'https://example.com/sertifikatas.pdf' }, { name: 'Partnerystƒós sutartis.pdf', url: 'https://example.com/sutartis.pdf' }], submissionDate: '2025-03-14' }
        ];
        localStorage.setItem('users', JSON.stringify(users));
    }

    if (!localStorage.getItem('servicePartners')) {
        const partners = [
            { id: 'PART-1', name: 'Vilniaus servisas', contactPerson: 'Petras P.', phone: '+37061234567', email: 'petras@vlservisas.lt', cities: 'Vilnius, Trakai' }
        ];
        localStorage.setItem('servicePartners', JSON.stringify(partners));
    }

    if (!localStorage.getItem('adminUsers')) {
        const adminUsers = [
            { name: 'Jonas', surname: 'T.', role: 'Kokybƒós in≈æinierius', email: 'jonas@rubineta.lt', phone: '+37061234567' },
            { name: 'Eglƒó', surname: 'K.', role: 'Serviso vadovas', email: 'eleg@rubineta.lt', phone: '+37061276543' }
        ];
        localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
    }

    loadClaims();
});
</script>

<script>
(function(){
  if (window.CommBadge) return;
  window.CommBadge = {
    getClaims: ()=>{ try{return JSON.parse(localStorage.getItem('claims')||'[]')}catch(_){return[]} },
    newCount: (claim)=>{
      const seen = parseInt(localStorage.getItem(`chatSeen_admin_${claim.id}`)||'0',10);
      const msgs = (claim.messages||[]).map(m=>{
        if (m && !m.from && m.author){ // legacy
          if (m.author==='quality') return {from:'admin',to:'user',time:m.time};
          if (m.author==='customer') return {from:'user',to:'admin',time:m.time};
          if (m.author==='master') return {from:'master',to:'admin',time:m.time};
        }
        return m;
      }).filter(Boolean);
      let cnt = 0;
      for (const m of msgs){
        const t = Date.parse(m.time||0)||0;
        if (t>seen && ((m.from==='user'&&m.to==='admin')||(m.from==='master'&&m.to==='admin'))) cnt++;
      }
      return cnt;
    },
    paint: ()=>{
      const claims = CommBadge.getClaims();
      document.querySelectorAll('td.comm-cell').forEach(td=>{
        const id = td.getAttribute('data-claim');
        const claim = claims.find(c=>String(c.id)===String(id));
        if (!claim){ td.innerHTML=''; return; }
        const cnt = CommBadge.newCount(claim);
        const has = cnt>0;
        td.innerHTML = `<button class="comm-btn" title="${has? `Naujos ≈æinutƒós: ${cnt}` : 'Nƒóra nauj≈≥'}" onclick="viewClaimDetails('${id}')">
          <span class="comm-icon ${has?'':'comm-muted'}">${has?'üîî':'üì®'}${has?`<span class='comm-badge'>${cnt}</span>`:''}</span>
        </button>`;
      });
    }
  };
  window.updateCommBadges = ()=>CommBadge.paint();
  // periodinis atnaujinimas (kai kiti langai ƒØra≈°o naujas ≈æinutes)
  setInterval(()=>{ try{ CommBadge.paint(); }catch(e){} }, 3000);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(()=>CommBadge.paint(), 200); });
})();


/* === AUTO PATCH v4 === */

// ---- Ensure global bindings so inline onclick works in all browsers ----
(function(){
  // Defensive modal helpers
  const openModalSafe = (html) => {
      if (typeof openModal === 'function') { openModal(html); return; }
      const body = document.getElementById('modal-body');
      const modal = document.getElementById('claimModal');
      if (body && modal) { body.innerHTML = html; modal.style.display = 'flex'; }
  };
  const showClaimModal = () => { const m=document.getElementById('claimModal'); if(m) m.style.display='flex'; };
  const setHeader = (t, withClose=true) => { if (typeof setModalHeader==='function') setModalHeader(t, withClose); else { const h=document.getElementById('modal-title'); if(h) h.textContent=t; } };

  // 1) Installer docs
  window.viewInstallerDocs = function(id){
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.id === id);
      if (!user || !user.documents || user.documents.length === 0) {
          alert('Nƒóra ƒØkelt≈≥ dokument≈≥.');
          return;
      }
      const docs = (user.documents||[]).map(doc => `
        <div class="file-item">
            <a href="${doc.url}" target="_blank" style="text-decoration:none;">üìé ${doc.name||'Failas'}</a>
        </div>`).join('');
      const html = `
        <div class="modal-section">
          <h3>Dokumentai ‚Äì ${(user.name||'')} ${(user.surname||'')}</h3>
          <div class="file-list">${docs}</div>
          <p><strong>Patvirtinimo data:</strong> ${user.submissionDate || 'Nenurodyta'}</p>
        </div>`;
      setHeader('Meistro dokumentai', false);
      openModalSafe(html);
      showClaimModal();
  };

  // 2) Approve / Reject installer
  window.approveInstaller = function(id){
      if (!confirm('Ar tikrai norite patvirtinti ≈°ƒØ meistrƒÖ?')) return;
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.id === id);
      if (user) {
          user.status = 'approved';
          localStorage.setItem('users', JSON.stringify(users));
          if (typeof loadUsers==='function') loadUsers();
          alert(`Meistras ${(user.name||'')} ${(user.surname||'')} patvirtintas!`);
      }
  };

  window.openRejectionModal = function(id){
      const body = `
        <div class="modal-section">
            <h3>Atmesti meistrƒÖ</h3>
            <p>Kodƒól atmetate ≈°ƒØ meistrƒÖ?</p>
            <textarea id="rejection-reason" placeholder="ƒÆra≈°ykite prie≈æastƒØ..." style="width:100%;padding:8px;margin:10px 0;"></textarea>
            <button class="btn btn-danger" onclick="rejectInstaller('${id}')">Atmesti</button>
        </div>`;
      if (typeof openModal==='function') openModal(body); else {
          const mb = document.getElementById('modal-body'); if (mb) mb.innerHTML = body;
          showClaimModal();
      }
  };

  window.rejectInstaller = function(id){
      const reason = (document.getElementById('rejection-reason')?.value || '').trim();
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.id === id);
      if (user) {
          user.status = 'rejected';
          user.rejectionReason = reason;
          localStorage.setItem('users', JSON.stringify(users));
          if (typeof closeModal==='function') closeModal();
          if (typeof loadUsers==='function') loadUsers();
          alert(`Meistras ${(user.name||'')} ${(user.surname||'')} atmestas.`);
      }
  };

  // 3) User history with full details
  window.viewUserHistory = function(id){
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const user = users.find(u => u.id === id);
      if (!user) { alert('Vartotojas nerastas.'); return; }

      const fields = [
          ['Vardas', user.name||''],
          ['Pavardƒó', user.surname||''],
          ['El. pa≈°tas', user.email||''],
          ['Telefonas', user.phone||''],
          ['Rolƒó', user.role||''],
          ['B≈´sena', user.status||''],
          ['Adresas', user.address||''],
          ['Miestas', user.city||''],
          ['Pa≈°to kodas', user.postcode||user.zip||''],
          ['ƒÆmonƒó', user.company||''],
          ['ƒÆmonƒós kodas', user.companyCode||''],
          ['PVM kodas', user.vat||''],
          ['Suk≈´rimo data', user.createdAt ? new Date(user.createdAt).toLocaleString('lt-LT') : (user.dateCreated||'')],
          ['Pateikimo data', user.submissionDate||'']
      ];
      const details = `
        <table style="width:100%;border-collapse:collapse;margin-bottom:16px;">
          <tbody>
            ${fields.map(([k,v]) => `<tr>
              <td style="width:30%;padding:6px 8px;border-bottom:1px solid #eee;"><strong>${k}</strong></td>
              <td style="padding:6px 8px;border-bottom:1px solid #eee;">${v||''}</td>
            </tr>`).join('')}
          </tbody>
        </table>`;

      const claims = JSON.parse(localStorage.getItem('claims') || '[]');
      const fullName = `${(user.name||'').trim()} ${(user.surname||'').trim()}`.trim();
      const userClaims = claims.filter(c => {
          const ce = c && c.contact;
          const matchEmail = ce?.email && user.email && ce.email === user.email;
          const matchName = ce && (`${(ce.name||'').trim()} ${(ce.surname||'').trim()}`.trim() === fullName);
          return matchEmail || matchName;
      });

      const list = userClaims.length ? `
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr>
            <th style="text-align:left;">ID</th>
            <th style="text-align:left;">Data</th>
            <th style="text-align:left;">Produktas</th>
            <th style="text-align:left;">B≈´sena</th>
            <th style="text-align:left;">Veiksmai</th>
          </tr></thead>
          <tbody>
            ${userClaims.map(c => `
              <tr>
                <td><a href="#" onclick="event.preventDefault(); viewClaimDetails('${c.id}')">${c.id}</a></td>
                <td>${c.date ? new Date(c.date).toLocaleDateString('lt-LT') : ''}</td>
                <td>${c.product||''}</td>
                <td>${c.status||''}</td>
                <td><button class="btn btn-primary" onclick="viewClaimDetails('${c.id}')">Per≈æi≈´rƒóti</button></td>
              </tr>`).join('')}
          </tbody>
        </table>` : '<p>≈†is vartotojas neturi pretenzij≈≥.</p>';

      setHeader('Vartotojo istorija', false);
      const html = `<div class="modal-section">
        <h3>${user.name||''} ${user.surname||''} (${user.email||''})</h3>
        ${details}
        <h3>Pretenzij≈≥ istorija</h3>
        ${list}
      </div>`;
      openModalSafe(html);
      showClaimModal();
  };

  // 4) Partner modal helpers
  window.openAddPartnerModal = function(){
      ['edit-partner-id','partner-name','partner-contact','partner-phone','partner-email','partner-cities'].forEach(id => {
          const el = document.getElementById(id); if (el) el.value = '';
      });
      const titleEl = document.getElementById('partnerModalTitle');
      if (titleEl) titleEl.textContent = 'Naujas partneris';
      const modal = document.getElementById('partnerModal');
      if (modal) modal.style.display = 'flex';
  };

  window.openEditPartnerModal = function(id){
      const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
      const partner = partners.find(p => p.id === id);
      if (!partner) { alert('Partneris nerastas.'); return; }
      document.getElementById('partnerModalTitle').textContent = 'Redaguoti partnerƒØ';
      document.getElementById('edit-partner-id').value = partner.id;
      document.getElementById('partner-name').value = partner.name||'';
      document.getElementById('partner-contact').value = partner.contactPerson||'';
      document.getElementById('partner-phone').value = partner.phone||'';
      document.getElementById('partner-email').value = partner.email||'';
      document.getElementById('partner-cities').value = partner.cities||'';
      const modal = document.getElementById('partnerModal');
      if (modal) modal.style.display = 'flex';
  };

  window.savePartner = function(){
      const id = document.getElementById('edit-partner-id').value || ('PART-' + Date.now());
      const name = (document.getElementById('partner-name').value || '').trim();
      const contactPerson = (document.getElementById('partner-contact').value || '').trim();
      const phone = (document.getElementById('partner-phone').value || '').trim();
      const email = (document.getElementById('partner-email').value || '').trim();
      const cities = (document.getElementById('partner-cities').value || '').trim();
      if (!name || !contactPerson || !phone || !email) {
          alert('U≈æpildykite visus privalomus laukus.');
          return;
      }
      const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
      const idx = partners.findIndex(p => p.id === id);
      const partner = { id, name, contactPerson, phone, email, cities };
      if (idx > -1) partners[idx] = partner; else partners.push(partner);
      localStorage.setItem('servicePartners', JSON.stringify(partners));
      if (typeof closePartnerModal==='function') closePartnerModal();
      if (typeof loadPartners==='function') loadPartners();
      alert(`Partneris ${name} i≈°saugotas!`);
  };

  window.deletePartner = function(id){
      if (!confirm('Ar tikrai norite i≈°trinti ≈°ƒØ partnerƒØ?')) return;
      const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
      const updated = partners.filter(p => p.id !== id);
      localStorage.setItem('servicePartners', JSON.stringify(updated));
      if (typeof loadPartners==='function') loadPartners();
      alert('Serviso partneris i≈°trintas.');
  };

  // 5) Header filters (partners + claims)
  window.setupHeaderFilters = function(tableId){
      const table = document.getElementById(tableId);
      if(!table) return;
      const thead = table.querySelector('thead');
      const headerRow = thead?.querySelector('tr');
      if(!headerRow) return;
      if (thead.querySelector('tr.header-filters')) return;
      const filterRow = document.createElement('tr'); filterRow.className = 'header-filters';
      [...headerRow.children].forEach((th, idx) => {
          const cell = document.createElement('th');
          if (idx < headerRow.children.length - 1) {
              const input = document.createElement('input');
              input.type = 'text'; input.placeholder = 'Filtruoti...'; input.style.width = '95%';
              input.addEventListener('input', () => window.applyHeaderFilters(tableId));
              cell.appendChild(input);
          }
          filterRow.appendChild(cell);
      });
      thead.appendChild(filterRow);
  };

  window.applyHeaderFilters = function(tableId){
      const table = document.getElementById(tableId);
      if(!table) return;
      const filterInputs = table.querySelectorAll('thead tr.header-filters input');
      const rows = table.querySelectorAll('tbody tr');
      rows.forEach(row => {
          const cells = row.children;
          let visible = true;
          filterInputs.forEach((inp, i) => {
              if(!visible) return;
              const val = (inp.value||'').toLowerCase();
              if(val){
                  const cellText = (cells[i]?.innerText||'').toLowerCase();
                  if(!cellText.includes(val)) visible = false;
              }
          });
          row.style.display = visible ? '' : 'none';
      });
  };

  document.addEventListener('DOMContentLoaded', function(){
      window.setupHeaderFilters && window.setupHeaderFilters('partners-table');
    //  window.setupHeaderFilters && window.setupHeaderFilters('claims-table');
  });
})();

/* === /AUTO PATCH v4 === */
</script>

</body>
</html>


