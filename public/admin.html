<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Administravimas – Pretenzijos</title>
  <style>
    body{margin:0;font:14px/1.4 Arial, sans-serif;color:#111;background:#fff}
    header,main{max-width:1200px;margin:0 auto;padding:12px}
    h1{margin:6px 0 12px;font-size:20px}
    h2{margin:18px 0 8px;font-size:18px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:end;margin-bottom:10px}
    .controls .field{display:flex;flex-direction:column;min-width:160px}
    .controls label{font-size:12px;color:#555;margin-bottom:2px}
    .controls input,.controls select,.controls button{padding:6px 8px;font-size:13px}
    .btn{cursor:pointer;border:1px solid #ccc;background:#fff}
    .btn-primary{background:#007cba;color:#fff;border-color:#007cba}
    .btn-primary:hover{background:#0a6ea8}
    .btn-danger{background:#c62828;color:#fff;border-color:#c62828}
    .muted{color:#666}

    table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed}
    thead th{background:#f3f3f3;border:1px solid #ddd;padding:6px;text-align:left;white-space:nowrap}
    thead th[data-sort]{cursor:pointer;user-select:none}
    tbody td{border:1px solid #eee;padding:6px;vertical-align:top;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    tbody tr:nth-child(even){background:#fafafa}
    tbody tr:hover{background:#f3f6ff}
    .nowrap{white-space:nowrap}
    .right{text-align:right}
    .status-badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:12px}
    .status-new{background:#eef; color:#224}
    .status-wait{background:#fff3cd;color:#664d03}
    .status-ok{background:#d1e7dd;color:#0f5132}
    .status-sent{background:#e7e3ff;color:#3f2a96}
    .status-reject{background:#f8d7da;color:#842029}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
    #claims-kpi{display:flex;gap:12px;margin:8px 0;flex-wrap:wrap}
    #claims-pager{display:flex;gap:6px;margin:10px 0;flex-wrap:wrap}
    #claims-pager button{padding:6px 10px;border:1px solid #ccc;background:#fff;cursor:pointer}
    #claims-pager button:disabled{opacity:.5;cursor:not-allowed}

    /* status dropdown */
    .dropdown-status-filter{position:relative;display:inline-block}
    #status-dropdown{position:absolute;top:100%;left:0;z-index:10;background:#fff;border:1px solid #ccc;border-radius:6px;padding:8px;display:none;min-width:240px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
    #status-dropdown label{display:flex;align-items:center;gap:6px;padding:4px 2px;font-size:13px}

    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal .box{background:#fff;border-radius:8px;padding:14px;max-width:560px;width:92%}
    .modal .box h3{margin:0 0 8px}
    .modal .box .row{display:flex;gap:8px;margin:6px 0}
    .modal .box .row > *{flex:1}
    .modal .box .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .modal input,.modal select,.modal textarea{width:100%;padding:6px 8px;font-size:13px}

    /* upload progress bubble */
    #upload-progress{position:fixed;right:12px;bottom:12px;background:#000c;color:#fff;padding:8px 10px;border-radius:8px;font:12px Arial;z-index:9999}

    /* partners table */
    .card{border:1px solid #ddd;border-radius:8px;padding:10px;margin:12px 0}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .grid .col-4{grid-column:span 4}
    .grid .col-6{grid-column:span 6}
    .grid .col-12{grid-column:span 12}
    .chip{display:inline-block;padding:2px 6px;border:1px solid #ddd;border-radius:12px;font-size:12px;margin:2px 4px 0 0;background:#fafafa}
  </style>
</head>
<body>
<header>
  <h1>Pretenzijų administravimas</h1>

  <!-- Filtrai -->
  <div class="controls">
    <div class="field" style="min-width:220px">
      <label>Produktas</label>
      <input id="filter-product" type="search" placeholder="pvz., maišytuvas" />
    </div>
    <div class="field" style="min-width:180px">
      <label>Miestas</label>
      <input id="filter-city" type="search" placeholder="pvz., Vilnius" />
    </div>
    <div class="field">
      <label>Nuo (data)</label>
      <input id="filter-date-from" type="date" />
    </div>
    <div class="field">
      <label>Iki (data)</label>
      <input id="filter-date-to" type="date" />
    </div>
    <div class="field">
      <label>Būsena</label>
      <div class="dropdown-status-filter">
        <button class="btn" type="button" onclick="toggleStatusDropdown()">Filtruoti pagal būseną ▼</button>
        <div id="status-dropdown">
          <label><input type="checkbox" value="" checked> Visos</label>
          <label><input type="checkbox" value="Nauja"> Nauja</label>
          <label><input type="checkbox" value="Laukia patvirtinimo"> Laukia patvirtinimo</label>
          <label><input type="checkbox" value="Patvirtinta"> Patvirtinta</label>
          <label><input type="checkbox" value="Perduota servisui"> Perduota servisui</label>
          <label><input type="checkbox" value="Išspręsta"> Išspręsta</label>
          <label><input type="checkbox" value="Atmesta"> Atmesta</label>
          <div class="actions" style="margin-top:6px">
            <button class="btn btn-primary" onclick="applyFilters()">Taikyti</button>
            <button class="btn" onclick="clearFilters()">Išvalyti</button>
          </div>
        </div>
      </div>
    </div>

    <div class="field">
      <label>&nbsp;</label>
      <button class="btn" onclick="exportToCSV()">Eksportuoti CSV</button>
    </div>
  </div>

  <!-- KPI -->
  <div id="claims-kpi"></div>

  <div class="toolbar muted">
    Įrašų iš viso: <span id="total-claims">0</span>
  </div>
</header>

<main>
  <!-- Lentelė -->
  <table id="claims" aria-live="polite">
    <thead>
      <tr>
        <th style="width:7%" data-sort="id">ID</th>
        <th style="width:9%" data-sort="date">Data</th>
        <th style="width:13%">Kontaktas</th>
        <th style="width:10%" data-sort="city">Miestas</th>
        <th style="width:16%">Produktas</th>
        <th style="width:16%">Aprašymas</th>
        <th style="width:12%">Meistras</th>
        <th style="width:12%" data-sort="status">Būsena</th>
        <th style="width:12%">Atsakingas</th>
        <th style="width:14%">Komentaras</th>
        <th style="width:12%">Remonto kaštai (EUR)</th>
        <th style="width:12%">Veiksmai</th>
      </tr>
    </thead>
    <tbody id="claims-body"></tbody>
  </table>

  <div id="claims-pager"></div>

  <!-- ================== PARTNERIAI (CRUD) ================== -->
  <h2>Serviso partneriai</h2>
  <div class="card">
    <div class="grid">
      <div class="col-4">
        <label>Paieška</label>
        <input id="partners-q" type="search" placeholder="pavadinimas, miestas, el. paštas, tel." />
      </div>
      <div class="col-4">
        <label>Miestas</label>
        <input id="partners-city" type="search" placeholder="pvz., Kaunas" />
      </div>
      <div class="col-4" style="display:flex;align-items:flex-end;gap:8px">
        <button class="btn" onclick="filterPartners()">Filtruoti</button>
        <button class="btn" onclick="resetPartnersFilter()">Išvalyti</button>
        <button class="btn btn-primary" onclick="openPartnerModal()">Pridėti partnerį</button>
      </div>
    </div>

    <table style="margin-top:10px">
      <thead>
        <tr>
          <th style="width:24%">Pavadinimas</th>
          <th style="width:14%">Miestas</th>
          <th style="width:22%">El. paštas</th>
          <th style="width:14%">Telefonas</th>
          <th style="width:26%">Žymos</th>
          <th style="width:14%">Veiksmai</th>
        </tr>
      </thead>
      <tbody id="partners-body"></tbody>
    </table>
  </div>
</main>

<!-- Modal: priskirti meistrui -->
<div class="modal" id="assign-modal">
  <div class="box">
    <h3>Priskirti meistrui</h3>
    <div class="row">
      <div>
        <label>Partneris</label>
        <select id="assign-partner-select"></select>
      </div>
    </div>
    <div class="actions">
      <button class="btn" onclick="closeAssignModal()">Atšaukti</button>
      <button class="btn btn-primary" onclick="confirmAssign()">Priskirti</button>
    </div>
  </div>
</div>

<!-- Modal: paskirti atsakingą -->
<div class="modal" id="responsible-modal">
  <div class="box">
    <h3>Paskirti atsakingą</h3>
    <div class="row">
      <div>
        <label>Vardas ir pavardė</label>
        <input id="responsible-name" type="text" placeholder="pvz., Jonas Jonaitis" />
      </div>
    </div>
    <div class="actions">
      <button class="btn" onclick="closeResponsibleModal()">Atšaukti</button>
      <button class="btn btn-primary" onclick="confirmResponsible()">Išsaugoti</button>
    </div>
  </div>
</div>

<!-- Modal: partnerio įvedimas/redagavimas -->
<div class="modal" id="partner-modal">
  <div class="box">
    <h3 id="partner-modal-title">Naujas partneris</h3>
    <div class="row">
      <div><label>Pavadinimas</label><input id="edit-partner-name" type="text" /></div>
      <div><label>Miestas</label><input id="edit-partner-city" type="text" /></div>
    </div>
    <div class="row">
      <div><label>El. paštas</label><input id="edit-partner-email" type="email" /></div>
      <div><label>Telefonas</label><input id="edit-partner-phone" type="tel" /></div>
    </div>
    <div class="row">
      <div class="col-12"><label>Žymos (kableliais)</label><input id="edit-partner-tags" type="text" placeholder="pvz., santechnika, garantija" /></div>
    </div>
    <input id="edit-partner-id" type="hidden" />
    <div class="actions">
      <button class="btn" onclick="closePartnerModal()">Atšaukti</button>
      <button class="btn btn-primary" onclick="savePartner()">Išsaugoti</button>
    </div>
  </div>
</div>

<!-- Modal: įkelti dokumentą (Cloudinary pavyzdys) -->
<div class="modal" id="upload-modal">
  <div class="box">
    <h3>Prisegti dokumentą</h3>
    <div class="row">
      <div>
        <input id="upload-file" type="file" />
        <div class="muted" style="margin-top:6px">Leidžiami: JPG/PNG/WebP, PDF, MP4/WebM. Max 15 MB.</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn" onclick="closeUploadModal()">Atšaukti</button>
      <button class="btn btn-primary" onclick="startUpload()">Įkelti</button>
    </div>
  </div>
</div>

<script>
  /* ========= BŪSENA ========= */
  let currentFilters = null;
  let sortKey = 'date';   // 'id' | 'date' | 'status' | 'city'
  let sortDir = 'desc';   // 'asc' | 'desc'
  let page = 1;
  let perPage = 50;

  let assignTargetId = null;
  let responsibleTargetId = null;
  let uploadTargetId = null;

  /* ========= DEMO SEED ========= */
  (function seedIfEmpty(){
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    if (!claims.length) {
      const demo = [
        { id:'CLM-0001', date:new Date(Date.now()-86400000*5).toISOString(),
          contact:{name:'Petras',surname:'Petrauskas',email:'p.petrauskas@example.com',phone:'+37060000001',city:'Vilnius'},
          product:'Maišytuvas ECO 101', description:'Laša iš snapo, slėgio svyravimai.',
          status:'Nauja', assignedPartner:'', responsible:'', qualityComment:'', repairCost:'', attachments:[] },
        { id:'CLM-0002', date:new Date(Date.now()-86400000*2).toISOString(),
          contact:{name:'Dalia',surname:'Daliūtė',email:'d.daliute@example.com',phone:'+37060000002',city:'Kaunas'},
          product:'Dušo komplektas PRO 220', description:'Skylamas laikiklis, reikia keisti detalę.',
          status:'Perduota servisui', assignedPartner:'UAB Meistrai LT', responsible:'Jonas Jonaitis', qualityComment:'Laukiame detalių.', repairCost:35.50, attachments:[] },
        { id:'CLM-0003', date:new Date().toISOString(),
          contact:{name:'Rūta',surname:'Rūtaitė',email:'r.rutaite@example.com',phone:'+37060000003',city:'Klaipėda'},
          product:'Sifonas CLICK-CLACK', description:'Neužsidaro, mechanizmas stringa.',
          status:'Laukia patvirtinimo', assignedPartner:'', responsible:'', qualityComment:'', repairCost:'', attachments:[] }
      ];
      localStorage.setItem('claims', JSON.stringify(demo));
    }

    const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    if (!partners.length) {
      const seedPartners = [
        { id:'PART-001', name:'UAB Meistrai LT', city:'Vilnius', email:'kontaktas@meistrailt.lt', phone:'+37061234567', tags:['garantija','santechnika'] },
        { id:'PART-002', name:'MB Santechnika PRO', city:'Kaunas', email:'info@santechnika.pro', phone:'+37061234568', tags:['montavimas'] }
      ];
      localStorage.setItem('servicePartners', JSON.stringify(seedPartners));
    }
  })();

  /* Vienkartinė migracija: partneriams garantuoti ID */
  (function ensurePartnerIds(){
    const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    let changed = false;
    partners.forEach(p=>{
      if (!p.id) { p.id = 'PART-' + Date.now() + Math.random().toString(36).slice(2,6); changed=true; }
      if (!Array.isArray(p.tags)) p.tags = [];
    });
    if (changed) localStorage.setItem('servicePartners', JSON.stringify(partners));
  })();

  /* ========= Pagalbinės ========= */
  function getStatusClass(st){
    switch(st){
      case 'Nauja': return 'new';
      case 'Laukia patvirtinimo': return 'wait';
      case 'Patvirtinta': return 'ok';
      case 'Perduota servisui': return 'sent';
      case 'Išspręsta': return 'ok';
      case 'Atmesta': return 'reject';
      default: return 'new';
    }
  }

  function toggleStatusDropdown(){
    const dd = document.getElementById('status-dropdown');
    dd.style.display = (dd.style.display === 'block' ? 'none' : 'block');
  }
  document.addEventListener('click', (e) => {
    const menu = document.getElementById('status-dropdown');
    const btn = document.querySelector('.dropdown-status-filter > button');
    if (!menu || !btn) return;
    const clickInside = menu.contains(e.target) || btn.contains(e.target);
    if (!clickInside) menu.style.display = 'none';
  });

  function clearFilters(){
    document.getElementById('filter-product').value = '';
    document.getElementById('filter-city').value = '';
    document.getElementById('filter-date-from').value = '';
    document.getElementById('filter-date-to').value = '';
    document.querySelectorAll('#status-dropdown input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.querySelector('#status-dropdown input[value=""]').checked = true; // visos
    currentFilters = null;
    page = 1;
    loadClaims();
    const btn = document.querySelector('.dropdown-status-filter > button');
    if (btn) btn.textContent = 'Filtruoti pagal būseną ▼';
  }

  function applyFilters(){
    const statusCheckboxes = document.querySelectorAll('#status-dropdown input[type="checkbox"]:checked');
    const selectedStatuses = Array.from(statusCheckboxes).map(cb => cb.value);
    const showAll = selectedStatuses.includes('');

    const product = (document.getElementById('filter-product').value || '').toLowerCase();
    const city = (document.getElementById('filter-city').value || '').toLowerCase();
    const dateFrom = document.getElementById('filter-date-from').value;
    const dateTo = document.getElementById('filter-date-to').value;

    const fromTs = dateFrom ? new Date(dateFrom + 'T00:00:00').getTime() : null;
    const toTs   = dateTo   ? new Date(dateTo   + 'T23:59:59').getTime() : null;

    const allClaims = JSON.parse(localStorage.getItem('claims') || '[]');
    const filtered = allClaims.filter(c => {
      const matchesStatus = showAll || selectedStatuses.includes(c.status);
      const matchesProduct = !product || (c.product||'').toLowerCase().includes(product);
      const matchesCity = !city || ((c.contact?.city)||'').toLowerCase().includes(city);
      const ts = new Date(c.date).getTime();
      const matchesDate = (!fromTs || ts >= fromTs) && (!toTs || ts <= toTs);
      return matchesStatus && matchesProduct && matchesCity && matchesDate;
    });

    currentFilters = { product, city, dateFrom, dateTo, selectedStatuses };
    page = 1;
    loadClaims(filtered);

    const count = selectedStatuses.filter(v=>v!=='').length;
    const btn = document.querySelector('.dropdown-status-filter > button');
    if (btn) btn.textContent = `Filtruoti pagal būseną ${count ? `(${count})` : ''} ▼`;

    const dropdown = document.getElementById('status-dropdown');
    if (dropdown) dropdown.style.display = 'none';
  }

  /* ========= Lentelė ========= */
  function loadClaims(filteredClaims = null) {
    const claimsAll = filteredClaims || JSON.parse(localStorage.getItem('claims') || '[]');

    const getter = {
      id: c => String(c.id).toLowerCase(),
      date: c => new Date(c.date).getTime(),
      status: c => String(c.status||'').toLowerCase(),
      city: c => String(c.contact?.city || '').toLowerCase()
    }[sortKey] || (c => new Date(c.date).getTime());

    const claims = claimsAll.slice().sort((a,b)=>{
      const A = getter(a), B = getter(b);
      if (A < B) return sortDir==='asc' ? -1 : 1;
      if (A > B) return sortDir==='asc' ? 1 : -1;
      return 0;
    });

    const start = (page - 1) * perPage;
    const end = start + perPage;
    const slice = claims.slice(start, end);

    const tbody = document.getElementById('claims-body');
    tbody.innerHTML = '';

    slice.forEach(claim => {
      const masterCell = claim.assignedPartner 
        ? `<span>${claim.assignedPartner}</span>` 
        : `<button class="btn btn-primary" onclick="showAssignModal('${claim.id}')">Priskirti meistrui</button>`;

      const responsibleCell = claim.responsible 
        ? `<a href="#" onclick="event.preventDefault(); showResponsibleModal('${claim.id}');">${claim.responsible}</a>`
        : `<a href="#" onclick="event.preventDefault(); showResponsibleModal('${claim.id}');">Paskirti atsakingą</a>`;

      const shortDesc = (claim.description || '');
      const cut = shortDesc.length > 60 ? (shortDesc.slice(0, 60) + '…') : shortDesc;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="#" onclick="event.preventDefault(); viewClaimDetails('${claim.id}');">${claim.id}</a></td>
        <td>${new Date(claim.date).toLocaleDateString('lt-LT')}</td>
        <td>${claim.contact.name} ${claim.contact.surname}</td>
        <td>${claim.contact.city}</td>
        <td>${claim.product}</td>
        <td title="${(claim.description||'').replace(/"/g,'&quot;')}">${cut}</td>
        <td>${masterCell}</td>
        <td>
          <select class="status-dropdown status-${getStatusClass(claim.status)}" onchange="updateStatusDirectly('${claim.id}', this.value)">
            <option value="Nauja" ${claim.status === 'Nauja' ? 'selected' : ''}>Nauja</option>
            <option value="Laukia patvirtinimo" ${claim.status === 'Laukia patvirtinimo' ? 'selected' : ''}>Laukia patvirtinimo</option>
            <option value="Patvirtinta" ${claim.status === 'Patvirtinta' ? 'selected' : ''}>Patvirtinta</option>
            <option value="Perduota servisui" ${claim.status === 'Perduota servisui' ? 'selected' : ''}>Perduota servisui</option>
            <option value="Išspręsta" ${claim.status === 'Išspręsta' ? 'selected' : ''}>Išspręsta</option>
            <option value="Atmesta" ${claim.status === 'Atmesta' ? 'selected' : ''}>Atmesta</option>
          </select>
        </td>
        <td>${responsibleCell}</td>
        <td>${claim.qualityComment || '-------'}</td>
        <td>
          <input
            type="number"
            step="0.01"
            min="0"
            value="${typeof claim.repairCost === 'number' ? claim.repairCost.toFixed(2) : (claim.repairCost || '')}"
            placeholder="0.00"
            style="width: 100%; padding: 4px; text-align:right"
            onblur="saveRepairCost('${claim.id}', this.value)"
          />
        </td>
        <td class="nowrap">
          <button class="btn" onclick="openUploadModal('${claim.id}')">Prisegti</button>
          ${claim.assignedPartner ? `<button class="btn" onclick="sendClaimToPartnerViaEmail('${claim.id}')">Siųsti el. paštu</button>` : ''}
        </td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('total-claims').textContent = claimsAll.length;
    renderKPI(claimsAll);
    renderPager(Math.ceil(claimsAll.length / perPage));
  }

  function renderPager(totalPages){
    const host = document.getElementById('claims-pager');
    host.innerHTML = '';
    if (totalPages <= 1) return;

    const mk = (label, p, disabled=false, active=false) => {
      const b = document.createElement('button');
      b.textContent = label;
      b.disabled = disabled;
      if (active) { b.style.background = '#007cba'; b.style.color = '#fff'; }
      b.onclick = () => { page = p; if (currentFilters) applyFilters(); else loadClaims(); };
      host.appendChild(b);
    };

    mk('«', 1, page===1);
    mk('‹', Math.max(1, page-1), page===1);

    const total = totalPages;
    for(let i=1;i<=total;i++){
      if (i===1 || i===total || Math.abs(i-page)<=2) mk(String(i), i, false, i===page);
      else if (i===2 && page>4 || i===total-1 && page<total-3){
        const span=document.createElement('span'); span.textContent=' … '; host.appendChild(span);
      }
    }

    mk('›', Math.min(total, page+1), page===total);
    mk('»', total, page===total);
  }

  document.addEventListener('click', (e)=>{
    const th = e.target.closest('th[data-sort]');
    if (!th) return;
    const key = th.getAttribute('data-sort');
    if (!key) return;
    sortKey = key;
    sortDir = (sortDir==='asc') ? 'desc' : 'asc';
    page = 1;
    if (currentFilters) applyFilters(); else loadClaims();
  });

  function updateStatusDirectly(id, newStatus){
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (!claim) return;
    claim.status = newStatus;
    claim.history = Array.isArray(claim.history) ? claim.history : [];
    claim.history.push({ user: 'Admin', time: new Date().toISOString(), action: `Būsena pakeista į "${newStatus}"` });
    localStorage.setItem('claims', JSON.stringify(claims));
    if (currentFilters) applyFilters(); else loadClaims();
  }

  function saveRepairCost(id, raw) {
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c => c.id === id);
    if (!claim) return;

    const v = String(raw ?? '').replace(',', '.').trim();
    const num = v === '' ? '' : Number(v);

    if (v !== '' && (!isFinite(num) || num < 0)) {
      alert('Įveskite teisingą sumą (teigiamas skaičius, pvz., 25.50).');
      if (currentFilters) applyFilters(); else loadClaims();
      return;
    }
    claim.repairCost = (v === '' ? '' : Number(num.toFixed(2)));
    localStorage.setItem('claims', JSON.stringify(claims));

    const base = (currentFilters ? (function filterWith(cfg, items){
      const { product, city, dateFrom, dateTo, selectedStatuses } = cfg;
      const showAll = selectedStatuses.includes('');
      const fromTs = dateFrom ? new Date(dateFrom + 'T00:00:00').getTime() : null;
      const toTs   = dateTo   ? new Date(dateTo   + 'T23:59:59').getTime() : null;
      return items.filter(c=>{
        const matchesStatus = showAll || selectedStatuses.includes(c.status);
        const matchesProduct = !product || (c.product||'').toLowerCase().includes(product);
        const matchesCity = !city || ((c.contact?.city)||'').toLowerCase().includes(city);
        const ts = new Date(c.date).getTime();
        const matchesDate = (!fromTs || ts >= fromTs) && (!toTs || ts <= toTs);
        return matchesStatus && matchesProduct && matchesCity && matchesDate;
      });
    })(currentFilters, claims) : claims);
    renderKPI(base);
  }

  function viewClaimDetails(id){
    // Nukreipiame į atskirą peržiūrą (jei turi claim-view.html)
    window.open(`claim-view.html?id=${encodeURIComponent(id)}`, '_blank');
  }

  /* ========= CSV eksportas ========= */
  function exportToCSV() {
    const all = JSON.parse(localStorage.getItem('claims') || '[]');

    const source = (currentFilters ? (function filterWith(cfg, items){
      const { product, city, dateFrom, dateTo, selectedStatuses } = cfg;
      const showAll = selectedStatuses.includes('');
      const fromTs = dateFrom ? new Date(dateFrom + 'T00:00:00').getTime() : null;
      const toTs   = dateTo   ? new Date(dateTo   + 'T23:59:59').getTime() : null;
      return items.filter(c=>{
        const matchesStatus = showAll || selectedStatuses.includes(c.status);
        const matchesProduct = !product || (c.product||'').toLowerCase().includes(product);
        const matchesCity = !city || ((c.contact?.city)||'').toLowerCase().includes(city);
        const ts = new Date(c.date).getTime();
        const matchesDate = (!fromTs || ts >= fromTs) && (!toTs || ts <= toTs);
        return matchesStatus && matchesProduct && matchesCity && matchesDate;
      });
    })(currentFilters, all) : all);

    const headers = [
      'ID','Data','Vardas','Pavardė','El. paštas','Telefonas',
      'Produktas','Aprašymas','Būsena','Miestas',
      'Priskirtas meistras','Komentaras','Remonto kaštai (EUR)'
    ];

    const rows = source.map(c => [
      c.id,
      new Date(c.date).toLocaleDateString('lt-LT'),
      c.contact?.name || '',
      c.contact?.surname || '',
      c.contact?.email || '',
      c.contact?.phone || '',
      c.product || '',
      (c.description || '').replace(/"/g,'""'),
      c.status || '',
      c.contact?.city || '',
      c.assignedPartner || '',
      (c.qualityComment || '').replace(/"/g,'""'),
      (typeof c.repairCost === 'number' ? c.repairCost.toFixed(2) : (c.repairCost || ''))
    ].join(';'));

    const csv = [headers.join(';'), ...rows].join('\n');
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `pretenzijos_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
  }

  /* ========= KPI ========= */
  function renderKPI(list){
    const el = document.getElementById('claims-kpi'); if(!el) return;
    const total = list.length;
    const by = s => list.filter(c=>c.status===s).length;

    const sum = list.reduce((acc,c)=>{
      const v = (typeof c.repairCost === 'number') ? c.repairCost : (c.repairCost ? Number(String(c.repairCost).replace(',','.')) : 0);
      return acc + (isFinite(v) ? v : 0);
    }, 0);

    el.innerHTML = `
      <span><strong>Viso:</strong> ${total}</span>
      <span><strong>Naujų:</strong> ${by('Nauja')}</span>
      <span><strong>Laukia:</strong> ${by('Laukia patvirtinimo')}</span>
      <span><strong>Perduota servisui:</strong> ${by('Perduota servisui')}</span>
      <span><strong>Išspręsta:</strong> ${by('Išspręsta')}</span>
      <span><strong>Atmesta:</strong> ${by('Atmesta')}</span>
      <span><strong>Bendra remonto suma:</strong> ${sum.toFixed(2)} €</span>
    `;
  }

  /* ========= Partnerių valdymas ========= */
  function renderPartners(list=null){
    const partners = list || JSON.parse(localStorage.getItem('servicePartners') || '[]');
    const tb = document.getElementById('partners-body');
    tb.innerHTML = '';
    partners.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${p.city || ''}</td>
        <td>${p.email || ''}</td>
        <td>${p.phone || ''}</td>
        <td>${(p.tags||[]).map(t=>`<span class="chip">${t}</span>`).join('')}</td>
        <td class="nowrap">
          <button class="btn" onclick="editPartner('${p.id}')">Redaguoti</button>
          <button class="btn btn-danger" onclick="deletePartner('${p.id}')">Šalinti</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }
  function filterPartners(){
    const q=(document.getElementById('partners-q').value||'').toLowerCase();
    const city=(document.getElementById('partners-city').value||'').toLowerCase();
    const list = JSON.parse(localStorage.getItem('servicePartners') || '[]').filter(p=>{
      const hay=[p.name,p.email,p.phone,(p.tags||[]).join(','),(p.city||'')].join(' ').toLowerCase();
      if (q && !hay.includes(q)) return false;
      if (city && !(p.city||'').toLowerCase().includes(city)) return false;
      return true;
    });
    renderPartners(list);
  }
  function resetPartnersFilter(){
    document.getElementById('partners-q').value='';
    document.getElementById('partners-city').value='';
    renderPartners();
  }
  function openPartnerModal(){
    document.getElementById('partner-modal-title').textContent='Naujas partneris';
    document.getElementById('edit-partner-id').value='';
    document.getElementById('edit-partner-name').value='';
    document.getElementById('edit-partner-city').value='';
    document.getElementById('edit-partner-email').value='';
    document.getElementById('edit-partner-phone').value='';
    document.getElementById('edit-partner-tags').value='';
    document.getElementById('partner-modal').style.display='flex';
  }
  function closePartnerModal(){ document.getElementById('partner-modal').style.display='none'; }
  function savePartner(){
    const id = document.getElementById('edit-partner-id').value || ('PART-' + Date.now() + Math.random().toString(36).slice(2,6));
    const p = {
      id,
      name: (document.getElementById('edit-partner-name').value||'').trim(),
      city: (document.getElementById('edit-partner-city').value||'').trim(),
      email:(document.getElementById('edit-partner-email').value||'').trim(),
      phone:(document.getElementById('edit-partner-phone').value||'').trim(),
      tags: (document.getElementById('edit-partner-tags').value||'').split(',').map(s=>s.trim()).filter(Boolean)
    };
    const arr = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    const idx = arr.findIndex(x=>x.id===id);
    if (idx>=0) arr[idx]=p; else arr.push(p);
    localStorage.setItem('servicePartners', JSON.stringify(arr));
    closePartnerModal();
    renderPartners();
  }
  function editPartner(id){
    const arr = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    const p = arr.find(x=>x.id===id); if(!p) return;
    document.getElementById('partner-modal-title').textContent='Redaguoti partnerį';
    document.getElementById('edit-partner-id').value=p.id;
    document.getElementById('edit-partner-name').value=p.name||'';
    document.getElementById('edit-partner-city').value=p.city||'';
    document.getElementById('edit-partner-email').value=p.email||'';
    document.getElementById('edit-partner-phone').value=p.phone||'';
    document.getElementById('edit-partner-tags').value=(p.tags||[]).join(', ');
    document.getElementById('partner-modal').style.display='flex';
  }
  function deletePartner(id){
    if(!confirm('Tikrai šalinti partnerį?')) return;
    const arr = JSON.parse(localStorage.getItem('servicePartners') || '[]').filter(p=>p.id!==id);
    localStorage.setItem('servicePartners', JSON.stringify(arr));
    renderPartners();
  }

  /* ========= Priskyrimo modalis ========= */
  function showAssignModal(id){
    assignTargetId = id;
    const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    const sel = document.getElementById('assign-partner-select');
    sel.innerHTML = '<option value="">— Pasirinkite —</option>' + partners.map(p => `<option value="${p.name}">${p.name} (${p.city})</option>`).join('');
    document.getElementById('assign-modal').style.display = 'flex';
  }
  function closeAssignModal(){ document.getElementById('assign-modal').style.display = 'none'; assignTargetId = null; }
  function confirmAssign(){
    const val = document.getElementById('assign-partner-select').value;
    if (!assignTargetId) return closeAssignModal();
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const c = claims.find(x=>x.id===assignTargetId);
    if (c){
      c.assignedPartner = val || '';
      c.history = Array.isArray(c.history)? c.history : [];
      c.history.push({ user:'Admin', time:new Date().toISOString(), action: (val?`Priskirtas partneris: ${val}`:'Partneris nuimtas') });
      localStorage.setItem('claims', JSON.stringify(claims));
    }
    closeAssignModal();
    if (currentFilters) applyFilters(); else loadClaims();
  }

  /* ========= Atsakingo paskyrimas ========= */
  function showResponsibleModal(id){
    responsibleTargetId = id;
    document.getElementById('responsible-name').value = '';
    document.getElementById('responsible-modal').style.display = 'flex';
  }
  function closeResponsibleModal(){ document.getElementById('responsible-modal').style.display = 'none'; responsibleTargetId = null; }
  function confirmResponsible(){
    const val = document.getElementById('responsible-name').value.trim();
    if (!responsibleTargetId) return closeResponsibleModal();
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const c = claims.find(x=>x.id===responsibleTargetId);
    if (c){
      c.responsible = val;
      c.history = Array.isArray(c.history)? c.history : [];
      c.history.push({ user:'Admin', time:new Date().toISOString(), action: `Paskirtas atsakingas: ${val||'—'}` });
      localStorage.setItem('claims', JSON.stringify(claims));
    }
    closeResponsibleModal();
    if (currentFilters) applyFilters(); else loadClaims();
  }

  /* ========= Failų įkėlimas (Cloudinary pavyzdys) ========= */
  function showUploadIndicator(){
    let el = document.getElementById('upload-progress');
    if (!el){ el = document.createElement('div'); el.id='upload-progress'; document.body.appendChild(el); }
    el.textContent='Įkeliama…';
  }
  function hideUploadIndicator(){ const el = document.getElementById('upload-progress'); if (el) el.remove(); }

  function uploadToCloudinary(file, onSuccess, onError) {
    if (!file) { onError(new Error('Nepasirinktas failas')); return; }
    const okTypes = ['image/jpeg','image/png','image/webp','application/pdf','video/mp4','video/webm'];
    const maxSize = 15 * 1024 * 1024;
    if (!okTypes.includes(file.type)) { onError(new Error('Failo tipas neleidžiamas')); return; }
    if (file.size > maxSize) { onError(new Error('Failas per didelis (>15 MB)')); return; }

    showUploadIndicator();

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'r6wao0fr'); // DEMO
    formData.append('cloud_name', 'dtiiwo2bp');   // DEMO

    const xhr = new XMLHttpRequest();
    xhr.open('POST', 'https://api.cloudinary.com/v1_1/dtiiwo2bp/upload', true);

    xhr.upload.onprogress = (e)=>{
      if (!e.lengthComputable) return;
      const pct = Math.round((e.loaded/e.total)*100);
      let node = document.getElementById('upload-progress');
      if (!node) { node = document.createElement('div'); node.id='upload-progress'; document.body.appendChild(node); }
      node.textContent = `Įkeliama… ${pct}%`;
      if (pct>=100) setTimeout(()=>{ node.remove(); }, 1500);
    };

    xhr.onload = ()=>{
      hideUploadIndicator();
      try{
        const data = JSON.parse(xhr.responseText);
        if (data.secure_url) onSuccess(data.secure_url);
        else onError(new Error('Nepavyko gauti URL'));
      }catch(err){ onError(err); }
    };
    xhr.onerror = ()=>{ hideUploadIndicator(); onError(new Error('Tinklo klaida')); };
    xhr.send(formData);
  }

  function openUploadModal(claimId){
    uploadTargetId = claimId;
    document.getElementById('upload-file').value = '';
    document.getElementById('upload-modal').style.display='flex';
  }
  function closeUploadModal(){ document.getElementById('upload-modal').style.display='none'; uploadTargetId = null; }
  function startUpload(){
    const file = document.getElementById('upload-file').files[0];
    if (!uploadTargetId) return closeUploadModal();
    uploadToCloudinary(file, (url)=>{
      const claims = JSON.parse(localStorage.getItem('claims') || '[]');
      const c = claims.find(x=>x.id===uploadTargetId);
      if (c){
        c.attachments = Array.isArray(c.attachments) ? c.attachments : [];
        c.attachments.push({ url, name: file.name, time: new Date().toISOString() });
        c.history = Array.isArray(c.history) ? c.history : [];
        c.history.push({ user:'Admin', time:new Date().toISOString(), action:`Prisegtas dokumentas: ${file.name}` });
        localStorage.setItem('claims', JSON.stringify(claims));
      }
      closeUploadModal();
      if (currentFilters) applyFilters(); else loadClaims();
    }, (err)=>{
      alert(err.message || 'Klaida įkeliant failą');
    });
  }

  /* ========= Laiško ruošinys partneriui ========= */
  function sendClaimToPartnerViaEmail(id){
    const claims = JSON.parse(localStorage.getItem('claims') || '[]');
    const claim = claims.find(c=>c.id===id); if(!claim) return;

    const partners = JSON.parse(localStorage.getItem('servicePartners') || '[]');
    const p = partners.find(x=>x.name === claim.assignedPartner);
    const to = p?.email || '';

    const subject = encodeURIComponent(`Pretenzija ${claim.id} – ${claim.product}`);
    const link = location.origin + `/claim-view.html?id=${encodeURIComponent(claim.id)}`;
    const att = (claim.attachments||[]).map(a=>a.url).join('\n');
    const body = encodeURIComponent(
`Sveiki,
Praśome perimti pretenziją ${claim.id} (${claim.product}).

Klientas: ${claim.contact.name} ${claim.contact.surname}, ${claim.contact.phone}, ${claim.contact.email}
Miestas: ${claim.contact.city}
Aprašymas: ${claim.description}

Peržiūra: ${link}
Prisegti dokumentai:
${att || '—'}

Pagarbiai,
Kokybės skyrius`
    );

    // mailto – paprasčiausias kelias; serverinį siuntimą pridėsite vėliau
    window.location.href = `mailto:${encodeURIComponent(to)}?subject=${subject}&body=${body}`;
  }

  /* ========= INIT ========= */
  function renderKPIAndClaims(){ if (currentFilters) applyFilters(); else loadClaims(); }
  function setupPartnersUI(){ renderPartners(); }

  window.onload = function(){
    renderKPIAndClaims();
    setupPartnersUI();
  };
</script>
</body>
</html>
































































