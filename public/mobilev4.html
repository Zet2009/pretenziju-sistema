<!DOCTYPE html>
<html lang="lt">
<head>
<link rel="manifest" href="./manifest.webmanifest">  
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Rubineta â€“ Master Mobile (PWA)</title>
<meta name="theme-color" content="#111111"/>
<style>
  :root{
    --bg:#f6f7f9; --card:#ffffff; --ink:#111; --muted:#6b7280; --brand:#111; --accent:#0ea5e9; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --ring:#e5e7eb;
    --radius:16px; --shadow:0 6px 20px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial}
  header{position:sticky;top:0;z-index:30;background:#fff;border-bottom:1px solid var(--ring)}
  .container{max-width:740px;margin:0 auto;padding:12px}
  .hstack{display:flex;gap:8px;align-items:center}
  .stack{display:flex;flex-direction:column;gap:8px}
  .btn{appearance:none;border:1px solid var(--ring);background:#fff;border-radius:12px;padding:10px 14px;font-weight:600}
  .btn.solid{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn.bad{background:var(--bad);border-color:var(--bad);color:#fff}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
  input,select,textarea{width:100%;border:1px solid var(--ring);border-radius:12px;padding:10px 12px;font:inherit;background:#fff}
  textarea{min-height:100px;resize:vertical}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);background:#fff;border-radius:999px;padding:4px 10px;font-size:12px;color:#374151}
  .status{font-size:12px;font-weight:700}
  .status.New{color:var(--bad)} .status.Approved{color:var(--accent)}
  .status.Sent{color:#2563eb} .status.Resolved{color:var(--ok)}
  .grid{display:grid;gap:8px}
  .jobs{display:grid;gap:10px}
  .job{display:flex;justify-content:space-between;gap:10px}
  .muted{color:var(--muted)}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#111;color:#fff;border-radius:999px;padding:4px 10px;font-size:12px}
  .dot{width:8px;height:8px;border-radius:999px;background:var(--warn);display:inline-block}
  .sticky-footer{position:sticky;bottom:0;background:linear-gradient(0deg,#fff 70%,rgba(255,255,255,.8));border-top:1px solid var(--ring)}
  .toolbar{display:flex;gap:8px}
  .thumb{width:100%;height:90px;object-fit:cover;border-radius:10px;border:1px solid var(--ring)}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kpi .card{padding:12px}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <div class="container hstack" style="justify-content:space-between;">
    <div class="hstack" style="gap:10px">
      <strong>ğŸ”§ Master Mobile</strong>
      <span id="master-pill" class="pill">Meistras</span>
    </div>
    <div class="hstack">
      <button id="btn-change-master" class="btn">Keisti</button>
      <button id="btn-install" class="btn solid hidden">Ä®sidiegti</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- KPI + valdikliai -->
  <div class="kpi">
    <div class="card stack">
      <div class="muted">RyÅ¡ys / sinchronizacija</div>
      <div class="chips" id="sync-flags">
        <span class="pill" id="flag-online">ğŸŒ PrisijungÄ™s</span>
        <span class="pill" id="flag-offline" style="display:none">ğŸ“´ Offline</span>
        <span class="pill" id="flag-queued" style="display:none">â³ EilÄ—je: <b id="q-count">0</b></span>
        <span class="pill" id="flag-pending" style="display:none">ğŸ“Œ â€tik-prisegÄ—â€œ</span>
      </div>
      <div class="hstack">
        <button class="btn" id="btn-sync-now">Sinchronizuoti</button>
        <button class="btn" id="btn-notify-test">ğŸ”” Test praneÅ¡imas</button>
      </div>
    </div>
    <div class="card stack">
      <div class="muted">Quick actions</div>
      <div class="hstack">
        <button class="btn" id="btn-seed">Seed demo</button>
        <button class="btn bad" id="btn-clear">IÅ¡valyti</button>
      </div>
      <div class="muted" style="font-size:12px">Priminimas: Å¡iame demo duomenys saugomi local/IDB.</div>
    </div>
  </div>

  <!-- PaieÅ¡ka ir filtrai -->
  <div class="card hstack" style="justify-content:space-between;flex-wrap:wrap;">
    <input id="search" placeholder="PaieÅ¡ka (ID, produktas, miestas)" style="flex:1;min-width:220px">
    <select id="filter" style="width:180px">
      <option value="assigned">Man priskirtos</option>
      <option value="all">Visos</option>
    </select>
  </div>

  <!-- UÅ¾duoÄiÅ³ sÄ…raÅ¡as -->
  <section class="jobs" id="jobs"></section>

  <!-- DetalÄ— -->
  <section id="detail" class="card stack hidden">
    <div class="hstack" style="justify-content:space-between">
      <div class="hstack" style="gap:6px">
        <button class="btn" id="btn-back">â—€ Atgal</button>
        <span class="muted">ID:</span>
        <strong id="d-id"></strong>
        <span id="d-status" class="status"></span>
      </div>
      <div class="chips">
        <a class="pill" id="d-call" href="#">ğŸ“</a>
        <a class="pill" id="d-sms" href="#">ğŸ’¬</a>
        <a class="pill" id="d-map" href="#" target="_blank" rel="noreferrer">ğŸ—ºï¸</a>
      </div>
    </div>

    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div class="stack">
        <div><span class="muted">Produktas:</span> <b id="d-product"></b></div>
        <div><span class="muted">Produkto ID:</span> <b id="d-productid"></b></div>
        <div class="muted">Gedimo rÅ«Å¡is:</div>
        <div id="d-issue" class="card" style="padding:10px"></div>
        <div class="muted">ApraÅ¡ymas:</div>
        <div id="d-desc" class="card" style="padding:10px"></div>
      </div>
      <div class="stack">
        <div class="muted">Klientas</div>
        <div class="card" style="padding:10px" id="d-contact"></div>
        <div class="hstack">
          <button class="btn" id="btn-start">PradÄ—ti laikÄ…</button>
          <button class="btn" id="btn-stop">Stabdyti</button>
          <span class="pill" id="pill-time">Sukaupta: 0.00 h</span>
        </div>
      </div>
    </div>

    <div class="stack">
      <div class="muted">KokybÄ—s skyriaus rekomendacijos</div>
      <div id="d-qa" class="card" style="padding:10px">â€”</div>
    </div>

    <div class="stack">
      <div class="hstack" style="justify-content:space-between">
        <div class="muted">Meistro failai</div>
        <div class="hstack">
          <input id="file-input" type="file" accept="image/*,video/*,application/pdf" capture="environment" multiple class="hidden">
          <button class="btn" id="btn-add-files">ğŸ“ PridÄ—ti</button>
        </div>
      </div>
      <div id="d-files" class="grid" style="grid-template-columns:repeat(3,1fr)"></div>
      <small class="muted">ğŸ“Œ â€tik-prisegÄ—â€œ â€“ failai paÅ¾ymimi kaip <b>pending</b> iki sÄ—kmingos sinchronizacijos.</small>
    </div>

    <div class="stack">
      <div class="muted">Chat su administratoriumi</div>
      <div id="d-chat" class="card stack" style="max-height:240px;overflow:auto"></div>
      <div class="hstack">
        <input id="chat-input" placeholder="Å½inutÄ— administratoriuiâ€¦">
        <button class="btn solid" id="chat-send">SiÅ³sti</button>
      </div>
    </div>

    <div class="stack">
      <div class="muted">AtliktÅ³ darbÅ³ ataskaita</div>
      <textarea id="rep-work" placeholder="Atlikti darbaiâ€¦"></textarea>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <label>Darbo valandos <input id="rep-labor" type="number" step="0.25" value="0"></label>
        <label>Atstumas (km) <input id="rep-km" type="number" step="0.1" value="0"></label>
      </div>
      <label>Papildomos iÅ¡laidos (â‚¬) <input id="rep-extra" type="number" step="0.01" value="0"></label>
      <div class="hstack" style="justify-content:space-between">
        <div class="pill" id="rep-total">Bendra suma: â‚¬ 0.00</div>
        <div class="toolbar">
          <button class="btn" onclick="window.print()">PDF</button>
          <button class="btn ok" id="rep-save">UÅ¾baigti ir iÅ¡saugoti</button>
        </div>
      </div>
    </div>
  </section>
</main>

<div class="sticky-footer">
  <div class="container hstack" style="gap:8px">
    <button class="btn solid" id="btn-tab-list" style="flex:1">ğŸ—‚ï¸ Mano uÅ¾duotys</button>
    <button class="btn" id="btn-tab-all" style="flex:1">ğŸ“‹ Visos</button>
  </div>
</div>

<script>
/* =========================================================
   MINIMAL OFFLINE STACK (IDB + Sync Queue + SW hooks)
========================================================= */
// --- tiny idb helpers ---
const idbOpen = (name, version=1, upgradeCb) => new Promise((res, rej)=>{
  const req = indexedDB.open(name, version);
  req.onupgradeneeded = (e)=> upgradeCb && upgradeCb(e.target.result);
  req.onsuccess = ()=> res(req.result);
  req.onerror = ()=> rej(req.error);
});
const idbTx = (db, store, mode='readonly') => db.transaction(store, mode).objectStore(store);
const idbAll = (store) => new Promise((res,rej)=>{ const out=[]; const c=store.openCursor(); c.onsuccess=e=>{const cur=e.target.result; if(cur){ out.push(cur.value); cur.continue(); } else res(out) }; c.onerror=()=>rej(c.error) });
const idbPut = (store, val)=> new Promise((res,rej)=>{ const r=store.put(val); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error) });
const idbDel = (store, key)=> new Promise((res,rej)=>{ const r=store.delete(key); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error) });

let syncDB;
(async()=>{
  syncDB = await idbOpen('rubineta-sync', 1, (db)=>{
    if(!db.objectStoreNames.contains('ops')) db.createObjectStore('ops', { keyPath:'id' });
  });
})();

async function queueOp(op){
  const store = idbTx(syncDB, 'ops', 'readwrite');
  await idbPut(store, op);
  updateQueueIndicator();
  try{
    if('serviceWorker' in navigator && 'SyncManager' in window){
      const reg = await navigator.serviceWorker.ready;
      await reg.sync.register('sync-queue');
    } else {
      // fallback â€“ try immediately
      processQueue();
    }
  }catch(e){}
}

async function getQueue(){ return idbAll(idbTx(syncDB,'ops')); }
async function removeOp(id){ return idbDel(idbTx(syncDB,'ops','readwrite'), id); }
async function processQueue(){
  const ops = await getQueue();
  for(const op of ops){
    try{
      // DEMO: imitate network call
      await new Promise(r=>setTimeout(r,400));
      // If navigator.onLine false -> throw to retry
      if(!navigator.onLine) throw new Error('offline');
      // pretend OK -> remove
      await removeOp(op.id);
    }catch(e){
      // keep for next round
    }
  }
  updateQueueIndicator();
}

window.addEventListener('online', processQueue);
function legacyToNew(m){
  if (m && m.from && m.to) return m;
  if (!m) return m;
  if (m.author==='quality') return {from:'admin', to:'user', text:m.text, files:m.attachments||[], time:m.time, id:m.id};
  if (m.author==='customer') return {from:'user', to:'admin', text:m.text, files:m.attachments||[], time:m.time, id:m.id};
  if (m.author==='master')   return {from:'master', to:'admin', text:m.text, files:m.attachments||[], time:m.time, id:m.id};
  return m;
}
function migrateClaims(){
  const claims = Zen.getClaims();
  let changed = false;
  claims.forEach(c=>{
    if (Array.isArray(c.messages)) {
      const mapped = c.messages.map(legacyToNew);
      if (JSON.stringify(mapped)!==JSON.stringify(c.messages)) {
        c.messages = mapped; changed = true;
      }
    }
  });
  if (changed) Zen.setClaims(claims);
}
/* =========================================================
   DATA (uses same localStorage 'claims' shape as admin side)
========================================================= */
const Zen = {
  getClaims(){ try{ return JSON.parse(localStorage.getItem('claims')||'[]'); }catch(_){ return []; } },
  setClaims(v){ localStorage.setItem('claims', JSON.stringify(v)); },
  fmt(ts){ try { return new Date(ts).toLocaleString('lt-LT'); } catch { return ts; } },
  icon(n=''){ n=n.toLowerCase(); if(/\.(jpg|jpeg|png|webp|gif)$/.test(n)) return 'ğŸ–¼ï¸'; if(/\.(mp4|webm|mov)$/.test(n)) return 'ğŸ¥'; if(/\.pdf$/.test(n)) return 'ğŸ“„'; return 'ğŸ“'; },
  async uploadFiles(fileList){
    const out=[];
    for(const file of fileList){
      const ab = await file.arrayBuffer();
      const b64 = btoa(String.fromCharCode(...new Uint8Array(ab)));
      const url = `data:${file.type||'application/octet-stream'};base64,${b64}`;
      out.push({name:file.name, dataUrl:url, type:/\.(jpg|jpeg|png|webp|gif)$/i.test(file.name)?'image':/\.(mp4|webm|mov)$/i.test(file.name)?'video':/\.pdf$/i.test(file.name)?'pdf':'file', pending:true});
    }
    return out;
  }
};

/* =========================================================
   UI STATE
========================================================= */
let CURRENT = JSON.parse(localStorage.getItem('currentMaster')||'null') || {name:'UAB Servisas'};
let pageFilter = 'assigned';
let openId = null;
let timerStart = null;

const $ = (q)=>document.querySelector(q);
const elJobs = $('#jobs');
const elDetail = $('#detail');

// master name editing
$('#master-pill').textContent = CURRENT.name || 'Meistras';
$('#btn-change-master').onclick = ()=>{
  const name = prompt('Serviso / meistro vardas:', CURRENT.name||'');
  if(!name) return;
  CURRENT = {...CURRENT, name};
  localStorage.setItem('currentMaster', JSON.stringify(CURRENT));
  $('#master-pill').textContent = CURRENT.name;
  renderList();
};

// tabs
$('#btn-tab-list').onclick = ()=>{ pageFilter='assigned'; $('#filter').value='assigned'; renderList(); };
$('#btn-tab-all').onclick = ()=>{ pageFilter='all'; $('#filter').value='all'; renderList(); };
$('#filter').onchange = (e)=>{ pageFilter=e.target.value; renderList(); };
$('#search').oninput = ()=> renderList();

// seed / clear
$('#btn-seed').onclick = ()=>{
  const have = Zen.getClaims();
  if(have.length) { alert('Jau yra duomenÅ³.'); return; }
  const now = Date.now();
  const demo = [{
    id:'CLM-'+(now%100000), date:new Date(now-7200000).toISOString(), topic:'NutekÄ—jimas',
    role:'Vartotojas', product:'Rubineta ECO 123', productId:'SKU-12345',
    description:'Po sumontavimo laÅ¡a iÅ¡ snapo ir perjungÄ—jo.', request:'Garantinis remontas',
    contact:{name:'Jonas',surname:'Kazlauskas', phone:'+37060000000', email:'jonas@example.com', city:'Vilnius', street:'Gedimino pr. 1', postal:'01103'},
    issueType:'NutekÄ—jimai (Leaking Issues)', status:'Perduota servisui', assignedPartner:CURRENT.name,
    messages:[{id:'m1', from:'admin', to:'master', text:'PraÅ¡au priimti ir pateikti ataskaitÄ….', time:new Date(now-7000000).toISOString(), read:false}]
  },{
    id:'CLM-'+(now%100000+1), date:new Date(now-3600000).toISOString(), topic:'Dangos defektas',
    role:'Vartotojas', product:'Rubineta ROYAL 456', productId:'SKU-67890',
    description:'Chromas nusilupa ties rankenÄ—le.', request:'Keitimas',
    contact:{name:'Asta',surname:'PetrauskienÄ—', phone:'+37061111111', email:'asta@example.com', city:'Kaunas', street:'LaisvÄ—s al. 10', postal:'44295'},
    issueType:'PavirÅ¡iaus ir dangos problemos (Surface and Coating Problems)', status:'Patvirtinta', assignedPartner:CURRENT.name,
    messages:[]
  }];
  Zen.setClaims(demo);
  renderList();
};
$('#btn-clear').onclick = ()=>{ if(confirm('IÅ¡valyti visus demo duomenis?')){ localStorage.removeItem('claims'); renderList(); } };

// list render
function renderList(){
  elDetail.classList.add('hidden');
  const q = ($('#search').value||'').toLowerCase();
  const items = Zen.getClaims()
    .filter(c => pageFilter==='all' || (c.assignedPartner||'').toLowerCase()=== (CURRENT.name||'').toLowerCase())
    .filter(c => !q || (c.product||'').toLowerCase().includes(q) || (c.id||'').toLowerCase().includes(q) || (c.contact?.city||'').toLowerCase().includes(q))
    .sort((a,b)=> new Date(b.date||0)-new Date(a.date||0));

  elJobs.innerHTML = items.map(c=>{
    const unread = (c.messages||[]).filter(m=>m.from==='admin' && m.to==='master' && !m.read).length;
    return `
      <div class="card job" onclick="openDetail('${c.id}')">
        <div>
          <div><b>${c.product||''}</b></div>
          <div class="muted">${c.contact?.city||''} â€¢ ${new Date(c.date).toLocaleDateString('lt-LT')}</div>
          <div class="muted">${(c.description||'').slice(0,80)}${(c.description||'').length>80?'â€¦':''}</div>
        </div>
        <div style="text-align:right">
          <div class="badge">${c.status||'Nauja'}</div>
          <div class="muted">#${c.id}</div>
          ${unread>0?`<div class="pill" style="margin-top:6px;background:#fee2e2;border-color:#fecaca;color:#b91c1c">âœ‰ï¸ ${unread}</div>`:''}
        </div>
      </div>
    `;
  }).join('') || `<div class="muted">NÄ—ra uÅ¾duoÄiÅ³.</div>`;
}
window.openDetail = (id)=> showDetail(id);

function showDetail(id){
  const all = Zen.getClaims();
  const c = all.find(x=>x.id===id);
  if(!c){ alert('Pretenzija nerasta'); return; }
  openId = id;

  $('#d-id').textContent = c.id;
  $('#d-status').textContent = c.status; $('#d-status').className='status '+(c.status||'');
  $('#d-product').textContent = c.product||'';
  $('#d-productid').textContent = c.productId||'';
  $('#d-issue').textContent = c.issueType||'â€”';
  $('#d-desc').textContent = c.description||'â€”';
  $('#d-qa').textContent = c.qualityExternalComment || 'â€”';

  const contactHtml = `
    <div><b>${c.contact?.name||''} ${c.contact?.surname||''}</b></div>
    <div>${c.contact?.phone||''}</div>
    <div>${c.contact?.email||''}</div>
    <div>${c.contact?.street||''}, ${c.contact?.city||''}</div>
  `;
  $('#d-contact').innerHTML = contactHtml;

  const addr = `${c.contact?.street||''}, ${c.contact?.city||''}`.trim();
  $('#d-call').href = c.contact?.phone ? `tel:${c.contact.phone}` : '#';
  $('#d-sms').href  = c.contact?.phone ? `sms:${c.contact.phone}` : '#';
  $('#d-map').href  = addr ? `https://maps.google.com/?q=${encodeURIComponent(addr)}` : '#';

  // files
  renderFiles(c);
  // chat
  renderChat(c);
  // timer
  $('#pill-time').textContent = `Sukaupta: ${((c.timeSpentSec||0)/3600).toFixed(2)} h`;
  timerStart = null;

  // report fields
  $('#rep-work').value = c.masterReport?.work || '';
  $('#rep-labor').value = c.masterReport?.laborHours || 0;
  $('#rep-km').value = c.masterReport?.travelKm || 0;
  $('#rep-extra').value = c.masterReport?.extraCosts || 0;
  updateTotal();

  elDetail.classList.remove('hidden');
  // mark adminâ†’master messages read (locally)
  c.messages?.forEach(m=>{ if(m.from==='admin' && m.to==='master') m.read=true; });
  Zen.setClaims(all); renderList();
}

function renderFiles(c){
  const box = $('#d-files'); box.innerHTML = '';
  (c.masterFiles||[]).forEach((f,i)=>{
    const link = f.dataUrl || f.url;
    const pin = f.pending ? `<span class="dot" title="tik-prisegÄ—"></span>` : '';
    let el;
    if(f.type==='image') el = `<div>${pin}<img class="thumb" alt="${f.name}" src="${link}"></div>`;
    else if(f.type==='video') el = `<div>${pin}<video class="thumb" controls><source src="${link}"></video></div>`;
    else el = `<a class="pill" href="${link}" target="_blank">${Zen.icon(f.name)} ${f.name}</a>`;
    box.insertAdjacentHTML('beforeend', el);
  });
  $('#flag-pending').style.display = (c.masterFiles||[]).some(x=>x.pending) ? '' : 'none';
}

function renderChat(c){
  const box = $('#d-chat'); box.innerHTML='';
  const msgs = (c.messages||[]).filter(m=> (m.from==='master'&&m.to==='admin') || (m.from==='admin'&&m.to==='master'));
  if(!msgs.length){ box.innerHTML='<div class="muted">NÄ—ra Å¾inuÄiÅ³</div>'; return; }
  msgs.forEach(m=>{
    const me = m.from==='master';
    const wrap = document.createElement('div');
    wrap.style.display='flex';
    wrap.style.justifyContent = me?'flex-end':'flex-start';
    wrap.style.margin='4px 0';
    const bubble = document.createElement('div');
    bubble.className='card';
    bubble.style.maxWidth='80%';
    bubble.style.background = me?'#e0f2fe':'#e8f5e9';
    bubble.innerHTML = `<div class="muted" style="font-size:12px">${m.from} â†’ ${m.to} â€¢ ${Zen.fmt(m.time)}</div>
                        <div style="white-space:pre-wrap">${m.text||''}</div>`;
    if(m.files?.length){
      bubble.insertAdjacentHTML('beforeend','<div style="margin-top:6px" class="chips">'+ m.files.map(f=>`<span class="pill">${Zen.icon(f.name)} ${f.name}</span>`).join('') +'</div>');
    }
    wrap.appendChild(bubble); box.appendChild(wrap);
  });
  box.scrollTop = box.scrollHeight;
}

// detail controls
$('#btn-back').onclick = ()=>{ elDetail.classList.add('hidden'); openId=null; renderList(); };
$('#btn-start').onclick = ()=>{ if(!timerStart) timerStart=Date.now(); };
$('#btn-stop').onclick  = ()=>{ if(!openId || !timerStart) return; const all=Zen.getClaims(); const c=all.find(x=>x.id===openId); c.timeSpentSec=(c.timeSpentSec||0)+Math.floor((Date.now()-timerStart)/1000); timerStart=null; Zen.setClaims(all); $('#pill-time').textContent=`Sukaupta: ${((c.timeSpentSec||0)/3600).toFixed(2)} h`; };

$('#btn-add-files').onclick = ()=> $('#file-input').click();
$('#file-input').onchange = async (e)=>{
  if(!openId) return;
  const files = await Zen.uploadFiles(e.target.files);
  const all = Zen.getClaims(); const c = all.find(x=>x.id===openId);
  c.masterFiles = [...(c.masterFiles||[]), ...files];
  c.updatedAt = Date.now();
  Zen.setClaims(all);
  renderFiles(c);
  // queue sync op
  for(const f of files){
    await queueOp({ id:'op_'+Math.random().toString(36).slice(2), type:'upload', claimId:c.id, fileName:f.name });
  }
};

$('#chat-send').onclick = async ()=>{
  if(!openId) return;
  const text = ($('#chat-input').value||'').trim();
  if(!text) return;
  const all=Zen.getClaims(); const c=all.find(x=>x.id===openId);
  c.messages = [...(c.messages||[]), { id:'msg_'+Math.random().toString(36).slice(2), from:'master', to:'admin', text, time:new Date().toISOString() }];
  c.updatedAt = Date.now();
  Zen.setClaims(all);
  $('#chat-input').value='';
  renderChat(c);
  await queueOp({ id:'op_'+Math.random().toString(36).slice(2), type:'message', claimId:c.id });
};

// report
['rep-work','rep-labor','rep-km','rep-extra'].forEach(id=> $( '#'+id ).addEventListener('input', updateTotal));
function updateTotal(){
  const h = parseFloat($('#rep-labor').value||0);
  const km = parseFloat($('#rep-km').value||0);
  const ex = parseFloat($('#rep-extra').value||0);
  const parts = 0; // v0: be daliÅ³ eilutÄ—s
  const total = h*25 + km*0.35 + ex + parts;
  $('#rep-total').textContent = `Bendra suma: â‚¬ ${total.toFixed(2)}`;
}
$('#rep-save').onclick = async ()=>{
  if(!openId) return;
  const all=Zen.getClaims(); const c=all.find(x=>x.id===openId);
  const total = (parseFloat($('#rep-labor').value||0)*25) + (parseFloat($('#rep-km').value||0)*0.35) + (parseFloat($('#rep-extra').value||0)||0);
  c.masterReport = {
    work: $('#rep-work').value||'',
    laborHours: parseFloat($('#rep-labor').value||0),
    travelKm: parseFloat($('#rep-km').value||0),
    extraCosts: parseFloat($('#rep-extra').value||0),
    total,
    finalizedAt: new Date().toISOString()
  };
  c.status = 'IÅ¡sprÄ™sta';
  c.updatedAt = Date.now();
  Zen.setClaims(all);
  renderList();
  notify('BÅ«sena atnaujinta', `Pretenzija #${c.id} -> IÅ¡sprÄ™sta`);
  await queueOp({ id:'op_'+Math.random().toString(36).slice(2), type:'report', claimId:c.id });
};

// search refresh on storage change
window.addEventListener('storage', renderList);

// queue indicators
async function updateQueueIndicator(){
  const count = (await getQueue()).length;
  $('#q-count').textContent = count;
  $('#flag-queued').style.display = count? '' : 'none';
}

/* =========================================================
   CONFLICT RESOLUTION (simple LWW + merge arrays)
========================================================= */
function resolveConflict(local, remote){
  // Demo strategija: LWW pagal updatedAt; failÅ³ masyvus sujungiame pagal name
  if((remote.updatedAt||0) > (local.updatedAt||0)){
    const merged = {...local, ...remote};
    const lf = local.masterFiles||[], rf = remote.masterFiles||[];
    const by = new Map([...lf, ...rf].map(x=>[x.name, x]));
    merged.masterFiles = [...by.values()];
    return merged;
  }
  return local;
}

/* =========================================================
   PWA: manifest + service worker + background sync + push
========================================================= */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; $('#btn-install').classList.remove('hidden'); });
$('#btn-install').onclick = async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; $('#btn-install').classList.add('hidden'); };

(async function registerSW(){
  if(!('serviceWorker' in navigator)) return;

  // --- dynamic manifest (single-file delivery) ---
  const manifest ={
  "name": "Rubineta Master Mobile",
  "short_name": "Master",
  "start_url": "/mobilev4.html",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#111111",
  "icons": [
    { "src": "/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
let mEl = document.querySelector('link[rel="manifest"]');
if (!mEl) { mEl = document.createElement('link'); mEl.rel = 'manifest'; document.head.appendChild(mEl); }
// jei failai guli Å¡alia mobilev4.html:
mEl.href = './manifest.webmanifest';
// jei dÄ—si Ä¯ Å¡aknÄ¯ â€“ naudok: mEl.href = '/manifest.webmanifest';

  // --- service worker (as blob) ---
  const SECURE = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';

if ('serviceWorker' in navigator && SECURE) {
  try {
    const reg = await navigator.serviceWorker.register('./sw.js', { scope: './' });
    navigator.serviceWorker.addEventListener('message', (ev)=>{
      if (ev.data?.type === 'SYNC_OK') updateQueueIndicator();
    });
    console.log('âœ… SW uÅ¾registruotas', reg);
  } catch (e) {
    console.error('âŒ SW registracijos klaida:', e);
  }
} else {
  console.warn('SW praleidÅ¾iamas: nesaugus kontekstas arba nepalaikomas.', location.origin);
}

})();

// manual sync
$('#btn-sync-now').onclick = ()=> processQueue();

// online/offline flags
function updateConn(){
  $('#flag-online').style.display = navigator.onLine? '' : 'none';
  $('#flag-offline').style.display = navigator.onLine? 'none' : '';
}
updateConn();
window.addEventListener('online', updateConn);
window.addEventListener('offline', updateConn);

/* =========================================================
   NOTIFICATIONS
========================================================= */
async function ensurePermission(){
  if(!('Notification' in window)) return false;
  if(Notification.permission === 'granted') return true;
  if(Notification.permission === 'denied') return false;
  const p = await Notification.requestPermission();
  return p==='granted';
}
async function getQueue(){ if (!syncDB) return []; return idbAll(idbTx(syncDB,'ops')); }
async function queueOp(op){
  if (!syncDB) { console.warn('IDB dar nepasiruoÅ¡Ä™s, praleidÅ¾iam:', op.type); return; }
  const store = idbTx(syncDB,'ops','readwrite');
  await idbPut(store, op);
  // ...
}

async function notify(title, body){
  const ok = await ensurePermission();
  if(!ok) return;
  if('serviceWorker' in navigator){
    const reg = await navigator.serviceWorker.ready;
    reg.showNotification(title, { body });
  } else new Notification(title, { body });
}
$('#btn-notify-test').onclick = ()=> notify('Test praneÅ¡imas', 'Sveikas, meistre!');

/* INIT */
migrateClaims();           // <-- nauja eilutÄ—
// jei â€Man priskirtosâ€œ nieko neranda â€“ perjunk Ä¯ â€Visosâ€œ
function smartDefaultFilter(){
  const mine = Zen.getClaims().some(c => (c.assignedPartner||'').toLowerCase()===(CURRENT.name||'').toLowerCase());
  pageFilter = mine ? 'assigned' : 'all';
  const sel = document.querySelector('#filter');
  if (sel) sel.value = pageFilter;
}
smartDefaultFilter();
renderList();
updateQueueIndicator();

// jei atÄ—jo su ?id=CLM-... -> atidaryk detales iÅ¡kart
const urlId = new URLSearchParams(location.search).get('id');
if (urlId) {
  // uÅ¾tikrinam, kad matysis ir jei nepriskirta
  pageFilter = 'all';
  const sel = document.querySelector('#filter'); if (sel) sel.value='all';
  renderList();
  showDetail(urlId);
}
</script>
</body>
</html>

