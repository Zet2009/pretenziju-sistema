<!DOCTYPE html>
<html lang="lt" manifest="manifest.appcache">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Rubineta Master</title>

    <!-- PWA Manifest -->
    <link rel="manifest" id="manifest-link">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <style>
        :root {
            --primary: #2D2D2D;
            --secondary: #FFCC00;
            --light: #F5F5F5;
            --white: #FFFFFF;
            --gray: #757575;
            --font: 'Roboto', 'Arial', sans-serif;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: var(--font);
            background: var(--light);
            color: var(--primary);
            line-height: 1.6;
            padding: 0;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Vir≈°utinƒó juosta */
        .header {
            background: var(--primary);
            color: var(--white);
            padding: 14px 16px;
            text-align: center;
            font-weight: 500;
            font-size: 18px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        .back-btn {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--white);
            text-decoration: none;
        }

        /* Pagrindinis turinys */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--white);
        }
        .card {
            background: var(--white);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 16px;
            margin-bottom: 16px;
        }
        .card h3 {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 16px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .info-row b {
            color: var(--primary);
        }

        /* Mygtukai */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
        }
        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }
        .btn-secondary {
            background: var(--secondary);
            color: var(--primary);
        }

        /* Naujas darbas */
        .new-job-alert {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Lankstus mygtukas apaƒçioje */
        .action-bar {
            padding: 12px 16px;
            background: var(--white);
            border-top: 1px solid #eee;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        /* Statusas */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .status-new { background: #f44336; }
        .status-assigned { background: #ff9800; }
        .status-completed { background: #4caf50; }

        /* Loading ir klaidos */
        .loading, .error {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
    </style>
</head>
<body>

    <!-- Vir≈°utinƒó juosta -->
    <div class="header">
        <a href="#" class="back-btn" id="backButton" style="display:none;">‚Üê</a>
        Rubineta Master
    </div>

    <!-- Pagrindinis turinys -->
    <div class="content" id="app-content">
        <div class="loading">‚è≥ Kraunama...</div>
    </div>

    <!-- Veiksm≈≥ juosta -->
    <div class="action-bar" id="actionBar" style="display:none;">
        <button class="btn btn-primary" onclick="completeJob()">Pa≈æymƒóti kaip atlikta</button>
    </div>

    <script>
        // === 1. PWA registracija ir Push Notifications ===
        function registerServiceWorker() {
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker.register("/sw.js")
                    .then(reg => console.log("‚úÖ ServiceWorker registered:", reg))
                    .catch(err => console.error("‚ùå SW registration failed:", err));
            }
        }

        async function initPush() {
            if (!("Notification" in window) || !("serviceWorker" in navigator)) return;

            const permission = await Notification.requestPermission();
            if (permission !== "granted") return;

            const reg = await navigator.serviceWorker.ready;
            try {
                const subscription = await reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: "BKbJqRkZcUWzYxgVwvQlOZKXmT1dL0Hh9p9N9S0sG1j4M7B3n0p8Y6j3j3j3j3j3j3j3j3j3j3j3j3j3j3j3" // ‚Üê pakeisk ƒØ savo VAPID public key
                });
                console.log("üîî Push prisijungta:", subscription);

                // Si≈≥sti pretenzij≈≥ serveriui
                fetch('/api/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(subscription)
                });
            } catch (err) {
                console.error("‚ùå Nepavyko prisijungti prie push:", err);
            }
        }

        // === 2. Pridƒóti manifestƒÖ dinami≈°kai ===
        const manifest = {
            name: "Rubineta Master Mobile",
            short_name: "MasterMobile",
            start_url: "/mobilev5.html",
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#000000",
            icons: [
                { src: "/icon-192.png", sizes: "192x192", type: "image/png" },
                { src: "/icon-512.png", sizes: "512x512", type: "image/png" }
            ]
        };
        const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        document.getElementById('manifest-link').href = url;

        // === 3. Duomen≈≥ krovimas (imitacija localStorage arba API) ===
        let currentClaim = null;

        function loadJobs() {
            const claims = JSON.parse(localStorage.getItem('claims') || '[]');
            const assignedToMe = claims.filter(c => 
                c.assignedPartner === localStorage.getItem('currentUserEmail') && 
                c.status !== 'U≈ædaryta'
            );

            const content = document.getElementById('app-content');
            if (assignedToMe.length === 0) {
                content.innerHTML = '<div class="card"><p>Nƒóra priskirt≈≥ darb≈≥.</p></div>';
                return;
            }

            content.innerHTML = '';
            assignedToMe.forEach(job => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>Pretenzija: ${job.id}</h3>
                    <div class="info-row"><b>Klientas:</b> ${job.contact?.name} ${job.contact?.surname}</div>
                    <div class="info-row"><b>Adresas:</b> ${[job.contact?.street, job.contact?.city, job.contact?.postal].filter(Boolean).join(', ')}</div>
                    <div class="info-row"><b>Produktas:</b> ${job.product}</div>
                    <div class="info-row"><b>Statusas:</b> <span class="status-badge status-${job.status.toLowerCase().replace(/\s+/g, '-')}">${job.status}</span></div>
                    <div class="info-row"><b>Gedimas:</b> ${job.description}</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="viewDetails('${job.id}')">Detalƒós</button>
                        <button class="btn btn-secondary" onclick="callClient('${job.contact?.phone}')">Skambinti</button>
                    </div>
                `;
                content.appendChild(card);
            });
        }

        // === 4. Funkcijos ===
        function viewDetails(id) {
            const claims = JSON.parse(localStorage.getItem('claims') || '[]');
            currentClaim = claims.find(c => c.id === id);
            if (!currentClaim) {
                alert('Darbas nerastas.');
                return;
            }

            const content = document.getElementById('app-content');
            const statusClass = currentClaim.status.toLowerCase().replace(/\s+/g, '-');
            content.innerHTML = `
                <div class="card">
                    <h3>${currentClaim.product}</h3>
                    <div class="info-row"><b>ID:</b> ${currentClaim.id}</div>
                    <div class="info-row"><b>Klientas:</b> ${currentClaim.contact?.name} ${currentClaim.contact?.surname}</div>
                    <div class="info-row"><b>Telefonas:</b> <a href="tel:${currentClaim.contact?.phone}">${currentClaim.contact?.phone}</a></div>
                    <div class="info-row"><b>Adresas:</b> ${[currentClaim.contact?.street, currentClaim.contact?.city, currentClaim.contact?.postal].filter(Boolean).join(', ')}</div>
                    <div class="info-row"><b>Statusas:</b> <span class="status-badge status-${statusClass}">${currentClaim.status}</span></div>
                    <div class="info-row"><b>Gedimas:</b> ${currentClaim.description}</div>
                    <div class="info-row"><b>Poreikis:</b> ${{
                        'send-part': 'Si≈≥sti dalƒØ',
                        'send-technician': 'Atvykti patikrinti',
                        'refund': 'GrƒÖ≈æinti pinigus',
                        'exchange': 'Keisti produktƒÖ'
                    }[currentClaim.request] || currentClaim.request}</div>
                </div>
                ${currentClaim.files && currentClaim.files.length > 0 ? `
                <div class="card">
                    <h3>Foto / dokumentai</h3>
                    ${currentClaim.files.map(f => `<a href="${f}" target="_blank">üìé Nuotrauka</a><br>`).join('')}
                </div>` : ''}
            `;

            document.getElementById('actionBar').style.display = 'block';
            document.querySelector('.back-btn').style.display = 'inline';
        }

        function completeJob() {
            if (!currentClaim) return;

            if (confirm('Ar tikrai baigƒóte ≈°ƒØ darbƒÖ?')) {
                currentClaim.status = 'U≈ædaryta';
                currentClaim.completedAt = new Date().toISOString();

                const claims = JSON.parse(localStorage.getItem('claims') || '[]');
                const index = claims.findIndex(c => c.id === currentClaim.id);
                if (index !== -1) {
                    claims[index] = currentClaim;
                    localStorage.setItem('claims', JSON.stringify(claims));
                }

                alert('‚úÖ Darbas pa≈æymƒótas kaip atliktas');
                document.getElementById('actionBar').style.display = 'none';
                loadJobs();
            }
        }

        function callClient(phone) {
            if (phone) {
                window.location.href = `tel:${phone}`;
            } else {
                alert('Nenurodytas telefono numeris');
            }
        }

        function goBack() {
            document.getElementById('actionBar').style.display = 'none';
            loadJobs();
            document.querySelector('.back-btn').style.display = 'none';
        }

        // === 5. Paleidimas ===
        document.getElementById('backButton').onclick = goBack;

        window.onload = () => {
            registerServiceWorker();
            initPush();
            loadJobs();
        };

        // Jei nori, kad automati≈°kai atnaujint≈≥ (kai pasikeiƒçia duomenys)
        window.addEventListener('storage', () => {
            if (document.getElementById('actionBar').style.display === 'none') {
                loadJobs();
            }
        });
    </script>

</body>
</html>
