<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pretenzija #ID ‚Äì Rubineta</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1976d2;
            --primary-dark: #1565c0;
            --secondary: #2D2D2D;
            --light: #F5F5F5;
            --white: #FFFFFF;
            --gray-light: #f8f9fa;
            --gray: #e0e0e0;
            --gray-dark: #6c757d;
            --danger: #d32f2f;
            --success: #2e7d32;
            --font: 'Roboto', sans-serif;
            --radius: 12px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font);
            background: var(--light);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            font-size: 14px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--white);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        h2 {
            color: var(--secondary);
            margin: 24px 0 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray);
            font-weight: 500;
            font-size: 1.25rem;
        }

        .field {
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
        }

        .field-label {
            font-weight: 500;
            color: var(--secondary);
            min-width: 140px;
            display: inline-block;
            font-size: 0.95rem;
        }

        .status {
            font-weight: bold;
            color: var(--danger);
        }

        .status.I≈°sprƒôsta {
            color: var(--success);
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: var(--gray-dark);
            font-size: 12px;
            padding: 20px;
            border-top: 1px solid #ddd;
        }

        /* === File Links === */
        .file-item {
            margin: 4px 0;
        }

        .file-item a {
            color: var(--primary);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: var(--gray-light);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .file-item a:hover {
            background: #e3f2fd;
            border-color: var(--primary);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(25, 118, 210, 0.15);
        }

        /* === Chat Styles === */
        .zen-section {
    background: var(--white);
    border: 1px solid var(--gray);
    border-radius: var(--radius);
    padding: 16px;
    margin: 24px auto; /* Centruojama ir toks pat atitraukimas kaip container */
    box-shadow: var(--shadow);
    max-width: 800px; /* Atitinka .container plotƒØ */
}

        .zen-chat-thread {
            border: 1px solid var(--gray);
            border-radius: var(--radius);
            padding: 10px;
            max-height: 280px;
            overflow-y: auto;
            background: var(--gray-light);
            margin-bottom: 12px;
        }

        .zen-chat-row {
            margin: 8px 0;
            display: flex;
        }

        .zen-right {
            justify-content: flex-end;
        }

        .zen-chat-bubble {
            max-width: 78%;
            padding: 10px 12px;
            border-radius: 16px;
            border: 1px solid #e0e0e0;
            background: #f8fafc;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .zen-bubble-admin { background: #e8f5e9; }
        .zen-bubble-user { background: #e3f2fd; }
        .zen-bubble-master { background: #fff3cd; }

        .zen-chat-meta {
            font-size: 11px;
            color: var(--gray-dark);
            margin-bottom: 4px;
        }

        .zen-chat-files {
            margin-top: 6px;
            font-size: 13px;
        }

        .zen-chat-input {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .zen-chat-input input[type="text"] {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border: 1px solid var(--gray);
            border-radius: 8px;
            font-family: var(--font);
        }

        .zen-chat-input input[type="file"] {
            border: 1px dashed var(--gray);
            padding: 6px 10px;
            border-radius: 8px;
            background: var(--white);
        }

        .zen-chat-input button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .zen-chat-input button:hover {
            background: var(--primary-dark);
        }

        .zen-muted {
            color: var(--gray-dark);
            font-size: 13px;
            margin-top: 6px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 16px;
            }
            .field-label {
                min-width: 120px;
                font-size: 0.9rem;
            }
            .zen-chat-input {
                flex-direction: column;
            }
            .zen-chat-input input[type="text"] {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>J≈´s≈≥ pretenzija</h2>

        <div class="field"><span class="field-label">ID:</span> <span id="claim-id"></span></div>
        <div class="field"><span class="field-label">Data:</span> <span id="claim-date"></span></div>
        <div class="field"><span class="field-label">Tema:</span> <span id="claim-topic"></span></div>
        <div class="field"><span class="field-label">Produktas:</span> <span id="claim-product"></span></div>
        <div class="field"><span class="field-label">Apra≈°ymas:</span> <span id="claim-description"></span></div>
        <div class="field"><span class="field-label">Kliento reikalavimas:</span> <span id="claim-request"></span></div>
        <div class="field"><span class="field-label">B≈´sena:</span> <span id="claim-status" class="status"></span></div>

        <h2>Vartotojo dokumentai</h2>
        <div id="user-files"></div>

        <h2>Pirkimo dokumentas</h2>
        <div id="purchase-document"></div>

        <h2>Papildomi dokumentai</h2>
        <div id="additional-files"></div>

        <h2>B≈´senos istorija</h2>
        <div id="status-history"></div>
    </div>

    <!-- Susira≈°inƒójimas su adminu -->
    <div class="zen-section" id="zen-user-chat">
        <h2>Susira≈°inƒójimas su administratoriumi</h2>
        <div id="zen-user-thread" class="zen-chat-thread">
            <div class="zen-muted">Kraunama...</div>
        </div>
        <div class="zen-chat-input">
            <input id="zen-user-input" type="text" placeholder="Para≈°ykite ≈æinutƒô administratoriui‚Ä¶" />
            <input id="zen-user-files" type="file" multiple />
            <button id="zen-user-send">Si≈≥sti</button>
        </div>
        <div id="zen-user-files-preview" class="zen-muted"></div>
    </div>

    <footer>¬© 2025 Rubineta. Visos teisƒós saugomos. | info@rubineta.lt</footer>

    <script>
        // --- ZenChat Utils ---
        (function () {
            if (window.ZenChat) return;
            window.ZenChat = {
                getClaims: function () {
                    try {
                        return JSON.parse(localStorage.getItem('claims') || '[]');
                    } catch (_) {
                        return [];
                    }
                },
                setClaims: function (arr) {
                    localStorage.setItem('claims', JSON.stringify(arr));
                },
                fmt: function (ts) {
                    try {
                        return new Date(ts).toLocaleString('lt-LT');
                    } catch (_) {
                        return ts;
                    }
                },
                icon: function (name) {
                    const n = (name || '').toLowerCase();
                    if (/\.(jpg|jpeg|png|webp|gif)$/.test(n)) return 'üñºÔ∏è';
                    if (/\.(mp4|webm|mov)$/.test(n)) return 'üé•';
                    if (/\.(pdf)$/.test(n)) return 'üìÑ';
                    return 'üìé';
                },
                legacyToNew: function (m) {
                    if (m && m.from && m.to) return m;
                    if (!m) return m;
                    if (m.author === 'quality') return { from: 'admin', to: 'user', text: m.text, files: m.attachments || [], time: m.time, id: m.id };
                    if (m.author === 'customer') return { from: 'user', to: 'admin', text: m.text, files: m.attachments || [], time: m.time, id: m.id };
                    if (m.author === 'master') return { from: 'master', to: 'admin', text: m.text, files: m.attachments || [], time: m.time, id: m.id };
                    return m;
                },
                uploadFiles: async function (fileList) {
                    const out = [];
                    for (const f of fileList) {
                        const url = URL.createObjectURL(f);
                        out.push({
                            name: f.name,
                            url,
                            type: /\.(jpg|jpeg|png|webp|gif)$/i.test(f.name) ? 'image' :
                                   /\.(mp4|webm|mov)$/i.test(f.name) ? 'video' :
                                   /\.(pdf)$/i.test(f.name) ? 'pdf' : 'other'
                        });
                    }
                    return out;
                },
                renderThread: function (container, list, perspective) {
                    if (!list.length) {
                        container.innerHTML = '<div class="zen-muted">Nƒóra ≈æinuƒçi≈≥</div>';
                        return;
                    }
                    container.innerHTML = list.map(m => {
                        const side = (m.from === perspective) ? 'zen-right' : '';
                        const bubbleClass = m.from === 'admin' ? 'zen-bubble-admin' :
                                            m.from === 'user' ? 'zen-bubble-user' :
                                            'zen-bubble-master';
                        const files = (m.files || []).map(f =>
                            `<div><a href="${f.url}" target="_blank">${ZenChat.icon(f.name)} ${f.name}</a></div>`
                        ).join('');
                        return `
                            <div class="zen-chat-row ${side}">
                                <div class="zen-chat-bubble ${bubbleClass}">
                                    <div class="zen-chat-meta">${m.from} ‚Üí ${m.to} ‚Ä¢ ${ZenChat.fmt(m.time)}</div>
                                    <div style="white-space: pre-wrap">${m.text || ''}</div>
                                    ${files ? `<div class="zen-chat-files">${files}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                    container.scrollTop = container.scrollHeight;
                }
            };
        })();
    </script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const claimId = urlParams.get('id');

        if (!claimId) {
            alert('Nenurodytas pretenzijos ID.');
            history.back();
        }

        const claims = ZenChat.getClaims();
        const claim = claims.find(c => c.id === claimId);

        if (!claim) {
            alert('Pretenzija nerasta.');
            history.back();
        }

        // U≈æpildyti pagrindinƒô informacijƒÖ
        document.getElementById('claim-id').textContent = claim.id;
        document.getElementById('claim-date').textContent = ZenChat.fmt(claim.date);
        document.getElementById('claim-topic').textContent = claim.topic;
        document.getElementById('claim-product').textContent = claim.product;
        document.getElementById('claim-description').textContent = claim.description;
        document.getElementById('claim-request').textContent = claim.request;
        document.getElementById('claim-status').textContent = claim.status;
        document.getElementById('claim-status').classList.add(claim.status);

        // Vartotojo failai
        const userFilesContainer = document.getElementById('user-files');
        if (Array.isArray(claim.files) && claim.files.length > 0) {
            claim.files.forEach(url => {
                if (typeof url !== 'string') return;
                const fileName = url.split('/').pop();
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `<a href="${url}" target="_blank">üìé ${fileName}</a>`;
                userFilesContainer.appendChild(item);
            });
        } else {
            userFilesContainer.innerHTML = '<div class="file-item">Nƒóra ƒØkelt≈≥ fail≈≥</div>';
        }

        // Pirkimo dokumentas
        const purchaseDocContainer = document.getElementById('purchase-document');
        if (claim.purchaseDocument) {
            const url = claim.purchaseDocument;
            const fileName = url.split('/').pop();
            let icon, label;

            if (/\.(jpg|jpeg|png|webp)$/i.test(url)) {
                icon = 'üì∑'; label = 'Per≈æi≈´rƒóti nuotraukƒÖ';
            } else if (/\.(mp4|webm)$/i.test(url)) {
                icon = 'üé•'; label = 'Per≈æi≈´rƒóti video';
            } else if (/\.(pdf)$/i.test(url)) {
                icon = 'üìÑ'; label = 'Atidaryti PDF';
            } else {
                icon = 'üìé'; label = 'Atsisi≈≥sti dokumentƒÖ';
            }

            purchaseDocContainer.innerHTML = `<a href="${url}" target="_blank">${icon} ${label}</a>`;
        } else {
            purchaseDocContainer.innerHTML = '<div class="file-item" style="color:var(--danger)">Pirkimo dokumentas nerastas.</div>';
        }

        // Papildomi dokumentai
        const additionalFilesContainer = document.getElementById('additional-files');
        if (claim.additionalFiles && claim.additionalFiles.length > 0) {
            claim.additionalFiles.forEach(att => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `<a href="${att.url}" target="_blank">üìé ${att.name}</a>`;
                additionalFilesContainer.appendChild(item);
            });
        } else {
            additionalFilesContainer.innerHTML = '<div class="file-item">Nƒóra papildom≈≥ dokument≈≥</div>';
        }

        // B≈´senos istorija
        const historyContainer = document.getElementById('status-history');
        const historyEvents = [
            { time: claim.date, action: 'Pretenzija pateikta' },
            { time: claim.date, action: `B≈´sena: ${claim.status}` }
        ];

        if (claim.resolvedAt) {
            historyEvents.push({ time: claim.resolvedAt, action: 'I≈°sprƒôsta' });
        }

        historyEvents.sort((a, b) => new Date(a.time) - new Date(b.time));

        historyEvents.forEach(event => {
            const item = document.createElement('div');
            item.className = 'field';
            item.innerHTML = `
                <span class="field-label">${ZenChat.fmt(event.time)}</span>
                <span>${event.action}</span>
            `;
            historyContainer.appendChild(item);
        });
    </script>

    <!-- Chat logika -->
    <script>
        (function () {
            const params = new URLSearchParams(location.search);
            const id = params.get('id');
            let claims = ZenChat.getClaims();
            let claim = claims.find(c => c.id === id) || claims[0];
            if (!claim) return;

            if (Array.isArray(claim.messages)) {
                claim.messages = claim.messages.map(ZenChat.legacyToNew);
                ZenChat.setClaims(claims);
            }

            const box = document.getElementById('zen-user-thread');
            const input = document.getElementById('zen-user-input');
            const filesInput = document.getElementById('zen-user-files');
            const preview = document.getElementById('zen-user-files-preview');

            function draw() {
                const fresh = ZenChat.getClaims().find(x => x.id === claim.id);
                if (!fresh) return;
                claim = fresh;
                const msgs = (claim.messages || []).filter(m =>
                    (m.from === 'user' && m.to === 'admin') ||
                    (m.from === 'admin' && m.to === 'user')
                );
                ZenChat.renderThread(box, msgs, 'user');
            }

            filesInput.addEventListener('change', () => {
                preview.textContent = [...filesInput.files].map(f => f.name).join(', ');
            });

            document.getElementById('zen-user-send').addEventListener('click', async () => {
                const text = (input.value || '').trim();
                const uploaded = await ZenChat.uploadFiles(filesInput.files);
                if (!text && uploaded.length === 0) return;

                const all = ZenChat.getClaims();
                const c = all.find(x => x.id === claim.id);
                if (!c) return;

                if (!Array.isArray(c.messages)) c.messages = [];

                c.messages.push({
                    id: 'msg_' + Math.random().toString(36).slice(2),
                    from: 'user',
                    to: 'admin',
                    text,
                    files: uploaded,
                    time: new Date().toISOString()
                });

                ZenChat.setClaims(all);
                input.value = '';
                filesInput.value = '';
                preview.textContent = '';
                draw();
            });

            draw(); // Pirminis atvaizdavimas
        })();
    </script>
</body>
</html>
