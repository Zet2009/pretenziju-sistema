<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rubineta – katalogo lentelė</title>
  <style>
    /* ... (styles remain the same as in previous improved version) ... */
  </style>
</head>
<body>
  <header>
    <h1>Rubineta – katalogo lentelė</h1>
    <div class="controls">
      <div class="control-group">
        <label for="per">Įrašų per puslapį</label>
        <input id="per" type="number" value="25" min="10" max="100" />
      </div>
      <div class="control-group">
        <button id="load">Įkelti produktus</button>
      </div>
      <div class="control-group">
        <span id="loading" class="loading" style="display:none;"></span>
      </div>
      <div class="control-group">
        <label for="debug">Įjungti derinimą</label>
        <input id="debug" type="checkbox" />
      </div>
    </div>
    <div class="controls" style="margin-top: 10px;">
      <div class="control-group">
        <label for="apiUrl">API URL</label>
        <input id="apiUrl" type="text" value="/api/products?per_page=100&page=1&lang=lt" style="width: 300px;" />
      </div>
    </div>
  </header>

  <main>
    <div id="alert"></div>
    <div id="debug-info" style="display: none; margin: 10px 0; padding: 10px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px;"></div>
    <div id="info" class="pagination-info"></div>

    <table id="tbl">
      <thead>
        <tr>
          <th style="width:56px">Nuotrauka</th>
          <th style="width:20%">Pavadinimas</th>
          <th style="width:10%">SKU</th>
          <th style="width:13%">Kategorijos</th>
          <th style="width:6%">Kaina</th>
          <th style="width:7%">EAN</th>
          <th style="width:7%">Serija</th>
          <th style="width:6%">Garantija</th>
          <th style="width:6%">Jungtis</th>
          <th style="width:6%">Spalva</th>
          <th style="width:8%">Padengimas</th>
          <th style="width:9%">Atnaujinta</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination" id="pagination"></div>
  </main>

  <script>
    const $ = (s, el = document) => el.querySelector(s);
    const $$ = (s, el = document) => el.querySelectorAll(s);

    let allProducts = [];
    let currentPage = 1;
    let isLoading = false;
    let debugMode = false;

    // Debug informacijos rodymas
    function showDebugInfo(info) {
      if (!debugMode) return;
      
      const debugDiv = $('#debug-info');
      debugDiv.style.display = 'block';
      debugDiv.innerHTML = `<pre>${JSON.stringify(info, null, 2)}</pre>`;
    }

    // Rodomi pranešimai
    function showMessage(message, type = 'error') {
      const alert = $('#alert');
      alert.textContent = message;
      alert.className = type;
      
      if (type === 'error') {
        console.error(message);
        // Automačiškai paslėpti po 10 sekundžių
        setTimeout(() => {
          if (alert.textContent === message) {
            alert.textContent = '';
            alert.className = '';
          }
        }, 10000);
      } else {
        // Automačiškai paslėpti pranešimus apie sėkmę po 5 sekundes
        setTimeout(() => {
          if (alert.textContent === message) {
            alert.textContent = '';
            alert.className = '';
          }
        }, 5000);
      }
    }

    // Rodyti/uždaryti įkėlimo indikatorių
    function setLoading(loading) {
      isLoading = loading;
      const loadButton = $('#load');
      const loadingIndicator = $('#loading');
      
      if (loading) {
        loadButton.disabled = true;
        loadButton.textContent = 'Kraunama...';
        loadingIndicator.style.display = 'inline-block';
      } else {
        loadButton.disabled = false;
        loadButton.textContent = 'Įkelti produktus';
        loadingIndicator.style.display = 'none';
      }
    }

    function cleanHTML(html) {
      const t = document.createElement('template');
      t.innerHTML = String(html || '');
      t.content.querySelectorAll('script, iframe').forEach(n => n.remove());
      return t.innerHTML.trim();
    }

    // Patikrinti, ar produktas yra lietuviškas (pagerinta versija)
    function isLithuanianProduct(product) {
      if (!product) return false;
      
      // 1. Tikriname pagal kalbos atributą
      const langMeta = (product.meta_data || []).find(m => m.key === 'language' || m.key === 'wpml_language');
      if (langMeta && langMeta.value === 'lt') return true;
      
      // 2. Tikriname pagal permalink (URL)
      if (product.permalink && product.permalink.includes('/lt/')) return true;
      if (product.slug && product.slug.endsWith('-lt')) return true;
      
      // 3. Tikriname pagal pavadinimą/aprašymą (lietuviški simboliai)
      const hasLithuanianChars = (text) => text && /[ąčęėįšųūž]/i.test(text);
      
      if (hasLithuanianChars(product.name) || hasLithuanianChars(product.description)) {
        return true;
      }
      
      // 4. Tikriname pagal kategorijas (jei yra lietuviškų kategorijų)
      const lithuanianCategories = (product.categories || []).filter(cat => 
        cat.name && hasLithuanianChars(cat.name)
      );
      
      if (lithuanianCategories.length > 0) return true;
      
      // 5. Jei niekas neveikia, bet produktas turi LT kalbos duomenis
      const ltName = (product.meta_data || []).find(m => m.key === 'name_lt');
      const ltDescription = (product.meta_data || []).find(m => m.key === 'description_lt');
      
      if (ltName || ltDescription) return true;
      
      // Jei visi metodai nepavyko, bet norime matyti visus produktus derinimo režime
      if (debugMode) return true;
      
      return false;
    }

    function getMeta(p, key) {
      const m = (p.meta_data || []).find(x => x && x.key === key);
      return m ? m.value : null;
    }

    function getAttr(p, slug) {
      const a = (p.attributes || []).find(x => x && x.slug === slug);
      return a ? (a.options || []).join(', ') : '';
    }

    function firstImage(p) {
      return (p.images && p.images[0]) ? p.images[0].src : '';
    }

    // API užklausos funkcija su geresniu klaidų valdymu
    async function fetchProducts(page) {
      const apiUrl = $('#apiUrl').value || `/api/products?per_page=100&page=${page}&lang=lt`;
      
      try {
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Serveris grąžino ne JSON formatą');
        }
        
        const data = await response.json();
        return data;
      } catch (error) {
        showDebugInfo({
          error: 'API užklausos klaida',
          page: page,
          url: apiUrl,
          message: error.message
        });
        
        throw error;
      }
    }

    // Testinė užklausa, kad patikrintume API
    async function testApiConnection() {
      try {
        setLoading(true);
        showMessage('Tikrinama API prieiga...', 'success');
        
        const testData = await fetchProducts(1);
        showDebugInfo({
          apiResponse: Array.isArray(testData) ? 
            `Gauta ${testData.length} įrašų` : 
            'Gautas ne masyvas',
          firstItem: Array.isArray(testData) && testData.length > 0 ? testData[0] : 'Nėra duomenų',
          responseType: Array.isArray(testData) ? 'array' : typeof testData
        });
        
        if (Array.isArray(testData)) {
          showMessage(`API veikia. Gauta ${testData.length} įrašų. Filtruojame lietuviškus produktus...`, 'success');
          return testData;
        } else {
          showMessage('API grąžino netinkamą formato atsakymą (ne masyvą)', 'error');
          return [];
        }
      } catch (error) {
        showMessage(`API ryšio klaida: ${error.message}`, 'error');
        return [];
      } finally {
        setLoading(false);
      }
    }

    async function loadProducts() {
      if (isLoading) return;
      
      setLoading(true);
      $('#alert').textContent = '';
      
      try {
        let allData = [];
        let page = 1;
        const maxPages = debugMode ? 50 : 10; // Daugiau puslapių derinimo režime

        // Pirmiausia patikrinkime API
        const testData = await testApiConnection();
        if (testData.length === 0 && !debugMode) {
          showMessage('API nepateikė jokių duomenų. Įjunkite derinimo režimą detalesnei informacijai.', 'error');
          return;
        }

        showMessage('Pradedamas duomenų įkėlimas...', 'success');
        
        // Jei testiniai duomenys jau gauti, pradedame nuo jų
        if (testData.length > 0) {
          allData = testData.filter(isLithuanianProduct);
          page = 2; // Jau turime 1 puslapį
        }

        // Įkeliame likusius puslapius
        while (page <= maxPages) {
          try {
            showMessage(`Įkeliamas puslapis ${page}...`, 'success');
            
            const data = await fetchProducts(page);
            
            if (!Array.isArray(data) || data.length === 0) {
              break;
            }
            
            // Filtruojame tik lietuviškus produktus
            const lithuanianProducts = data.filter(isLithuanianProduct);
            allData = allData.concat(lithuanianProducts);
            
            showDebugInfo({
                page: page,
                totalReceived: data.length,
                lithuanianProducts: lithuanianProducts.length,
                totalCollected: allData.length
            });

            // Jei gauta mažiau nei 100 įrašų, reiškia daugiau puslapių nėra
            if (data.length < 100) {
              break;
            }
            
            page++;
          } catch (error) {
            showMessage(`Klaida įkeliant puslapį ${page}: ${error.message}`, 'error');
            break;
          }
        }

        if (allData.length === 0) {
          showMessage('Nerasta lietuviškų produktų. Patikrinkite:<br>1. Ar API grąžina duomenis<br>2. Ar produktai pažymėti kaip lietuviški<br>3. Įjunkite derinimo režimą', 'error');
        } else {
          allProducts = allData;
          currentPage = 1;
          updateTable();
          showMessage(`Sėkmingai įkelta ${allProducts.length} lietuviškų produktų.`, 'success');
        }
      } catch (e) {
        showMessage(`Įvyko kritinė klaida: ${e.message}`, 'error');
        console.error(e);
      } finally {
        setLoading(false);
      }
    }

    // Liko like funkcijos tos pačios (renderTable, renderPagination, updateTable, escapeHtml)
    // ... (renderTable, renderPagination, updateTable, escapeHtml functions remain the same) ...

    // Event listeners
    $('#load').addEventListener('click', loadProducts);
    
    $('#per').addEventListener('change', function() {
      if (allProducts.length > 0) {
        currentPage = 1;
        updateTable();
      }
    });

    $('#debug').addEventListener('change', function() {
      debugMode = this.checked;
      $('#debug-info').style.display = debugMode ? 'block' : 'none';
      if (debugMode) {
        showMessage('Derinimo režimas įjungtas. Rodomi visi produktai, nepriklausomai nuo kalbos.', 'success');
      }
    });

    // Pridedame klaviatūros palaikymą
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !isLoading) {
        loadProducts();
      }
    });

    // Inicijuojame puslapį
    window.addEventListener('DOMContentLoaded', function() {
      showMessage('Paspauskite "Įkelti produktus" norėdami pradėti.', 'success');
    });
  </script>
</body>
</html>
