<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meistro zona ‚Äì Rubineta</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2D2D2D;
            --secondary: #FFCC00;
            --light: #F5F5F5;
            --dark: #212121;
            --gray: #757575;
            --font: 'Roboto', 'Arial', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font);
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 24px;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 10px;
        }
        .section {
            margin-bottom: 25px;
        }
        .field {
            margin: 8px 0;
        }
        .field-label {
            font-weight: 500;
            color: var(--primary);
            display: inline-block;
            min-width: 140px;
        }
        .attachments-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        .file-item {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            background: #f9f9f9;
            max-width: 320px;
            text-align: center;
        }
        .file-item img, .file-item video {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
        }
        footer {
            text-align: center;
            margin-top: 50px;
            color: var(--gray);
            font-size: 12px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
        }
        .alert-error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        .alert-success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }

        @media (max-width: 600px) {
    .zen-chat-input {
        flex-direction: column;
        align-items: stretch;
    }
    #zen-master-input,
    #zen-master-send {
        width: 100%;
        margin-top: 5px;
    }
}
    </style>

<style>
/* === zen-chat scoped styles === */
.zen-chat-thread{border:1px solid #e5e7eb;border-radius:10px;padding:10px;max-height:280px;overflow:auto;background:#fff}
.zen-chat-row{margin:8px 0;display:flex}
.zen-chat-bubble{max-width:78%;border:1px solid #e5e7eb;padding:8px 10px;border-radius:12px;background:#f8fafc}
.zen-chat-row.zen-right{justify-content:flex-end}
.zen-bubble-admin{background:#e8f5e9}
.zen-bubble-user{background:#e8f0fe}
.zen-bubble-master{background:#fff3cd}
.zen-chat-meta{font-size:11px;color:#6b7280;margin-bottom:4px}
.zen-chat-files{margin-top:6px;font-size:12px}
.zen-chat-input{display:flex;gap:8px;margin-top:8px;align-items:center}
.zen-pill{display:inline-block;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:12px;color:#4b5563}
.zen-muted{color:#6b7280;font-size:14px}
.zen-section{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0}
</style>

<script>
// === zen-chat utils (namespaced) ===
(function(){
  if (window.ZenChat) return; // singleton
  window.ZenChat = {
    getClaims: function(){ try{return JSON.parse(localStorage.getItem('claims')||'[]')}catch(_){return []} },
    setClaims: function(arr){ localStorage.setItem('claims', JSON.stringify(arr)); },
    fmt: function(ts){ try{return new Date(ts).toLocaleString('lt-LT')}catch(_){return ts} },
    icon: function(name){
      const n=(name||'').toLowerCase();
      if(/\.(jpg|jpeg|png|webp|gif)$/.test(n)) return 'üñºÔ∏è';
      if(/\.(mp4|webm|mov)$/.test(n)) return 'üé•';
      if(/\.(pdf)$/.test(n)) return 'üìÑ';
      return 'üìé';
    },
    legacyToNew: function(m){
      if(m && m.from && m.to) return m;
      if(!m) return m;
      if(m.author==='quality') return {from:'admin', to:'user', text:m.text, files:m.attachments||[], time:m.time, id:m.id};
      if(m.author==='customer') return {from:'user', to:'admin', text:m.text, files:m.attachments||[], time:m.time, id:m.id};
      if(m.author==='master') return {from:'master', to:'admin', text:m.text, files:m.attachments||[], time:m.time, id:m.id};
      return m;
    },
    uploadFiles: async function(fileList){
      const out=[]; for(const f of fileList){ const url=URL.createObjectURL(f);
        out.push({name:f.name, url, type:(/\.(jpg|jpeg|png|webp|gif)$/i.test(f.name)?'image':/\.(mp4|webm|mov)$/i.test(f.name)?'video':/\.(pdf)$/i.test(f.name)?'pdf':'other')}); }
      return out;
    },
    renderThread: function(container, list, perspective){
      if(!list.length){ container.innerHTML='<div class="zen-muted">Nƒóra ≈æinuƒçi≈≥</div>'; return; }
      container.innerHTML = list.map(m=>{
        const side = (m.from===perspective)?'zen-right':'';
        const bubbleClass = m.from==='admin'?'zen-bubble-admin':(m.from==='user'?'zen-bubble-user':'zen-bubble-master');
        const files=(m.files||[]).map(f=>`<div><a href="${f.url}" target="_blank">${ZenChat.icon(f.name)} ${f.name}</a></div>`).join('');
        return `<div class="zen-chat-row ${side}">
          <div class="zen-chat-bubble ${bubbleClass}">
            <div class="zen-chat-meta">${m.from} ‚Üí ${m.to} ‚Ä¢ <small>${ZenChat.fmt(m.time)}</small></div>
            <div style="white-space:pre-wrap">${(m.text||'')}</div>
            ${files?`<div class="zen-chat-files">${files}</div>`:''}
          </div>
        </div>`;
      }).join('');
      container.scrollTop = container.scrollHeight;
    }
  };
})();
</script>
</head>
<body>
    <div class="container">
        <h1>Meistro u≈æduotis</h1>

        <!-- Pagrindinƒó informacija -->
        <div class="section">
            <h2>1. U≈æduoties informacija</h2>
            <div class="field"><span class="field-label">ID:</span> <span id="claim-id"></span></div>
            <div class="field"><span class="field-label">Data:</span> <span id="claim-date"></span></div>
            <div class="field"><span class="field-label">Produktas:</span> <span id="claim-product"></span></div>
            <div class="field"><span class="field-label">Apra≈°ymas:</span> <span id="claim-description"></span></div>
            <div class="field"><span class="field-label">Kliento reikalavimas:</span> <span id="claim-request"></span></div>
            <div class="field"><span class="field-label">B≈´sena:</span> <span id="claim-status"></span></div>
        </div>

        <!-- Vartotojo dokumentai -->
        <div class="section">
            <h2>2. Vartotojo prisegti dokumentai</h2>
            <div id="user-files" class="attachments-list"></div>
        </div>

        <!-- Kokybƒós skyriaus komentarai -->
        <div class="section">
            <h2>3. Kokybƒós skyriaus rekomendacijos</h2>
            <p id="quality-note">Nƒóra papildom≈≥ pastab≈≥.</p>
        </div>

        <!-- Prisegti dokumentai nuo kokybƒós -->
        <div class="section">
            <h2>4. Prisegti dokumentai nuo kokybƒós skyriaus</h2>
            <div id="quality-attachments" class="attachments-list"></div>
        </div>

        <!-- ƒÆspƒójim≈≥ konteineris -->
        <div id="alert-container"></div>


        <!-- === zen-chat: Master chat with admin === -->
        <div class="section" style="margin-top: 30px;">
            <h2>5. Susira≈°inƒójimas su administratoriumi</h2>
            <div id="zen-master-thread" class="zen-chat-thread"></div>
            <div class="zen-chat-input">
                <input id="zen-master-input" placeholder="≈Ωinutƒó adminui‚Ä¶" style="flex:1; padding:10px;">
                <input id="zen-master-files" type="file" multiple>
                <button id="zen-master-send" style="padding: 10px 15px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">
                    Si≈≥sti
                </button>
            </div>
            <div id="zen-master-files-preview" class="zen-muted" style="margin-top: 6px;"></div>
        </div>

        <div style="margin-top: 20px; text-align: center;">
            <button id="markAsResolved" onclick="markAsResolved()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
                ‚úÖ I≈°sprend≈æiau
            </button>

            <button id="sendFeedback" onclick="sendFeedbackSurvey()" style="padding: 10px 20px; background: #007BFF; color: white; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                üìù I≈°si≈≥sti apklausƒÖ
            </button>
        </div>


    </div> <!-- VIENAS teisingas .container u≈ædarymas ƒçia -->
    


    <script>
        // Klaid≈≥ rodymo funkcija
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertContainer.appendChild(alertDiv);
            alertDiv.style.display = 'block';
            
            // Automati≈°kai pa≈°alinti po 5 sekund≈æi≈≥
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // ƒÆkƒólimo indikatoriaus valdymas
        function setLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `<span class="loading"></span> Siunƒçiama...`;
            } else {
                button.disabled = false;
                button.innerHTML = `üìù I≈°si≈≥sti apklausƒÖ`;
            }
        }

        // Funkcija apklausos siuntimui
        async function sendFeedbackSurvey() {
            const urlParams = new URLSearchParams(window.location.search);
            const claimId = urlParams.get('id');
            const sendButton = document.getElementById('sendFeedback');

            if (!claimId) {
                showAlert('Nenurodytas pretenzijos ID.', 'error');
                return;
            }

            const claims = JSON.parse(localStorage.getItem('claims') || '[]');
            const claim = claims.find(c => c.id === claimId);

            if (!claim) {
                showAlert('Pretenzija nerasta.', 'error');
                return;
            }

            // Patikrinti, ar klientas turi el. pa≈°tƒÖ
            if (!claim.contact || !claim.contact.email) {
                showAlert('Klientas neturi el. pa≈°to adreso. Apklausos i≈°si≈≥sti negalima.', 'error');
                return;
            }

            const feedbackLink = `https://pretenzijos-sistema.onrender.com/feedback.html?id=${claimId}`;
            
            // Rodyti ƒØkƒólimo indikatori≈≥
            setLoading(sendButton, true);

            try {
                const response = await fetch('https://pretenzijos-sistema.onrender.com/send-feedback-survey', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: claim.contact.email,
                        claimId: claim.id,
                        feedbackLink: feedbackLink
                    })
                });

                if (!response.ok) {
                    throw new Error(`Serveris grƒÖ≈æino klaidƒÖ: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    showAlert('Apklausos nuoroda sƒókmingai i≈°si≈≥sta klientui.', 'success');
                } else {
                    throw new Error(result.error || 'Ne≈æinoma serverio klaida');
                }
            } catch (err) {
                console.error('Klaida siunƒçiant apklausƒÖ:', err);
                showAlert(`Nepavyko i≈°si≈≥sti apklausos: ${err.message}`, 'error');
            } finally {
                // Atstatyti mygtukƒÖ
                setLoading(sendButton, false);
            }
        }

        // === FUNKCIJA: Pa≈æymƒóti kaip i≈°sprƒôstƒÖ ===
        async function markAsResolved() {
            if (!confirm('Ar tikrai pa≈æymƒóti pretenzijƒÖ kaip i≈°sprƒôstƒÖ?')) return;

            const urlParams = new URLSearchParams(window.location.search);
            const claimId = urlParams.get('id');

            if (!claimId) {
                showAlert('Nenurodytas pretenzijos ID.', 'error');
                return;
            }

            const claims = JSON.parse(localStorage.getItem('claims') || '[]');
            const claim = claims.find(c => c.id === claimId);

            if (!claim) {
                showAlert('Pretenzija nerasta.', 'error');
                return;
            }

            // Atnaujink b≈´senƒÖ ir pridƒók istorijos ƒØra≈°ƒÖ
            claim.status = 'I≈°sprƒôsta';
            claim.resolvedAt = new Date().toISOString();

            // Pridƒók ƒØ veiksm≈≥ istorijƒÖ
            if (!claim.history) claim.history = [];
            claim.history.push({
                action: 'I≈°sprƒôsta',
                user: 'Meistras',
                time: claim.resolvedAt,
                note: 'Meistras pa≈æymƒójo, kad problema i≈°sprƒôsta.'
            });

            localStorage.setItem('claims', JSON.stringify(claims));

            try {
                await fetch('https://pretenzijos-sistema.onrender.com/notify-resolved', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        claimId: claim.id,
                        customerEmail: claim.contact.email,
                        customerName: claim.contact.name,
                        productName: claim.product
                    })
                });

                showAlert('‚úÖ Pretenzija pa≈æymƒóta kaip i≈°sprƒôsta. Klientas ir kokybƒós komanda informuoti.', 'success');
                document.getElementById('markAsResolved').disabled = true;
            } catch (error) {
                console.error('Klaida siunƒçiant prane≈°imƒÖ:', error);
                showAlert('‚ö†Ô∏è Pretenzija pa≈æymƒóta, bet nepavyko i≈°si≈≥sti prane≈°imo.', 'error');
            }
        }

        // Puslapio u≈ækrovimo logika
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const claimId = urlParams.get('id');

            if (!claimId) {
                showAlert('Nenurodytas pretenzijos ID.', 'error');
                return;
            }

            const claims = JSON.parse(localStorage.getItem('claims') || '[]');
            const claim = claims.find(c => c.id === claimId);

            if (!claim) {
                showAlert('Pretenzija nerasta.', 'error');
                return;
            }

            // U≈æpildyk pagrindinƒô informacijƒÖ
            document.getElementById('claim-id').textContent = claim.id;
            document.getElementById('claim-date').textContent = new Date(claim.date).toLocaleString('lt-LT');
            document.getElementById('claim-product').textContent = claim.product;
            document.getElementById('claim-description').textContent = claim.description;
            document.getElementById('claim-request').textContent = claim.request;
            document.getElementById('claim-status').textContent = claim.status;

            // Kokybƒós komentaras
            document.getElementById('quality-note').textContent = claim.qualityExternalComment || 'Nƒóra papildom≈≥ pastab≈≥.';

            // Vartotojo dokumentai
            const userFilesContainer = document.getElementById('user-files');
            if (claim.files && claim.files.length > 0) {
                claim.files.forEach(url => {
                    const item = document.createElement('div');
                    item.className = 'file-item';

                    if (url.match(/\.(jpg|jpeg|png|webp|gif)$/i)) {
                        item.innerHTML = `<img src="${url}" alt="Nuotrauka" style="max-width:300px; border-radius:8px;">`;
                    } else if (url.match(/\.(mp4|webm|ogg)$/i)) {
                        item.innerHTML = `<video controls style="max-width:300px;"><source src="${url}" type="video/mp4">J≈´s≈≥ nar≈°yklƒó nepalaiko video.</video>`;
                    } else if (url.match(/\.(pdf)$/i)) {
                        item.innerHTML = `<a href="${url}" target="_blank" style="color:#d44646;">üìÑ Atidaryti PDF</a>`;
                    } else {
                        item.innerHTML = `<a href="${url}" target="_blank">üìé Atsisi≈≥sti dokumentƒÖ</a>`;
                    }

                    userFilesContainer.appendChild(item);
                });
            } else {
                userFilesContainer.innerHTML = '<p>Nƒóra prisegt≈≥ dokument≈≥.</p>';
            }

            // Kokybƒós skyriaus dokumentai
            const qualityAttachmentsContainer = document.getElementById('quality-attachments');
            if (claim.qualityAttachments && claim.qualityAttachments.length > 0) {
                claim.qualityAttachments.forEach(att => {
                    const item = document.createElement('div');
                    item.className = 'file-item';

                    if (att.type === 'file' && att.url.match(/\.(jpg|jpeg|png|webp)$/i)) {
                        item.innerHTML = `<img src="${att.url}" alt="${att.name}" style="max-width:300px; border-radius:8px;">`;
                    } else if (att.type === 'file' && att.url.match(/\.(mp4|webm)$/i)) {
                        item.innerHTML = `<video controls style="max-width:300px;"><source src="${att.url}" type="video/mp4">J≈´s≈≥ nar≈°yklƒó nepalaiko video.</video>`;
                    } else if (att.type === 'file' && att.url.match(/\.(pdf)$/i)) {
                        item.innerHTML = `<a href="${att.url}" target="_blank" style="color:#d44646;">üìÑ ${att.name}</a>`;
                    } else if (att.type === 'video') {
                        item.innerHTML = `<a href="${att.url}" target="_blank" style="color:#17a2b8;">üé¨ ${att.name}</a>`;
                    } else if (att.type === 'link') {
                        item.innerHTML = `<a href="${att.url}" target="_blank" style="color:#17a2b8;">üîó ${att.name}</a>`;
                    } else {
                        item.innerHTML = `<a href="${att.url}" target="_blank">üìé ${att.name}</a>`;
                    }

                    qualityAttachmentsContainer.appendChild(item);
                });
            } else {
                qualityAttachmentsContainer.innerHTML = '<p>Nƒóra papildom≈≥ dokument≈≥.</p>';
            }
        });
    </script>

 
    <footer style="text-align: center; margin-top: 40px; color: var(--gray); font-size: 12px; padding: 20px; border-top: 1px solid #eee;">
        ¬© 2025 Rubineta. Visos teisƒós saugomos. | 
        <a href="mailto:hello@rubineta.com" style="color: #17a2b8; text-decoration: none;">hello@rubineta.com</a>
    </footer>

    <script>
        // === zen-chat: Master page wiring ===
        (function(){
          const params = new URLSearchParams(location.search);
          const id = params.get('id');
          let claims = ZenChat.getClaims();
          let claim = claims.find(c => c.id === id) || claims[0];
          if (!claim) return;

          if (Array.isArray(claim.messages)) {
              claim.messages = claim.messages.map(ZenChat.legacyToNew);
              ZenChat.setClaims(claims);
          }

          const thread = document.getElementById('zen-master-thread');
          const input = document.getElementById('zen-master-input');
          const files = document.getElementById('zen-master-files');
          const preview = document.getElementById('zen-master-files-preview');

          function draw() {
              const fresh = ZenChat.getClaims().find(x => x.id === claim.id);
              if (!fresh) return;
              claim = fresh;
              const msgs = (claim.messages || []).filter(m => 
                  (m.from === 'master' && m.to === 'admin') || 
                  (m.from === 'admin' && m.to === 'master')
              );
              ZenChat.renderThread(thread, msgs, 'master');
          }

          files.addEventListener('change', () => {
              preview.textContent = [...files.files].map(f => f.name).join(', ');
          });

          document.getElementById('zen-master-send').addEventListener('click', async () => {
              const text = (input.value || '').trim();
              const uploaded = await ZenChat.uploadFiles(files.files);
              if (!text && uploaded.length === 0) return;

              const all = ZenChat.getClaims();
              const c = all.find(x => x.id === claim.id);
              if (!c) return;

              if (!Array.isArray(c.messages)) c.messages = [];
              
              c.messages.push({ 
                  id: 'msg_' + Math.random().toString(36).slice(2), 
                  from: 'master', 
                  to: 'admin', 
                  text, 
                  files: uploaded, 
                  time: new Date().toISOString() 
              });

              ZenChat.setClaims(all);
              input.value = '';
              files.value = '';
              preview.textContent = '';
              draw();
          });

          draw();
        })();
    </script>
</body>
</html>
