<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Meistro uÅ¾duotys</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#1f2937; --muted:#6b7280;
    --bg:#f6f7f9; --card:#ffffff; --line:#e5e7eb;
    --primary:#111111; --accent:#ffcc00; --accent-ink:#111111;
    --ok:#16a34a; --warn:#f59e0b; --info:#0ea5e9;
    --radius:14px; --shadow:0 4px 14px rgba(17,24,39,.06);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Roboto',sans-serif;background:var(--bg);color:var(--ink);line-height:1.45}
  header{position:sticky;top:0;z-index:10;background:var(--card);box-shadow:0 2px 10px rgba(0,0,0,.06)}
  .bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
  .brand{display:flex;align-items:center;gap:10px}
  .avatar{width:28px;height:28px;border-radius:8px;background:#111}
  .brand .t{font-weight:700}
  .btn{border:none;border-radius:12px;padding:10px 12px;font-weight:600;cursor:pointer}
  .btn-ghost{background:#fff;border:1px solid var(--line);color:var(--ink)}
  .btn-accent{background:var(--accent);color:var(--accent-ink)}
  .btn-dark{background:#0f172a;color:#fff}
  .btn-ok{background:var(--ok);color:#fff}
  .btn-warn{background:#fff5e6;border:1px solid #ffd69b}
  main{padding:12px}

  .search{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
  .search input{border:none;outline:none;flex:1;font-size:14px}
  .tabs{display:flex;gap:8px;overflow:auto;padding:10px 0}
  .tab{border:2px solid #0001;background:#fff;border-radius:999px;padding:8px 12px;font-weight:600;white-space:nowrap}
  .tab.active{border-color:#111;color:#111}
  .cnt{margin-left:6px;font-weight:700}

  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:12px 0}
  .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;background:#f3f4f6}
  .pill.ok{background:#e9f9ef;border-color:#bce8c8}
  .pill.warn{background:#fff5e6;border-color:#ffd69b}
  .pill.info{background:#e8f5fe;border-color:#bfe3ff}
  .meta{font-size:12px;color:var(--muted)}
  .title{font-weight:700;margin:8px 0}
  .line{font-size:13px;margin:4px 0}
  .tiny-actions{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .tiny-actions .btn{padding:6px 10px;border-radius:10px;font-size:13px}
  .cta{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:10px}
  .cta .btn{padding:12px 10px;border-radius:12px}

  .section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px}
  .section h3{font-size:16px;margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .section h3::before{content:"";width:6px;height:6px;background:#111;border-radius:50%}
  .grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .file{border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff;position:relative}
  .file img,.file video{max-width:100%;border-radius:6px}
  .file .del{position:absolute;top:6px;right:6px;border:1px solid var(--line);background:#fff;border-radius:8px;padding:4px 8px;font-size:12px;cursor:pointer}

  #dropzone{border:2px dashed #cbd5e1;border-radius:12px;padding:16px;text-align:center;cursor:pointer}
  .cam-wrap{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fafafa;margin-top:10px}
  .cam-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .cam-video{width:100%;border-radius:10px;background:#000;max-height:280px}
  .annotate-bar{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}

  .stat-box{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;font-size:13px}
  .checklist-item{display:flex;align-items:center;gap:8px;margin:6px 0}
  .checklist-item input[type="text"]{flex:1;padding:8px;border:1px solid var(--line);border-radius:8px}
  canvas.sig{width:100%;height:140px;border:1px dashed var(--line);border-radius:10px;background:#fff;touch-action:none}
  
  /* Nauji stiliai paraÅ¡o aktyvavimui */
  .sig-container { position: relative; }
  .sig-overlay { 
    position:absolute; 
    top:0; 
    left:0; 
    right:0; 
    bottom:0; 
    background:rgba(255,255,255,0.9); 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    border-radius:10px;
    flex-direction:column;
    gap:10px;
  }
  .sig-disabled { 
    pointer-events:none; 
    opacity:0.7; 
  }

  .offline{position:sticky;top:0;z-index:20;margin:-12px -12px 12px -12px;padding:8px 12px;background:#fff3cd;border-bottom:1px solid #facc15;font-size:13px}

  /* spausdinimas: tik detalÄ—s ataskaitai */
  @media print{
    header, .search, .tabs, .cta, .tiny-actions, #dropzone, .cam-wrap, #sigSave, #sigClear, #scanBtn, #serialSave, .offline { display:none !important; }
    body { background:#fff; }
    .section { box-shadow:none; border:none; }
  }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <div class="avatar"></div>
      <div class="t">Meistro uÅ¾duotys</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" id="shareBtn" title="Dalintis nuoroda">Dalintis</button>
      <button class="btn btn-ghost" id="logoutBtn">Atsijungti</button>
    </div>
  </div>
</header>

<main id="app"></main>

<script>
/* ========= local data + helpers ========= */
const getClaims = () => { try{return JSON.parse(localStorage.getItem('claims')||'[]')}catch(_){return []} };
const setClaims = (v) => localStorage.setItem('claims', JSON.stringify(v));
const fmt = (ts) => { try{return new Date(ts).toLocaleString('lt-LT')}catch(_){return ts} };
const byId = (arr,id)=> arr.findIndex(x=>x.id===id);

const app = document.getElementById('app');
const params = new URLSearchParams(location.search);
const claimId = params.get('id');

window.addEventListener('online', drawOffline);
window.addEventListener('offline', drawOffline);
function drawOffline(){
  const old = document.querySelector('.offline');
  if (old) old.remove();
  if (!navigator.onLine){
    const bar = document.createElement('div');
    bar.className = 'offline';
    bar.textContent = 'Offline reÅ¾imas: pakeitimai bus saugoti Ä¯renginyje.';
    app.prepend(bar);
  }
}

/* ========= MIGRACIJA (atsparumas skirtingoms struktÅ«roms) ========= */
function migrate(){
  const cs = getClaims();
  let changed=false;
  cs.forEach(c=>{
    c.history = Array.isArray(c.history) ? c.history : [];
    c.parts = Array.isArray(c.parts) ? c.parts : [];
    if (Array.isArray(c.files)) {
      // normalizuojam vartotojo failus (string -> object)
      c.files = c.files.map(item=>{
        if (typeof item==='string'){
          const url=item; const name=url.split('/').pop()||'failas';
          const type = /\.(jpg|jpeg|png|webp|gif)$/i.test(url) ? 'image'
                    : /\.(mp4|webm|mov)$/i.test(url) ? 'video'
                    : /\.(pdf)$/i.test(url) ? 'pdf' : 'file';
          return {name, url, type};
        }
        return item;
      });
      changed = true;
    }
  });
  if (changed) setClaims(cs);
}
migrate();

/* ========= Router ========= */
if (claimId) renderDetail(claimId); else renderList();

/* =================== LIST =================== */
function renderList(){
  let claims = getClaims();
  app.innerHTML = `
    <div class="search">
      <div>ğŸ”</div><input id="q" placeholder="IeÅ¡koti uÅ¾duoÄiÅ³ (ID, produktas, adresas, klientas)â€¦" />
    </div>
    <div class="tabs" id="tabs">
      <button class="tab active" data-filter="atviros">Atviros <span class="cnt" id="c-atv">0</span></button>
      <button class="tab" data-filter="vykdomos">Vykdomos <span class="cnt" id="c-vyk">0</span></button>
      <button class="tab" data-filter="dalys">Laukia daliÅ³ <span class="cnt" id="c-dal">0</span></button>
      <button class="tab" data-filter="uzbaigtos">UÅ¾baigtos <span class="cnt" id="c-uzb">0</span></button>
      <button class="tab" data-filter="visos">Visos <span class="cnt" id="c-vis">0</span></button>
    </div>
    <div id="list"></div>
  `;
  drawOffline();

  const q = document.getElementById('q');
  const tabs = document.getElementById('tabs');
  const list = document.getElementById('list');
  let filter = 'atviros';

  function counters(){
    const c = {atv:0,vyk:0,dal:0,uzb:0,vis:claims.length};
    claims.forEach(x=>{
      if(x.status==='UÅ¾baigta') c.uzb++;
      else if(x.status==='Vykdoma') c.vyk++;
      else if(x.status==='Laukia daliÅ³') c.dal++;
      else c.atv++;
    });
    document.getElementById('c-atv').textContent=c.atv;
    document.getElementById('c-vyk').textContent=c.vyk;
    document.getElementById('c-dal').textContent=c.dal;
    document.getElementById('c-uzb').textContent=c.uzb;
    document.getElementById('c-vis').textContent=c.vis;
  }

  function card(c){
    const addr = [c?.contact?.street, c?.contact?.city].filter(Boolean).join(', ');
    const phone = c?.contact?.phone || '';
    const tel = phone? `tel:${phone.replace(/\s+/g,'')}` : 'javascript:void(0)';
    const sms = phone? `sms:${phone.replace(/\s+/g,'')}?body=${encodeURIComponent('Sveiki, vykstu dÄ—l garantinioâ€¦ / Rubineta')}` : 'javascript:void(0)';
    const mapsQ = encodeURIComponent(addr || (c?.contact?.street||'')); 
    const nav = (/(Android|iPhone|iPad)/i.test(navigator.userAgent))
      ? `geo:0,0?q=${mapsQ}` : `https://www.google.com/maps/search/?api=1&query=${mapsQ}`;
    const pillCls = c.status==='UÅ¾baigta'?'pill ok': c.status==='Laukia daliÅ³'?'pill warn': c.status==='Vykdoma'?'pill info':'pill';

    return `
    <div class="card">
      <div class="head">
        <div class="${pillCls}">${c.status||'Nauja'}</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost" onclick="location.href='master-mobile.html?id=${c.id}'">PerÅ¾iÅ«rÄ—ti</button>
          <button class="btn btn-ghost" onclick="navigator.share?navigator.share({title:'UÅ¾duotis #${c.id}',url:location.origin+location.pathname+'?id=${c.id}' }):copyLink('${c.id}')">Dalintis</button>
        </div>
      </div>
      <div class="meta">#${c.id} â€¢ ${new Date(c.date).toLocaleDateString('lt-LT')}</div>
      <div class="title">${c.description || 'UÅ¾duotis'}</div>
      <div class="line"><b>Produktas:</b> ${c.product || '-'}</div>
      <div class="line">${addr ? addr + ' â€¢ ' : ''}<b>Klientas:</b> ${c?.contact?.name||''} ${c?.contact?.surname||''}</div>

      <div class="tiny-actions">
        <a class="btn btn-ghost" href="${tel}">ğŸ“ Skambinti</a>
        <a class="btn btn-ghost" href="${nav}" target="_blank">ğŸ§­ MarÅ¡rutas</a>
        <a class="btn btn-ghost" href="${sms}">ğŸ’¬ Priminti</a>
      </div>

      <div class="cta">
        <button class="btn btn-accent" onclick="setStatus('${c.id}','Vykdoma')">PradÄ—ti</button>
        <button class="btn btn-dark" onclick="markParts('${c.id}')">Dalys</button>
        <button class="btn btn-ok" onclick="setStatus('${c.id}','UÅ¾baigta')">UÅ¾baigti</button>
      </div>
    </div>`;
  }

  function apply(){
    const term = (q.value||'').toLowerCase().trim();
    const filtered = claims.filter(c=>{
      if (filter==='vykdomos' && c.status!=='Vykdoma') return false;
      if (filter==='dalys' && c.status!=='Laukia daliÅ³') return false;
      if (filter==='uzbaigtos' && c.status!=='UÅ¾baigta') return false;
      if (filter==='atviros' && (c.status==='UÅ¾baigta')) return false;
      const hay = [c.id,c.product,c.description,c?.contact?.street,c?.contact?.city,c?.contact?.name,c?.contact?.surname].join(' ').toLowerCase();
      return hay.includes(term);
    });
    list.innerHTML = filtered.map(card).join('') || `<div class="meta" style="padding:8px 2px">Nieko nerasta.</div>`;
    counters();
  }

  tabs.addEventListener('click', (e)=>{
    if(!e.target.classList.contains('tab')) return;
    [...tabs.children].forEach(t=>t.classList.remove('active'));
    e.target.classList.add('active');
    filter = e.target.dataset.filter;
    apply();
  });
  q.addEventListener('input', apply);

  window.setStatus = function(id, status){
    const all = getClaims();
    const i = byId(all,id);
    if (i>-1){
      all[i].status = status;
      all[i].history = all[i].history || [];
      all[i].history.push({ user:'Meistras', time:new Date().toISOString(), action:`BÅ«sena: ${status}` });
      if (status==='Laukia daliÅ³' && !all[i].parts?.length) {
        // jei nÄ—ra daliÅ³ â€“ pridÄ—ti tuÅ¡ÄiÄ… eilutÄ™, kad meistras nepamirÅ¡tÅ³
        all[i].parts = [{ id:'p_'+Date.now(), text:'(Ä¯raÅ¡ykite dalis)', done:false }];
      }
      setClaims(all);
      claims = all;
      apply();
    }
  }
  window.markParts = function(id){
    const all = getClaims();
    const i = byId(all,id);
    if (i>-1){
      all[i].status = 'Laukia daliÅ³';
      all[i].history = all[i].history || [];
      const note = prompt('KokiÅ³ daliÅ³ reikia / komentaras?','');
      if (note) {
        all[i].parts = (all[i].parts||[]).concat([{id:'p_'+Date.now(), text:note, done:false}]);
        all[i].history.push({user:'Meistras', time:new Date().toISOString(), action:'PaÅ¾ymÄ—ta: Laukia daliÅ³ ('+note+')'});
      } else {
        all[i].history.push({user:'Meistras', time:new Date().toISOString(), action:'PaÅ¾ymÄ—ta: Laukia daliÅ³'});
      }
      setClaims(all); claims=all; apply();
    }
  }

  apply();
}

/* =================== DETAIL =================== */
function renderDetail(id){
  let claims = getClaims();
  let claim = claims.find(c=>c.id===id);
  if(!claim){ app.innerHTML='<div class="card">Pretenzija nerasta.</div>'; return; }

  app.innerHTML = `
    <div class="section" style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
      <div style="flex:1">
        <h3>Informacija</h3>
        <div class="meta"><span class="pill">#${claim.id}</span> <span class="pill">${claim.status||'Nauja'}</span></div>
        <div class="line"><b>Data:</b> ${fmt(claim.date)}</div>
        <div class="line"><b>Produktas:</b> ${claim.product||''}</div>
        <div class="line"><b>ApraÅ¡ymas:</b> ${claim.description||''}</div>
        <div class="line"><b>Adresas:</b> ${[claim?.contact?.street, claim?.contact?.city, claim?.contact?.postal].filter(Boolean).join(', ')}</div>
        <div class="line"><b>Kontaktas:</b> ${claim?.contact?.name||''} ${claim?.contact?.surname||''} â€¢ ${claim?.contact?.phone||''}</div>

        <div class="stat-box" style="margin-top:8px">
          <button id="timerStart" class="btn btn-accent">â–¶ PradÄ—ti laikÄ…</button>
          <button id="timerStop"  class="btn btn-ghost" disabled>â¹ Sustabdyti</button>
          <span class="chip">TrukmÄ—: <span id="timerOut">00:00:00</span></span>
          <button id="printBtn" class="btn btn-ghost">ğŸ§¾ PDF</button>
          <button id="backBtn" class="btn btn-ghost">â—€ Atgal</button>
        </div>

        <div class="stat-box">
          <a class="btn btn-ghost" id="btnCall">ğŸ“ Skambinti</a>
          <a class="btn btn-ghost" id="btnSms">ğŸ’¬ SMS</a>
          <a class="btn btn-ghost" id="btnSms2">ğŸ’¬ SMS: vÄ—luosiu</a>
          <a class="btn btn-ghost" id="btnNav" target="_blank">ğŸ§­ Naviguoti</a>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Kliento failai</h3>
      <div id="user-files" class="grid2"></div>
    </div>

    <div class="section">
      <h3>KokybÄ—s dokumentai</h3>
      <div id="quality-attachments" class="grid2"></div>
    </div>

    <div class="section">
      <h3>KokybÄ—s rekomendacijos</h3>
      <div id="quality-note" class="meta"></div>
    </div>

    <div class="section">
      <h3>DaliÅ³ sÄ…raÅ¡as (checklist)</h3>
      <div id="parts"></div>
      <div style="display:flex;gap:8px; margin-top:8px">
        <input id="partInput" placeholder="Nauja dalisâ€¦" style="flex:1;padding:10px;border:1px solid var(--line);border-radius:10px">
        <button class="btn btn-ghost" id="addPart">PridÄ—ti</button>
      </div>
    </div>

    <div class="section">
      <h3>Foto ataskaita</h3>
      <div id="dropzone">
        Nutempkite failus arba spauskite pasirinkti
        <br><small class="meta">JPG, PNG, WEBP, MP4, PDF (iki ~10 MB; nuotraukos automatiÅ¡kai sumaÅ¾inamos)</small>
        <input id="file-input" type="file" multiple style="display:none" accept=".jpg,.jpeg,.png,.webp,.mp4,.pdf" capture="environment">
      </div>
      <div id="selected-files" class="meta" style="margin-top:8px"></div>

      <div class="cam-wrap">
        <div class="cam-row" style="margin-bottom:8px">
          <button type="button" id="camStart" class="btn btn-accent">ğŸ“· Kamera</button>
          <button type="button" id="camShot"  class="btn btn-ghost" disabled>ğŸ“¸ Nufotografuoti</button>
          <button type="button" id="camStop"   class="btn btn-ghost" disabled>â¹ Sustabdyti</button>
        </div>
        <video id="camVideo" class="cam-video" playsinline muted></video>
        <canvas id="camCanvas" style="display:none"></canvas>

        <div class="annotate-bar">
          <button class="btn btn-ghost" id="annStart" disabled>âœï¸ Anotuoti paskutinÄ™</button>
          <button class="btn btn-ghost" id="annSave"  disabled>ğŸ’¾ IÅ¡saugoti anotacijÄ…</button>
        </div>
        <canvas id="annCanvas" class="sig" style="display:none;height:220px"></canvas>
      </div>

      <div style="margin-top:12px;text-align:right">
        <button id="save-report" class="btn btn-dark">IÅ¡saugoti ataskaitÄ…</button>
      </div>

      <hr style="margin:14px 0">
      <h4 style="margin-bottom:8px">Jau Ä¯kelta</h4>
      <div id="report-gallery" class="grid2"></div>
    </div>

    <div class="section">
      <h3>Kliento paraÅ¡as</h3>
      <div class="sig-container">
        <canvas id="sig" class="sig sig-disabled"></canvas>
        <div id="sigOverlay" class="sig-overlay">
          <button class="btn btn-accent" id="sigActivate">Aktyvuoti paraÅ¡o laukÄ…</button>
          <div class="meta">Spustelkite Äia, kad pradÄ—tumÄ—te raÅ¡yti paraÅ¡Ä…</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-ghost" id="sigUndo" disabled>AtÅ¡aukti brÅ«kÅ¡nÄ¯</button>
        <button class="btn btn-ghost" id="sigClear" disabled>IÅ¡valyti</button>
        <button class="btn btn-ok" id="sigSave" disabled>PridÄ—ti prie ataskaitos</button>
      </div>
    </div>
    
    <div class="section">
      <h3>Darbo uÅ¾baigimas</h3>
      <div class="stat-box">
        <span class="chip" id="completeReq">Reikia: â‰¥1 nuotraukos ir paraÅ¡o</span>
        <button class="btn btn-ok" id="completeBtn" disabled>âœ… PaÅ¾ymÄ—ti kaip atliktÄ…</button>
      </div>
    </div>

    <div class="section">
      <h3>Serijos/QR skenavimas</h3>
      <div class="stat-box">
        <button class="btn btn-ghost" id="scanBtn">ğŸ“· Skenuoti</button>
        <input id="serialInput" placeholder="Arba Ä¯raÅ¡ykite kodÄ… ranka" style="flex:1;padding:10px;border:1px solid var(--line);border-radius:10px">
        <button class="btn btn-ghost" id="serialSave">IÅ¡saugoti</button>
      </div>
      <div id="serialOut" class="meta" style="margin-top:6px"></div>
    </div>

    <!-- ISTORIJA DABAR PASKUTINÄ– -->
    <div class="section">
      <h3>Istorija</h3>
      <div id="historyBox" class="meta"></div>
    </div>
  `;

  drawOffline();

  /* quick actions */
  const phone = claim?.contact?.phone || '';
  const addr  = [claim?.contact?.street, claim?.contact?.city, claim?.contact?.postal].filter(Boolean).join(', ');
  if (phone){
    document.getElementById('btnCall').href = `tel:${phone.replace(/\s+/g,'')}`;
    const base = phone.replace(/\s+/g,'');
    document.getElementById('btnSms').href  = `sms:${base}?body=${encodeURIComponent('Sveiki, atvykstu per ~30 min. / Rubineta')}`;
    document.getElementById('btnSms2').href = `sms:${base}?body=${encodeURIComponent('Sveiki, vÄ—luosiu ~15â€“20 min. AtsipraÅ¡au.')}`;
  }
  const mapsQ = encodeURIComponent(addr || (claim?.contact?.street||''));  
  document.getElementById('btnNav').href = (/(Android|iPhone|iPad)/i.test(navigator.userAgent))
    ? `geo:0,0?q=${mapsQ}` : `https://www.google.com/maps/search/?api=1&query=${mapsQ}`;

  // share/back/print
  document.getElementById('backBtn').onclick = ()=> history.length>1 ? history.back() : (location.href='master-mobile.html');
  document.getElementById('printBtn').onclick = ()=> window.print();
  document.getElementById('shareBtn')?.addEventListener('click', ()=> copyLink(claim.id));

  /* history */
  function drawHistory(){
    const box = document.getElementById('historyBox');
    const arr = (claim.history||[]).slice().reverse();
    box.innerHTML = arr.length? arr.map(h=>`${new Date(h.time).toLocaleString('lt-LT')} â€¢ ${h.user}: ${h.action}`).join('<br>') : 'NÄ—ra Ä¯raÅ¡Å³.';
  }
  drawHistory();

  /* parts checklist */
  claim.parts = Array.isArray(claim.parts) ? claim.parts : [];
  const partsEl = document.getElementById('parts');
  const partInput = document.getElementById('partInput');
  document.getElementById('addPart').onclick = () => {
    const t = partInput.value.trim(); if(!t) return;
    claim.parts.push({ id: 'p_'+Date.now(), text: t, done: false });
    saveClaim(); partInput.value=''; drawParts();
    addHistory('PridÄ—ta dalis: '+t); drawHistory();
  };
  function drawParts(){
    partsEl.innerHTML='';
    if(!claim.parts.length){ partsEl.innerHTML = '<div class="meta">NÄ—ra Ä¯raÅ¡Å³.</div>'; return; }
    claim.parts.forEach(p=>{
      const row = document.createElement('div');
      row.className = 'checklist-item';
      row.innerHTML = `
        <input type="checkbox" ${p.done?'checked':''}>
        <input type="text" value="${p.text.replace(/"/g,'&quot;')}">
        <button class="btn btn-ghost">âœ–</button>
      `;
      const [cb,txt,del]=row.children;
      cb.onchange = ()=>{ p.done=cb.checked; saveClaim(); };
      txt.onchange = ()=>{ p.text=txt.value; saveClaim(); };
      del.onclick = ()=>{ claim.parts = claim.parts.filter(x=>x.id!==p.id); saveClaim(); drawParts(); };
      partsEl.appendChild(row);
    });
  }
  drawParts();

  /* timer (persist across refresh if norÄ—tum â€“ galima raÅ¡yti Ä¯ claim.timerStart) */
  let tStart = null, tTick=null;
  const tOut = document.getElementById('timerOut');
  const tStartBtn = document.getElementById('timerStart');
  const tStopBtn  = document.getElementById('timerStop');
  tStartBtn.onclick = ()=>{
    if (tStart) return;
    tStart = Date.now();
    tStartBtn.disabled = true; tStopBtn.disabled=false;
    tick();
  };
  tStopBtn.onclick = ()=>{
    if (!tStart) return;
    const dur = Date.now()-tStart;
    addHistory(`Darbo laikas: ${fmtDur(dur)}`); drawHistory();
    tStart=null; clearInterval(tTick);
    tOut.textContent='00:00:00';
    tStartBtn.disabled=false; tStopBtn.disabled=true;
  };
  function tick(){ tTick=setInterval(()=>{ tOut.textContent = fmtDur(Date.now()-tStart); }, 500); }
  function fmtDur(ms){
    const s=Math.floor(ms/1000), h=String(Math.floor(s/3600)).padStart(2,'0'),
          m=String(Math.floor((s%3600)/60)).padStart(2,'0'), ss=String(s%60).padStart(2,'0');
    return `${h}:${m}:${ss}`;
  }

  /* files: user & quality */
  renderFilesArray(document.getElementById('user-files'), normalizeUserFiles(claim.files));
  renderFilesArray(document.getElementById('quality-attachments'), normalizeQualityFiles(claim.qualityAttachments));
  document.getElementById('quality-note').textContent =
    (claim.qualityExternalComment || claim.qualityAdvice || 'NÄ—ra rekomendacijÅ³.');

  /* photo report + camera + annotate */
  const dz = document.getElementById('dropzone');
  const input = document.getElementById('file-input');
  const list  = document.getElementById('selected-files');
  const gallery = document.getElementById('report-gallery');
  const MAX_MB = 10;
  const ACCEPT = /\.(jpg|jpeg|png|webp|mp4|pdf)$/i;

  dz.addEventListener('click', ()=> input.click());
  dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.style.background='#f8fafc'; });
  dz.addEventListener('dragleave', ()=> dz.style.background='transparent');
  dz.addEventListener('drop', e=>{ e.preventDefault(); dz.style.background='transparent'; handleFiles(e.dataTransfer.files); });
  input.addEventListener('change', ()=> handleFiles(input.files));

  let pendingFiles=[]; let pendingCamImages=[]; let lastCaptured=null;

  async function compressImage(file, maxW=1600, maxH=1600, quality=0.85){
    const img = new Image();
    const buf = await file.arrayBuffer();
    const blobUrl = URL.createObjectURL(new Blob([buf], {type:file.type||'image/jpeg'}));
    await new Promise((res,reject)=>{ img.onload=()=>res(); img.onerror=reject; img.src=blobUrl; });
    let {width:w, height:h} = img;
    const ratio = Math.min(maxW/w, maxH/h, 1);
    const cw = Math.round(w*ratio), ch = Math.round(h*ratio);
    const can = document.createElement('canvas');
    const dpr = Math.min(window.devicePixelRatio||1,2);
    can.width = cw*dpr; can.height = ch*dpr;
    can.getContext('2d').scale(dpr,dpr);
    can.getContext('2d').drawImage(img,0,0,cw,ch);
    URL.revokeObjectURL(blobUrl);
    const type = (file.type && file.type.includes('png')) ? 'image/png' : 'image/jpeg';
    const dataUrl = can.toDataURL(type, quality);
    return dataUrl;
  }

  async function handleFiles(files){
    pendingFiles=[]; const notes=[];
    for (const f of [...files]){
      if(!ACCEPT.test(f.name)) { notes.push(`âŒ ${f.name} (formatas neleidÅ¾iamas)`); continue; }
      if(/\.(jpg|jpeg|png|webp)$/i.test(f.name) && f.size > MAX_MB*1024*1024){
        // pabandom sumaÅ¾inti
        try{
          const dataUrl = await compressImage(f);
          // jei vis dar per didelis dataURL â€“ atmesti
          if (dataUrl.length/1.37 > MAX_MB*1024*1024) { // apytikslis b64->bytes
            notes.push(`âŒ ${f.name} (per didelis net po maÅ¾inimo)`); continue;
          }
          pendingFiles.push({name:f.name.replace(/\.(png|jpg|jpeg|webp)$/i,'.jpg'), dataUrl, type:'image'});
          notes.push(`âœ“ ${f.name} (sumaÅ¾inta)`);
        }catch(e){
          notes.push(`âŒ ${f.name} (nepavyko sumaÅ¾inti)`); 
        }
        continue;
      }
      if (f.size>MAX_MB*1024*1024){ notes.push(`âŒ ${f.name} (> ${MAX_MB}MB)`); continue; }
      // ne vaizdas arba maÅ¾as vaizdas â€“ paverÄiam Ä¯ dataUrl
      const ok = await fileToDataUrl(f);
      pendingFiles.push(ok);
      notes.push(`âœ“ ${f.name}`);
    }
    list.textContent = notes.join(', ');
  }

  async function fileToDataUrl(file){
    const buf=await file.arrayBuffer();
    const b64=btoa(String.fromCharCode(...new Uint8Array(buf)));
    const mime=file.type||'application/octet-stream';
    const dataUrl=`data:${mime};base64,${b64}`;
    const lower=file.name.toLowerCase();
    const type=/\.(jpg|jpeg|png|webp|gif)$/.test(lower)?'image':
               /\.(mp4|webm|mov)$/.test(lower)?'video':
               /\.(pdf)$/.test(lower)?'pdf':'file';
    return {name:file.name,dataUrl,type};
  }

  function renderGallery(){
    gallery.innerHTML='';
    const arr=(claim.masterAttachments||[]).slice();
    pendingCamImages.forEach((dataUrl,i)=>arr.push({name:`kamera-${i+1}.jpg`, dataUrl, type:'image', _pending:true}));
    if(!arr.length){ gallery.innerHTML='<div class="meta">NÄ—ra pateiktÅ³ Ä¯raÅ¡Å³</div>'; return; }
    arr.forEach((att,idx)=>{
      const src=att.dataUrl||att.url;
      const el=document.createElement('div'); el.className='file';
      el.innerHTML = `
        <button class="del" data-i="${idx}" ${att._pending?'disabled title="Bus pridÄ—ta iÅ¡saugojus"':''}>ğŸ—‘</button>
        <div style="font-size:12px;margin-bottom:6px">${att.name||'failas'} ${att._pending?'<span class="pill warn">pending</span>':''}</div>
      `;
      if(att.type==='image') el.innerHTML+=`<img loading="lazy" src="${src}" style="max-width:100%;height:auto;border-radius:6px">`;
      else if(att.type==='video') el.innerHTML+=`<video controls preload="metadata" style="max-width:100%"><source src="${src}"></video>`;
      else if(att.type==='pdf') el.innerHTML+=`<a href="${src}" target="_blank">ğŸ“„ PDF</a>`;
      else el.innerHTML+=`<a href="${src}" target="_blank">ğŸ“ Failas</a>`;
      gallery.appendChild(el);
    });
    // trynimas (tik jau iÅ¡saugotÅ³)
    gallery.querySelectorAll('.del').forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.dataset.i);
        const list = (claim.masterAttachments||[]).slice();
        if (i < list.length){
          if (!confirm('PaÅ¡alinti failÄ… iÅ¡ ataskaitos?')) return;
          list.splice(i,1);
          claim.masterAttachments = list;
          saveClaim(); renderGallery();
        }
      };
    });
  }

  document.getElementById('save-report').addEventListener('click', async ()=>{
    const camAsFiles=pendingCamImages.map((dataUrl,idx)=>({name:`kamera-${Date.now()}-${idx+1}.jpg`, dataUrl, type:'image'}));
    const uploaded = pendingFiles; // jau dataUrl
    const toSave = uploaded.concat(camAsFiles);
    if(!toSave.length) return alert('Pasirinkite failus arba nufotografuokite');

    claim.masterAttachments=(claim.masterAttachments||[]).concat(toSave);
    addHistory(`Pateikta foto ataskaita (${toSave.length} fail.)`); drawHistory();
    pendingFiles=[]; list.textContent=''; pendingCamImages=[]; lastCaptured=null;
    saveClaim(); renderGallery(); toast('Ataskaita iÅ¡saugota');
  });

  renderGallery();

  // camera - PATAISYTA VERSIJA
  const camVideo=document.getElementById('camVideo');
  const camCanvas=document.getElementById('camCanvas');
  const camStart=document.getElementById('camStart');
  const camShot=document.getElementById('camShot');
  const camStop=document.getElementById('camStop');
  let camStream=null;

  camStart.addEventListener('click', async ()=>{
    try{
      // Paprastesnis kameros paleidimas
      const constraints = {
        video: {
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      };
      
      // Bandome Ä¯vairius bÅ«dus paleisti kamerÄ…
      camStream = await navigator.mediaDevices.getUserMedia(constraints)
        .catch(async () => {
          // Bandome su paprastesniais nustatymais
          return await navigator.mediaDevices.getUserMedia({ 
            video: true, 
            audio: false 
          });
        });
      
      camVideo.srcObject = camStream;
      
      camVideo.onloadedmetadata = () => {
        camVideo.play()
          .then(() => {
            camShot.disabled = false;
            camStop.disabled = false;
            camStart.disabled = true;
            toast('Kamera sÄ—kmingai paleista');
          })
          .catch(e => {
            console.error('Klaida leidÅ¾iant video:', e);
            toast('Klaida paleidÅ¾iant kamerÄ…');
          });
      };
      
      camVideo.onerror = (e) => {
        console.error('Video klaida:', e);
        toast('Kamera nepaleista');
      };
      
    } catch(e){
      console.error('Kameros klaida:', e);
      alert('Nepavyko paleisti kameros. Patikrinkite leidimus arba bandykite kitÄ… narÅ¡yklÄ™.');
    }
  });

  camShot.addEventListener('click', ()=>{
    if(!camStream || !camVideo.videoWidth) {
      toast('Pirmiausia paleiskite kamerÄ…');
      return;
    }
    
    try{
      const video = camVideo;
      const canvas = camCanvas;
      
      // Tikriname ar video turi teisingus matmenis
      if (video.videoWidth === 0 || video.videoHeight === 0) {
        toast('Kamera dar neparengta. Palaukite.');
        return;
      }
      
      // Nustatome canvas dydÄ¯
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      // NupieÅ¡iame vaizdÄ…
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Konvertuojame Ä¯ dataURL
      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      
      // Ä®raÅ¡ome Ä¯ laukianÄiÅ³ nuotraukÅ³ sÄ…raÅ¡Ä…
      pendingCamImages.push(dataUrl);
      lastCaptured = dataUrl;
      
      // Atnaujiname galerijÄ…
      renderGallery();
      document.getElementById('annStart').disabled = false;
      
      toast('Nuotrauka sÄ—kmingai padaryta! Ä®kelta: ' + pendingCamImages.length);
      
    }catch(error){
      console.error('Nuotraukos kÅ«rimo klaida:', error);
      toast('Klaida kuriant nuotraukÄ…');
    }
  });

  camStop.addEventListener('click', ()=>{
    if(camStream){ 
      camStream.getTracks().forEach(track => {
        track.stop();
      });
      camStream = null; 
    }
    camVideo.pause(); 
    camVideo.srcObject = null;
    camShot.disabled = true;
    camStop.disabled = true;
    camStart.disabled = false;
    toast('Kamera iÅ¡jungta');
  });

  // annotate last captured - FIXED CALIBRATION
  const annC = document.getElementById('annCanvas');
  const annStart = document.getElementById('annStart');
  const annSave  = document.getElementById('annSave');
  let annCtx, drawing=false, annImgWidth, annImgHeight, annScaleX, annScaleY;

  annStart.onclick = ()=>{
    if(!lastCaptured) return alert('NÄ—ra kÄ… anotuoti');
    const img = new Image();
    img.onload = ()=>{
      // ApskaiÄiuojame mastelÄ¯ kad tilptÅ³ Ä¯ ekranÄ…
      const maxWidth = annC.parentElement.clientWidth - 20;
      const scale = Math.min(maxWidth / img.width, 1);
      
      annImgWidth = img.width;
      annImgHeight = img.height;
      annScaleX = scale;
      annScaleY = scale;
      
      annC.width = img.width * scale;
      annC.height = img.height * scale;
      annC.style.display='block';
      annCtx = annC.getContext('2d');
      
      // NubraiÅ¾ome nuotraukÄ… su teisingu masteliu
      annCtx.drawImage(img, 0, 0, annC.width, annC.height);
      annCtx.lineWidth = 8; 
      annCtx.strokeStyle = '#ff3333'; 
      annCtx.lineCap='round';
      
      // Kalibruotas brÅ«kÅ¡niavimas
      annC.onpointerdown = (e)=>{
        drawing=true; 
        annCtx.beginPath(); 
        // Konvertuojame ekrano koordinates Ä¯ nuotraukos koordinates
        const x = e.offsetX / annScaleX;
        const y = e.offsetY / annScaleY;
        annCtx.moveTo(x * annScaleX, y * annScaleY);
      };
      
      annC.onpointermove = (e)=>{
        if(!drawing) return; 
        // Konvertuojame ekrano koordinates Ä¯ nuotraukos koordinates
        const x = e.offsetX / annScaleX;
        const y = e.offsetY / annScaleY;
        annCtx.lineTo(x * annScaleX, y * annScaleY); 
        annCtx.stroke();
      };
      
      window.onpointerup = ()=> drawing=false;
      annSave.disabled=false;
    };
    img.src = lastCaptured;
  };
  
  annSave.onclick = ()=>{
    // Sukuriame pilno dydÅ¾io anotuotÄ… nuotraukÄ…
    const fullCanvas = document.createElement('canvas');
    fullCanvas.width = annImgWidth;
    fullCanvas.height = annImgHeight;
    const fullCtx = fullCanvas.getContext('2d');
    
    // NubraiÅ¾ome originaliÄ… nuotraukÄ…
    const img = new Image();
    img.onload = () => {
      fullCtx.drawImage(img, 0, 0);
      
      // Perkeliame anotacijas Ä¯ pilnÄ… dydÄ¯
      fullCtx.drawImage(annC, 0, 0, annC.width, annC.height, 0, 0, fullCanvas.width, fullCanvas.height);
      
      const dataUrl = fullCanvas.toDataURL('image/png');
      const i = pendingCamImages.lastIndexOf(lastCaptured);
      if (i>-1) pendingCamImages[i] = dataUrl; 
      else pendingCamImages.push(dataUrl);
      
      lastCaptured = dataUrl;
      annC.style.display='none'; 
      annSave.disabled=true;
      renderGallery();
      toast('Anotacija iÅ¡saugota');
    };
    img.src = lastCaptured;
  };

  /* --------- Signature (smooth, undo, hi-DPI, pressure) --------- */
  const sig = document.getElementById('sig');
  const sigOverlay = document.getElementById('sigOverlay');
  const sigActivate = document.getElementById('sigActivate');
  const sctx = sig.getContext('2d', { willReadFrequently:true });

  let strokes = [];        // kiekvienas brÅ«kÅ¡nys = [points]
  let current = null;      // aktyvus brÅ«kÅ¡nys
  let sigDirty = false;    // ar kÄ… nors nupieÅ¡ta
  let sigActive = false;   // ar paraÅ¡o laukas aktyvus

  function resizeSig(){
    const r = sig.getBoundingClientRect();
    const dpr = Math.min(window.devicePixelRatio||1, 2);
    sig.width = Math.floor(r.width * dpr);
    sig.height = Math.floor(r.height * dpr);
    sctx.setTransform(1,0,0,1,0,0);
    sctx.scale(dpr, dpr);
    // balta drobÄ—
    sctx.fillStyle = '#fff';
    sctx.fillRect(0,0,r.width,r.height);
    redraw();
  }
  function redraw(){
    const r = sig.getBoundingClientRect();
    sctx.fillStyle = '#fff';
    sctx.fillRect(0,0,r.width,r.height);
    sctx.lineCap = 'round';
    sctx.lineJoin = 'round';
    strokes.forEach(drawStroke);
    if (current) drawStroke(current);
  }
  function drawStroke(st){
    if (!st || st.length<2) return;
    sctx.beginPath();
    for (let i=1;i<st.length;i++){
      const p0 = st[i-1], p1 = st[i];
      // quadratic curve tarp p0 ir p1
      const mx = (p0.x + p1.x)/2, my = (p0.y + p1.y)/2;
      sctx.strokeStyle = '#111';
      sctx.lineWidth = p1.w;
      sctx.moveTo(p0.x, p0.y);
      sctx.quadraticCurveTo(p0.x, p0.y, mx, my);
      sctx.stroke();
    }
  }

  function pt(e){
    const rect = sig.getBoundingClientRect();
    const pressure = typeof e.pressure === 'number' && e.pressure>0 ? e.pressure : 0.5;
    return {
      x: e.clientX - rect.left,
      y: e.clientY - rect.top,
      p: pressure
    };
  }
  function widthFrom(pPrev, pNow){
    // jei yra stylus slÄ—gis â€“ naudok jÄ¯; kitaip daryk â€greiÄio" kompensacijÄ…
    const base = 2.2;         // bazinis storis
    const max = 4.0;
    if (pNow.p) return Math.max(1.6, Math.min(max, base + (pNow.p*2)));
    if (!pPrev) return base;
    const dx = pNow.x - pPrev.x, dy = pNow.y - pPrev.y;
    const speed = Math.min(1, Math.hypot(dx,dy) / 6); // kuo greiÄiau â€“ tuo ploniau
    return Math.max(1.6, max - speed*2.2);
  }

  let lastDraw = 0;
  function onDown(e){
    if (!sigActive) return;
    e.preventDefault();
    sig.setPointerCapture(e.pointerId);
    const p = pt(e);
    current = [ { ...p, w: widthFrom(null,p) } ];
    sigDirty = true;
  }
  function onMove(e){
    if (!sigActive || !current) return;
    e.preventDefault();
    const now = performance.now();
    // throttle ~60fps
    if (now - lastDraw < 16) return;
    lastDraw = now;

    const p = pt(e);
    const prev = current[current.length-1];
    // atmesti labai maÅ¾us poslinkius (drebulys)
    if (Math.abs(p.x - prev.x) + Math.abs(p.y - prev.y) < 1.2) return;

    current.push({ ...p, w: widthFrom(prev,p) });
    redraw();
  }
  function onUp(e){
    if (!sigActive || !current) return;
    e.preventDefault();
    strokes.push(current);
    current = null;
    redraw();
  }

  // Aktyvavimo mygtukas
  sigActivate.addEventListener('click', () => {
    sigActive = true;
    sig.classList.remove('sig-disabled');
    sigOverlay.style.display = 'none';
    document.getElementById('sigUndo').disabled = false;
    document.getElementById('sigClear').disabled = false;
    document.getElementById('sigSave').disabled = false;
  });

  sig.addEventListener('pointerdown', onDown);
  sig.addEventListener('pointermove', onMove);
  sig.addEventListener('pointerup', onUp);
  sig.addEventListener('pointercancel', onUp);
  window.addEventListener('resize', resizeSig);
  resizeSig();

  document.getElementById('sigUndo').onclick = ()=>{
    if (!sigActive) return;
    strokes.pop(); redraw();
  };
  document.getElementById('sigClear').onclick = ()=>{
    if (!sigActive) return;
    strokes = []; current=null; sigDirty=false; redraw();
  };
  document.getElementById('sigSave').onclick = ()=>{
    if (!sigActive) return;
    if (!sigDirty || (strokes.length===0 && !current)) { alert('NupieÅ¡kite paraÅ¡Ä….'); return; }
    const img = sig.toDataURL('image/png');
    claim.masterAttachments = (claim.masterAttachments||[]).concat([{name:`parasas-${Date.now()}.png`, dataUrl:img, type:'image'}]);
    addHistory('PridÄ—tas kliento paraÅ¡as'); saveClaim();
    redraw();
    renderGallery();
    toast('ParaÅ¡as pridÄ—tas');
    updateCompleteButton();

    // Deaktyvuojame paraÅ¡o laukÄ… po iÅ¡saugojimo
    sigActive = false;
    sig.classList.add('sig-disabled');
    sigOverlay.style.display = 'flex';
    document.getElementById('sigUndo').disabled = true;
    document.getElementById('sigClear').disabled = true;
    document.getElementById('sigSave').disabled = true;
  };

  /* --------- â€Darbas atliktas" mygtukas su tikrinimais --------- */
  const completeBtn = document.getElementById('completeBtn');
  const completeReq = document.getElementById('completeReq');

  function hasSignature(){
    return (claim.masterAttachments||[]).some(a => /paras(as|a)|paraÅ¡as/i.test(a.name||'') || /data:image\/png/.test(a.dataUrl||''));
  }
  function hasAnyEvidence(){
    // bent viena iliustracija (foto/video/pdf) ataskaitoje
    return (claim.masterAttachments||[]).some(a => ['image','video','pdf'].includes(a.type));
  }

  function updateCompleteButton(){
    const ok = hasSignature() && hasAnyEvidence();
    completeBtn.disabled = !ok;
    completeReq.textContent = ok ? 'ParuoÅ¡ta uÅ¾baigti' : 'Reikia: â‰¥1 nuotraukos ir paraÅ¡o';
  }
  updateCompleteButton();

  completeBtn.addEventListener('click', ()=>{
    if (!hasSignature()) { alert('PridÄ—kite kliento paraÅ¡Ä….'); return; }
    if (!hasAnyEvidence()) { alert('PridÄ—kite bent vienÄ… nuotraukÄ… ar dokumentÄ….'); return; }

    claim.status = 'UÅ¾baigta';
    addHistory('Darbas paÅ¾ymÄ—tas kaip atliktas');
    saveClaim();
    toast('âœ… PaÅ¾ymÄ—ta: UÅ¾baigta');
    // atnaujinti galvutÄ—s statusÄ…
    const tag = document.querySelector('.section .pill'); if (tag) tag.textContent = 'UÅ¾baigta';
  });

  /* barcode / QR */
  const scanBtn = document.getElementById('scanBtn');
  const serialInput = document.getElementById('serialInput');
  const serialOut = document.getElementById('serialOut');
  let detector = null;
  try{
    if ('BarcodeDetector' in window){
      detector = new BarcodeDetector({formats:['qr_code','code_128','code_39','ean_13','ean_8','upc_e','upc_a']});
    }
  }catch(_){}
  scanBtn.onclick = async ()=>{
    if (!detector) { alert('Å iame Ä¯renginyje skenavimo API nepalaikoma â€“ Ä¯raÅ¡ykite ranka.'); return; }
    try{
      const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      const track = stream.getVideoTracks()[0];
      const imgCap = new ImageCapture(track);
      const shot = await imgCap.grabFrame();
      track.stop();
      const bmp = await createImageBitmap(shot);
      const off = document.createElement('canvas'); off.width=bmp.width; off.height=bmp.height;
      off.getContext('2d').drawImage(bmp,0,0);
      const det = await detector.detect(off);
      if (det && det[0]){
        serialInput.value = det[0].rawValue || det[0].data || '';
        serialOut.textContent = 'Nuskaityta: '+serialInput.value;
      } else {
        serialOut.textContent = 'Nieko neaptikta. Pabandykite dar kartÄ….';
      }
    }catch(e){ console.error(e); alert('Nepavyko nuskenuoti.'); }
  };
  document.getElementById('serialSave').onclick = ()=>{
    const v = serialInput.value.trim(); if(!v) return;
    claim.serial = v; addHistory('UÅ¾fiksuotas serijos/QR kodas: '+v); drawHistory(); saveClaim();
    serialOut.textContent = 'IÅ¡saugota: '+v;
  };

  /* helpers inside detail */
  async function uploadFiles(fileList){ /* nebereikia â€“ darome fileToDataUrl/kompresijÄ… */ }
  function renderFilesArray(container, list){
    container.innerHTML='';
    if(!Array.isArray(list) || !list.length){ container.innerHTML='<div class="meta">NÄ—ra Ä¯keltÅ³ failÅ³</div>'; return; }
    list.forEach(att=>{
      const src=att.dataUrl||att.url;
      const el=document.createElement('div'); el.className='file';
      const title=`<div style="font-size:12px;margin-bottom:6px">${att.name||'failas'}</div>`;
      if(att.type==='image') el.innerHTML=title+`<img loading="lazy" src="${src}" alt="">`;
      else if(att.type==='video') el.innerHTML=title+`<video controls preload="metadata"><source src="${src}"></video>`;
      else if(att.type==='pdf') el.innerHTML=title+`<a href="${src}" target="_blank">ğŸ“„ PDF</a>`;
      else el.innerHTML=title+`<a href="${src}" target="_blank">ğŸ“ AtsisiÅ³sti</a>`;
      container.appendChild(el);
    });
  }
  function normalizeUserFiles(files){ if(!Array.isArray(files)) return []; return files.map(item=> typeof item==='string'? ({name:item.split('/').pop()||'failas', url:item, type:/\.(jpg|jpeg|png|webp|gif)$/i.test(item)?'image':/\.(mp4|webm|mov)$/i.test(item)?'video':/\.(pdf)$/i.test(item)?'pdf':'file'}) : item ); }
  function normalizeQualityFiles(arr){ if(!Array.isArray(arr)) return []; return arr.map(att=>{ if(att.dataUrl && !att.url) att.url=att.dataUrl; if(!att.type){ const u=att.url||''; att.type=/\.(jpg|jpeg|png|webp|gif)$/i.test(u)?'image':/\.(mp4|webm|mov)$/i.test(u)?'video':/\.(pdf)$/i.test(u)?'pdf':'file'; } return att; }); }
  function addHistory(action){ claim.history = claim.history || []; claim.history.push({ user:'Meistras', time:new Date().toISOString(), action }); saveClaim(); }
  function saveClaim(){ const all = getClaims(); const i = byId(all, claim.id); if (i>-1){ all[i]=claim; setClaims(all); } }
}

/* share helper */
function copyLink(id){
  const url = location.origin + location.pathname + '?id=' + id;
  if (navigator.share){ navigator.share({title:'UÅ¾duotis #'+id, url}).catch(()=>{}); return; }
  navigator.clipboard?.writeText(url);
  toast('Nuoroda nukopijuota');
}

/* logout */
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('currentUser');
  alert('Atsijungta');
});

/* tiny toast */
function toast(msg){
  const t=document.createElement('div');
  t.textContent=msg;
  Object.assign(t.style,{
    position:'fixed',left:'50%',bottom:'18px',transform:'translateX(-50%)',
    background:'#111',color:'#fff',padding:'10px 14px',borderRadius:'10px',fontSize:'13px',zIndex:9999
  });
  document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 1800);
}
</script>
</body>
</html>
