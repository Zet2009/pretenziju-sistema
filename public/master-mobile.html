<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Meistro uÅ¾duotys</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>:root{--ink:#1f2937; --muted:#6b7280;--bg:#f6f7f9; --card:#ffffff; --line:#e5e7eb;--primary:#111111; --accent:#ffcc00; --accent-ink:#111111;--ok:#16a34a; --warn:#f59e0b; --info:#0ea5e9;--radius:14px; --shadow:0 4px 14px rgba(17,24,39,.06);}*{box-sizing:border-box;margin:0;padding:0}body{font-family:'Roboto',sans-serif;line-height:1.5;color:var(--ink);background:var(--bg);padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left)}main{max-width:800px;margin:0 auto;padding:12px}.section{background:var(--card);border-radius:var(--radius);padding:16px;margin-bottom:12px;box-shadow:var(--shadow)}.head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.pill{padding:4px 8px;border-radius:999px;font-size:12px;background:#f1f5f9;color:#64748b}.pill.ok{background:#dcfce7;color:#166534}.pill.warn{background:#fef3c7;color:#92400e}.pill.info{background:#e0f2fe;color:#0369a1}.btn{padding:8px 12px;border:none;border-radius:999px;font-size:14px;cursor:pointer;display:inline-flex;align-items:center;gap:6px}.btn-ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}.btn-dark{background:var(--ink);color:#fff}.btn-accent{background:var(--accent);color:var(--accent-ink)}.btn-ok{background:var(--ok);color:#fff}.meta{font-size:13px;color:var(--muted)}.line{margin:4px 0}.grid2{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px}.file{position:relative;border:1px solid var(--line);border-radius:10px;overflow:hidden}.file img,.file video{width:100%;height:auto;display:block;max-height:160px;object-fit:cover}.del{position:absolute;top:6px;right:6px;background:red;color:#fff;border:none;width:24px;height:24px;border-radius:999px;font-size:14px;opacity:0.9;z-index:2}.sig{border:1px solid var(--line);border-radius:10px;background:#fff;width:100%;height:220px;cursor:crosshair}.annotate-bar{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}.stat-box{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.chip{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#f8fafc;font-size:13px}.checklist-item{display:flex;gap:8px;align-items:center;padding:4px 0}.search{display:flex;align-items:center;gap:8px;background:#fff;padding:10px;border-radius:10px;margin-bottom:12px}.search div:first-child{color:var(--muted)}.search input{flex:1;border:none;background:transparent;font-size:14px}input::placeholder{color:var(--muted)}.tabs{display:flex;gap:8px;margin-bottom:12px;overflow-x:auto}.tab{padding:8px 12px;border-radius:10px;background:#f1f5f9;border:none;font-size:14px;white-space:nowrap}.tab.active{background:var(--primary);color:#fff}.card{background:#fff;border:1px solid var(--line);border-radius:10px;padding:12px;margin-bottom:8px}.tiny-actions{display:flex;gap:6px;margin-top:12px}.offline{background:#dc2626;color:#fff;text-align:center;padding:8px;border-radius:10px;margin-bottom:12px;font-size:14px}.brand{display:flex;align-items:center;gap:8px}.avatar{width:32px;height:32px;background:var(--accent);border-radius:999px}.t{font-weight:500}.bar{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--line);margin-bottom:12px}@media print{header, .search, .tabs, .cta, .tiny-actions, #dropzone, .cam-wrap, #sigSave, #sigClear, #scanBtn, #serialSave, .offline { display:none !important; }body { background:#fff; }.section { box-shadow:none; border:none; }}</style>
</head>
<body>

<div id="app"></div>

<script>

// --- BENDROS FUNKCIJOS ---
const app = document.getElementById('app');
const claimId = new URLSearchParams(location.search).get('id');

function toast(msg) {
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:10px;z-index:9999;';
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

function getClaims() {
  return JSON.parse(localStorage.getItem('claims') || '[]');
}

function setClaims(cs) {
  localStorage.setItem('claims', JSON.stringify(cs));
}

function saveClaim() {
  const all = getClaims();
  const i = all.findIndex(c => c.id === claim.id);
  if (i > -1) {
    all[i] = claim;
    setClaims(all);
  }
}

function addHistory(action) {
  claim.history = claim.history || [];
  claim.history.push({
    user: 'Meistras',
    time: new Date().toISOString(),
    action
  });
}

function drawOffline() {
  if (navigator.onLine) return;
  const offline = document.createElement('div');
  offline.className = 'offline';
  offline.textContent = 'âš ï¸ JÅ«s esate neprisijungÄ™s prie interneto. Duomenys saugomi lokaliniame talpykloje.';
  app.insertBefore(offline, app.firstChild);
}

function migrate() {}

// --- ROUTER ---
if (claimId) renderDetail(claimId); else renderList();

// --- LIST ---
function renderList() {
  let claims = getClaims();
  app.innerHTML = `
    <div class="search">
      <div>ğŸ”</div>
      <input id="q" placeholder="IeÅ¡koti uÅ¾duoÄiÅ³ (ID, produktas, adresas, klientas)â€¦" />
    </div>
    <div class="tabs" id="tabs">
      <button class="tab active" data-filter="atviros">Atviros <span class="cnt" id="c-atv">0</span></button>
      <button class="tab" data-filter="vykdomos">Vykdomos <span class="cnt" id="c-vyk">0</span></button>
      <button class="tab" data-filter="dalys">Laukia daliÅ³ <span class="cnt" id="c-dal">0</span></button>
      <button class="tab" data-filter="uzbaigtos">UÅ¾baigtos <span class="cnt" id="c-uzb">0</span></button>
      <button class="tab" data-filter="visos">Visos <span class="cnt" id="c-vis">0</span></button>
    </div>
    <div id="list"></div>
  `;
  drawOffline();
  const q = document.getElementById('q');
  const tabs = document.getElementById('tabs');
  const listEl = document.getElementById('list');
  let filter = 'atviros';

  function counters() {
    const c = { atv: 0, vyk: 0, dal: 0, uzb: 0, vis: claims.length };
    claims.forEach(x => {
      if (x.status === 'UÅ¾baigta') c.uzb++;
      else if (x.status === 'Vykdoma') c.vyk++;
      else if (x.status === 'Laukia daliÅ³') c.dal++;
      else c.atv++;
    });
    ['atv','vyk','dal','uzb','vis'].forEach(k => {
      const el = document.getElementById(`c-${k}`);
      if (el) el.textContent = c[k];
    });
  }

  function apply() {
    const term = (q.value || '').toLowerCase().trim();
    const filtered = claims.filter(c => {
      if (filter === 'vykdomos' && c.status !== 'Vykdoma') return false;
      if (filter === 'dalys' && c.status !== 'Laukia daliÅ³') return false;
      if (filter === 'uzbaigtos' && c.status !== 'UÅ¾baigta') return false;
      if (filter === 'atviros' && c.status === 'UÅ¾baigta') return false;
      if (!term) return true;
      const hay = [c.id, c.product, c.description, c?.contact?.street, c?.contact?.city, c?.contact?.name, c?.contact?.surname].join(' ').toLowerCase();
      return hay.includes(term);
    });
    listEl.innerHTML = filtered.map(c => {
      const addr = [c?.contact?.street, c?.contact?.city].filter(Boolean).join(', ');
      const phone = c?.contact?.phone;
      const pillCls = c.status==='UÅ¾baigta'?'pill ok': c.status==='Laukia daliÅ³'?'pill warn': c.status==='Vykdoma'?'pill info':'pill';
      return `<div class="card">
        <div class="head">
          <div><span class="${pillCls}">${c.status}</span> #${c.id}</div>
          <div>${c.date ? new Date(c.date).toLocaleDateString('lt-LT') : ''}</div>
        </div>
        <div class="line"><b>Produktas:</b> ${c.product||''}</div>
        <div class="line"><b>ApraÅ¡ymas:</b> ${c.description||''}</div>
        <div class="line"><b>Adresas:</b> ${addr||''}</div>
        <div class="line"><b>Kontaktas:</b> ${[c?.contact?.name, c?.contact?.surname, c?.contact?.phone].filter(Boolean).join(' â€¢ ')}</div>
        <div class="tiny-actions">
          <a href="?id=${c.id}" class="btn btn-dark">Redaguoti</a>
          <button class="btn btn-ghost" onclick="copyLink('${c.id}')">Kopijuoti nuorodÄ…</button>
          <button class="btn btn-dark" onclick="markParts('${c.id}')">Dalys</button>
          <button class="btn btn-ok" onclick="setStatus('${c.id}','UÅ¾baigta')">UÅ¾baigti</button>
        </div>
      </div>`;
    }).join('');
  }

  q.addEventListener('input', apply);
  tabs.addEventListener('click', e => {
    const btn = e.target.closest('.tab');
    if (!btn) return;
    document.querySelector('.tab.active').classList.remove('active');
    btn.classList.add('active');
    filter = btn.dataset.filter;
    apply();
  });

  window.markParts = (id) => {
    const all = getClaims();
    const i = all.findIndex(c => c.id === id);
    if (i === -1) return;
    all[i].status = 'Laukia daliÅ³';
    all[i].history = all[i].history || [];
    const note = prompt('KokiÅ³ daliÅ³ reikia / komentaras?','');
    if (note) {
      all[i].parts = (all[i].parts||[]).concat([{id:'p_'+Date.now(), text:note, done:false}]);
      all[i].history.push({user:'Meistras', time:new Date().toISOString(), action:'PaÅ¾ymÄ—ta: Laukia daliÅ³ ('+note+')'});
    } else {
      all[i].history.push({user:'Meistras', time:new Date().toISOString(), action:'PaÅ¾ymÄ—ta: Laukia daliÅ³'});
    }
    setClaims(all);
    claims = all;
    apply();
  };

  window.setStatus = (id, status) => {
    const all = getClaims();
    const i = all.findIndex(c => c.id === id);
    if (i === -1) return;
    all[i].status = status;
    all[i].history = all[i].history || [];
    all[i].history.push({user:'Meistras', time:new Date().toISOString(), action:`Statusas pakeistas Ä¯ "${status}"`});
    setClaims(all);
    claims = all;
    apply();
  };

  counters();
  apply();
}

// --- DETAIL ---
function renderDetail(id) {
  const claim = getClaims().find(c => c.id === id);
  if (!claim) return;

  const fmt = d => new Date(d).toLocaleString('lt-LT');

  app.innerHTML = `
    <div class="section">
      <h3>Informacija</h3>
      <div class="meta"><span class="pill">#${claim.id}</span> <span class="pill">${claim.status||'Nauja'}</span></div>
      <div class="line"><b>Data:</b> ${fmt(claim.date)}</div>
      <div class="line"><b>Produktas:</b> ${claim.product||''}</div>
      <div class="line"><b>ApraÅ¡ymas:</b> ${claim.description||''}</div>
      <div class="line"><b>Adresas:</b> ${[claim?.contact?.street, claim?.contact?.city, claim?.contact?.postal].filter(Boolean).join(', ')}</div>
      <div class="line"><b>Kontaktas:</b> ${claim?.contact?.name||''} ${claim?.contact?.surname||''} â€¢ ${claim?.contact?.phone||''}</div>

      <div class="stat-box" style="margin-top:8px">
        <button id="timerStart" class="btn btn-accent">â–¶ PradÄ—ti laikÄ…</button>
        <button id="timerStop"  class="btn btn-ghost" disabled>â¹ Sustabdyti</button>
        <span class="chip">TrukmÄ—: <span id="timerOut">00:00:00</span></span>
        <button id="printBtn" class="btn btn-ghost">ğŸ§¾ PDF</button>
        <button id="backBtn" class="btn btn-ghost">â—€ Atgal</button>
      </div>

      <div class="stat-box">
        <a class="btn btn-ghost" id="btnCall">ğŸ“ Skambinti</a>
        <a class="btn btn-ghost" id="btnSms">ğŸ’¬ SMS</a>
        <a class="btn btn-ghost" id="btnSms2">ğŸ’¬ SMS: vÄ—luosiu</a>
        <a class="btn btn-ghost" id="btnNav" target="_blank">ğŸ§­ Naviguoti</a>
      </div>
    </div>

    <div class="section">
      <h3>Kliento failai</h3>
      <div id="user-files" class="grid2"></div>
    </div>

    <div class="section">
      <h3>KokybÄ—s dokumentai</h3>
      <div id="quality-attachments" class="grid2"></div>
    </div>

    <div class="section">
      <h3>KokybÄ—s rekomendacijos</h3>
      <div id="quality-note" class="meta"></div>
    </div>

    <div class="section">
      <h3>DaliÅ³ sÄ…raÅ¡as (checklist)</h3>
      <div id="parts"></div>
      <div style="display:flex;gap:8px; margin-top:8px">
        <input id="partInput" placeholder="Nauja dalisâ€¦" style="flex:1;padding:10px;border:1px solid var(--line);border-radius:10px">
        <button class="btn btn-ghost" id="addPart">PridÄ—ti</button>
      </div>
    </div>

    <div class="section">
      <h3>Foto ataskaita</h3>
      <div id="dropzone">
        Nutempkite failus arba spauskite pasirinkti
        <br><small class="meta">JPG, PNG, WEBP, MP4, PDF (iki ~10 MB; nuotraukos automatiÅ¡kai sumaÅ¾inamos)</small>
        <input id="file-input" type="file" multiple style="display:none" accept=".jpg,.jpeg,.png,.webp,.mp4,.pdf">
      </div>
      <div id="selected-files" class="meta" style="margin-top:8px"></div>

      <!-- Anotavimo juosta -->
      <div class="annotate-bar">
        <button class="btn btn-ghost" id="annStart">âœï¸ Anotuoti paskutinÄ™</button>
        <button class="btn btn-ghost" id="annSave" disabled>ğŸ’¾ IÅ¡saugoti anotacijÄ…</button>
      </div>
      <canvas id="annCanvas" class="sig" style="display:none; max-height:80vh;"></canvas>

      <hr style="margin:14px 0">
      <h4 style="margin-bottom:8px">Jau Ä¯kelta</h4>
      <div id="report-gallery" class="grid2"></div>

      <div style="margin-top:12px;text-align:right">
        <button id="save-report" class="btn btn-dark">âœ… IÅ¡saugoti ataskaitÄ…</button>
      </div>
    </div>

    <div class="section">
      <h3>Kliento paraÅ¡as</h3>
      <canvas id="sig" class="sig"></canvas>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-ghost" id="sigUndo">AtÅ¡aukti brÅ«kÅ¡nÄ¯</button>
        <button class="btn btn-ghost" id="sigClear">IÅ¡valyti</button>
        <button class="btn btn-ok" id="sigSave">PridÄ—ti prie ataskaitos</button>
      </div>
    </div>

    <div class="section">
      <h3>Darbo uÅ¾baigimas</h3>
      <div class="stat-box">
        <span class="chip" id="completeReq">Reikia: â‰¥1 nuotraukos ir paraÅ¡o</span>
        <button class="btn btn-ok" id="completeBtn" disabled>âœ… PaÅ¾ymÄ—ti kaip atliktÄ…</button>
      </div>
    </div>

    <div class="section">
      <h3>Istorija</h3>
      <div id="historyBox" class="meta"></div>
    </div>
  `;

  // --- GALERIJA ---
  function renderGallery() {
    const gallery = document.getElementById('report-gallery');
    if (!gallery) return;
    
    const arr = [...(claim.masterAttachments || [])];
    
    // Rodyti pendingFiles
    if (Array.isArray(pendingFiles)) {
      pendingFiles.forEach(f => arr.push({ ...f, _pending: true }));
    }

    if (!arr.length) {
      gallery.innerHTML = '<div class="meta">NÄ—ra pateiktÅ³ Ä¯raÅ¡Å³</div>';
      return;
    }

    gallery.innerHTML = '';
    arr.reverse().forEach((att, idx) => {
      const src = att.dataUrl || att.url;
      const el = document.createElement('div');
      el.className = 'file';
      el.innerHTML = `<button class="del" data-i="${idx}" ${att._pending?'disabled':''}>ğŸ—‘</button>
                      <div style="font-size:12px;margin-bottom:6px">${att.name||'failas'} ${att._pending?'<span class="pill warn">pending</span>':''}</div>`;
      
      if (att.type === 'image') el.innerHTML += `<img loading="lazy" src="${src}">`;
      else if (att.type === 'video') el.innerHTML += `<video controls preload="metadata"><source src="${src}"></video>`;
      else if (att.type === 'pdf') el.innerHTML += `<a href="${src}" target="_blank">ğŸ“„ PDF</a>`;
      else el.innerHTML += `<a href="${src}" target="_blank">ğŸ“ Failas</a>`;
      
      gallery.appendChild(el);
    });

    // Trynimas
    gallery.querySelectorAll('.del').forEach(btn => {
      btn.onclick = () => {
        const i = Number(btn.dataset.i);
        const list = (claim.masterAttachments || []).slice();
        if (i < list.length) {
          if (!confirm('PaÅ¡alinti failÄ… iÅ¡ ataskaitos?')) return;
          list.splice(i, 1);
          claim.masterAttachments = list;
          saveClaim();
          renderGallery();
        }
      };
    });
  }

  // --- FAILÅ² Ä®KÄ–LIMAS ---
  const MAX_MB = 10;
  const ACCEPT = /\.(jpe?g|png|webp|mp4|pdf)$/i;
  let pendingFiles = [];

  document.getElementById('dropzone').onclick = () => {
    document.getElementById('file-input').click();
  };

  document.getElementById('file-input').onchange = async (e) => {
    const listEl = document.getElementById('selected-files');
    if (!listEl) {
      console.error('#selected-files nerastas DOMâ€™e');
      return;
    }

    const files = e.target.files;
    if (!files || !files.length) {
      listEl.textContent = 'Nepasirinkti failai';
      return;
    }

    const notes = [];
    for (const f of [...files]) {
      console.log('Apdorojamas failas:', f.name, f.size);

      try {
        if (!ACCEPT.test(f.name)) {
          notes.push(`âŒ ${f.name} (formatas neleidÅ¾iamas)`);
          continue;
        }

        if (/\.(jpg|jpeg|png|webp)$/i.test(f.name) && f.size > MAX_MB * 1024 * 1024) {
          try {
            const dataUrl = await compressImage(f);
            if (dataUrl.length / 1.37 > MAX_MB * 1024 * 1024) {
              notes.push(`âŒ ${f.name} (per didelis net po maÅ¾inimo)`);
              continue;
            }
            pendingFiles.push({
              name: f.name.replace(/\.(png|jpg|jpeg|webp)$/i, '.jpg'),
              dataUrl,
              type: 'image'
            });
            notes.push(`âœ“ ${f.name} (sumaÅ¾inta)`);
          } catch (e) {
            console.error('Klaida maÅ¾inant paveikslÄ—lÄ¯:', e);
            notes.push(`âŒ ${f.name} (nepavyko sumaÅ¾inti)`);
          }
          continue;
        }

        if (f.size > MAX_MB * 1024 * 1024) {
          notes.push(`âŒ ${f.name} (> ${MAX_MB}MB)`);
          continue;
        }

        const ok = await fileToDataUrl(f);
        pendingFiles.push(ok);
        notes.push(`âœ“ ${f.name}`);

      } catch (innerError) {
        console.error('Klaida apdorojant failÄ…:', f.name, innerError);
        notes.push(`âŒ ${f.name} (klaida)`);
      }
    }

    listEl.textContent = notes.join(', ');
    renderGallery(); // ğŸ” Svarbu!
  };

  // --- ANOTACIJA ANT PASKUTINÄ–S NUOTRAUKOS ---
  const annC = document.getElementById('annCanvas');
  const annStart = document.getElementById('annStart');
  const annSave = document.getElementById('annSave');
  let annCtx = null;

  annStart.onclick = () => {
    const attachments = claim.masterAttachments || [];
    const images = attachments.filter(a => a.type === 'image' && !/parasas/i.test(a.name));
    if (images.length === 0) {
      alert('NÄ—ra nuotraukÅ³, kurias bÅ«tÅ³ galima anotuoti.');
      return;
    }

    const lastImage = images[images.length - 1];
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => {
      annC.width = img.width;
      annC.height = img.height;
      annC.style.display = 'block';

      annCtx = annC.getContext('2d');
      annCtx.clearRect(0, 0, annC.width, annC.height);
      annCtx.drawImage(img, 0, 0);
      annCtx.lineWidth = 6;
      annCtx.strokeStyle = '#ff3333';
      annCtx.lineCap = 'round';
      annCtx.lineJoin = 'round';

      let isDrawing = false;

      annC.onpointerdown = (e) => {
        isDrawing = true;
        const rect = annC.getBoundingClientRect();
        const scaleX = img.width / rect.width;
        const scaleY = img.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        annCtx.beginPath();
        annCtx.moveTo(x, y);
      };

      annC.onpointermove = (e) => {
        if (!isDrawing) return;
        const rect = annC.getBoundingClientRect();
        const scaleX = img.width / rect.width;
        const scaleY = img.height / rect.height;
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;
        annCtx.lineTo(x, y);
        annCtx.stroke();
      };

      window.onpointerup = () => { isDrawing = false; };
      window.onblur = () => { isDrawing = false; };

      annSave.disabled = false;
    };
    img.src = lastImage.dataUrl || lastImage.url;
  };

  annSave.onclick = () => {
    if (!annCtx) return;
    const dataUrl = annC.toDataURL('image/png');

    const list = [...(claim.masterAttachments || [])];
    const images = list.filter(a => a.type === 'image' && !/parasas/i.test(a.name));
    const lastImage = images[images.length - 1];
    const index = list.indexOf(lastImage);

    if (index > -1) {
      list[index].dataUrl = dataUrl;
      claim.masterAttachments = list;
      saveClaim();
      renderGallery();
      addHistory('Anotuota nuotrauka');
      toast('Anotacija iÅ¡saugota');
    }

    annC.style.display = 'none';
    annSave.disabled = true;
    annCtx = null;
  };

  // --- IÅ SAUGOTI ATASKAITÄ„ ---
  document.getElementById('save-report').addEventListener('click', async () => {
    const toSave = [...pendingFiles];

    if (toSave.length === 0) {
      return alert('Pasirinkite failus.');
    }

    claim.masterAttachments = (claim.masterAttachments || []).concat(toSave);
    addHistory(`Pateikta foto ataskaita (${toSave.length} fail.)`);
    pendingFiles = [];
    document.getElementById('selected-files').textContent = '';
    saveClaim();
    renderGallery();
    toast('Ataskaita iÅ¡saugota');
  });

  // --- PARAÅ AS ---
  const sig = document.getElementById('sig');
  const sctx = sig.getContext('2d', { willReadFrequently: true });
  let strokes = [];
  let current = null;
  let sigDirty = false;

  function resizeSig() {
    const r = sig.getBoundingClientRect();
    const dpr = Math.min(window.devicePixelRatio || 1, 2);
    sig.width = Math.floor(r.width * dpr);
    sig.height = Math.floor(r.height * dpr);
    sctx.setTransform(1, 0, 0, 1, 0, 0);
    sctx.scale(dpr, dpr);
    sctx.fillStyle = '#fff';
    sctx.fillRect(0, 0, r.width, r.height);
    redraw();
  }

  function redraw() {
    sctx.clearRect(0, 0, sig.width, sig.height);
    sctx.fillStyle = '#fff';
    sctx.fillRect(0, 0, sig.width, sig.height);
    sctx.strokeStyle = '#000';
    sctx.lineWidth = 2;
    sctx.lineCap = 'round';
    sctx.lineJoin = 'round';
    strokes.forEach(stroke => {
      sctx.beginPath();
      stroke.forEach((p, i) => {
        if (i === 0) sctx.moveTo(p.x, p.y);
        else sctx.lineTo(p.x, p.y);
      });
      sctx.stroke();
    });
    if (current) {
      sctx.beginPath();
      current.forEach((p, i) => {
        if (i === 0) sctx.moveTo(p.x, p.y);
        else sctx.lineTo(p.x, p.y);
      });
      sctx.stroke();
    }
  }

  sig.addEventListener('pointerdown', e => {
    const rect = sig.getBoundingClientRect();
    const x = (e.clientX - rect.left) * (sig.width / rect.width);
    const y = (e.clientY - rect.top) * (sig.height / rect.height);
    current = [{ x, y }];
    sigDirty = true;
  });

  sig.addEventListener('pointermove', e => {
    if (!current) return;
    const rect = sig.getBoundingClientRect();
    const x = (e.clientX - rect.left) * (sig.width / rect.width);
    const y = (e.clientY - rect.top) * (sig.height / rect.height);
    current.push({ x, y });
    redraw();
  });

  ['pointerup', 'pointercancel'].forEach(ev => {
    sig.addEventListener(ev, () => {
      if (current) {
        strokes.push(current);
        current = null;
        redraw();
      }
    });
  });

  window.addEventListener('resize', resizeSig);
  resizeSig();

  document.getElementById('sigUndo').onclick = () => {
    if (strokes.length) strokes.pop();
    redraw();
  };
  document.getElementById('sigClear').onclick = () => {
    strokes = [];
    current = null;
    sigDirty = false;
    redraw();
  };
  document.getElementById('sigSave').onclick = () => {
    if (!sigDirty || (strokes.length === 0 && !current)) {
      alert('NupieÅ¡kite paraÅ¡Ä….');
      return;
    }
    const img = sig.toDataURL('image/png');
    claim.masterAttachments = (claim.masterAttachments || []).concat([
      { name: `parasas-${Date.now()}.png`, dataUrl: img, type: 'image' }
    ]);
    addHistory('PridÄ—tas kliento paraÅ¡as');
    saveClaim();
    renderGallery();
    toast('ParaÅ¡as pridÄ—tas');
    updateCompleteButton();
  };

  // --- UÅ½BAIGIMO LOGIKA ---
  const completeBtn = document.getElementById('completeBtn');
  const completeReq = document.getElementById('completeReq');

  function hasSignature() {
    return (claim.masterAttachments || []).some(a =>
      /paras(as|a)|paraÅ¡as/i.test(a.name || '') ||
      /image\/png/.test(a.dataUrl || '')
    );
  }

  function hasAnyEvidence() {
    return (claim.masterAttachments || []).some(a => ['image','video','pdf'].includes(a.type));
  }

  function updateCompleteButton() {
    const ok = hasSignature() && hasAnyEvidence();
    completeBtn.disabled = !ok;
    completeReq.textContent = ok ? 'ParuoÅ¡ta uÅ¾baigti' : 'Reikia: â‰¥1 nuotraukos ir paraÅ¡o';
  }

  updateCompleteButton();

  completeBtn.addEventListener('click', () => {
    if (!hasSignature()) return alert('PridÄ—kite kliento paraÅ¡Ä….');
    if (!hasAnyEvidence()) return alert('PridÄ—kite bent vienÄ… nuotraukÄ….');
    claim.status = 'UÅ¾baigta';
    addHistory('Darbas paÅ¾ymÄ—tas kaip atliktas');
    saveClaim();
    toast('âœ… PaÅ¾ymÄ—ta: UÅ¾baigta');
  });

  // --- GYVIEJI DUOMENYS ---
  renderGallery();
  drawHistory();
}

// --- PAGALBINÄ–S FUNKCIJOS ---
async function fileToDataUrl(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve({ name: file.name, dataUrl: reader.result, type: 'image' });
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function compressImage(file) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const MAX_WIDTH = 1600;
      const ratio = MAX_WIDTH / img.width;
      canvas.width = MAX_WIDTH;
      canvas.height = img.height * ratio;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(resolve, 'image/jpeg', 0.9);
    };
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

/* share helper */
function copyLink(id){
  const url = location.origin + location.pathname + '?id=' + id;
  if (navigator.share) { 
    navigator.share({title:'UÅ¾duotis #'+id, url}).catch(()=>{}); 
    return; 
  }
  navigator.clipboard?.writeText(url);
  toast('Nuoroda nukopijuota');
}

/* logout */
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('currentUser');
  alert('Atsijungta');
});

/* tiny toast */
function toast(msg){
  const t=document.createElement('div');
  t.textContent = msg;
  t.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:10px;z-index:9999;';
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

</script>
</body>
</html>

